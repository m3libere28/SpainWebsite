<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Valencia Adventure (Mobile)</title>
    <!-- Favicon (Orange Slice) -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><path fill='%23FFA500' d='M50 10 A40 40 0 0 1 50 90 A40 40 0 0 1 50 10 Z' /><path fill='%23FFC966' d='M50 15 A35 35 0 0 1 50 85 A35 35 0 0 1 50 15 Z'/><path stroke='%23FFF' stroke-width='3' fill='none' d='M50 15 V 85 M20 50 H 80 M29.2 29.2 L 70.8 70.8 M29.2 70.8 L 70.8 29.2'/><circle cx='50' cy='50' r='7' fill='%23FFF'/></svg>">

    <!-- Core CSS Dependencies -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Plugin CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@splidejs/splide@4.1.4/dist/css/splide.min.css">
    <!-- GSAP for Animations -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/ScrollTrigger.min.js"></script>
    <!-- Tailwind Config -->
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        display: ['Poppins', 'sans-serif'],
                    },
                    colors: { // Keeping colors consistent
                        primary: { 50: '#F0F7FF', 100: '#E0EFFF', 200: '#B8DBFF', 300: '#8AC2FF', 400: '#5CA9FF', 500: '#2E90FF', 600: '#0073FF', 700: '#0059CC', 800: '#004299', 900: '#002B66' },
                        accent: { 50: '#FFF7E6', 100: '#FFE9BF', 200: '#FFD580', 300: '#FFC140', 400: '#FFAD00', 500: '#FF9900', 600: '#CC7A00', 700: '#995C00', 800: '#663D00', 900: '#331F00' },
                        vlcOrange: '#FFA500',
                    },
                    keyframes: { // Keeping animations for potential use (loader etc)
                        float: { '0%, 100%': { transform: 'translateY(0)' }, '50%': { transform: 'translateY(-8px)' } }, // Reduced float
                        pulseGlow: { '0%, 100%': { opacity: '1', }, '50%': { opacity: '0.8', } }, // Simplified glow
                        fadeIn: { 'from': { opacity: '0' }, 'to': { opacity: '1' } },
                        fadeOut: { 'to': { opacity: '0', visibility: 'hidden' } },
                        highlight: { '0%': { backgroundColor: 'rgba(var(--accent-rgb), 0.3)' }, '100%': { backgroundColor: 'transparent' } },
                    },
                    animation: {
                        float: 'float 3.5s ease-in-out infinite',
                        pulseGlow: 'pulseGlow 2.8s ease-in-out infinite',
                        fadeIn: 'fadeIn 0.5s ease-out forwards',
                        fadeOut: 'fadeOut 0.5s ease-out forwards',
                        highlight: 'highlight 1s ease-out',
                    },
                    boxShadow: { // Simplified shadows
                        'card': '0 2px 8px rgba(0, 0, 0, 0.08)',
                        'card-hover': '0 4px 12px rgba(0, 0, 0, 0.1)', // Subtle hover
                        'inner-soft': 'inset 0 1px 3px rgba(0,0,0,0.06)',
                        'top': '0 -2px 10px rgba(0, 0, 0, 0.05)', // For bottom nav
                    }
                }
            }
        }
    </script>
     <!-- Custom Mobile Styles -->
    <style>
        :root {
            --primary: #2E90FF;
            --primary-rgb: 46, 144, 255;
            --accent: #FF9900;
            --accent-rgb: 255, 153, 0;
        }
        html { scroll-behavior: smooth; }
        body {
            font-family: 'Inter', sans-serif;
            @apply bg-gray-100 dark:bg-gray-900 text-gray-800 dark:text-gray-200 min-h-screen transition-colors duration-300;
            padding-bottom: 70px; /* Space for bottom nav */
            overflow-x: hidden;
            -webkit-tap-highlight-color: transparent; /* Remove tap highlight */
        }
        h1, h2, h3, h4 { font-family: 'Poppins', sans-serif; @apply font-semibold; }

        /* Cards */
        .card { @apply bg-white dark:bg-gray-800 rounded-lg shadow-card overflow-hidden mb-6 transition-colors duration-300; opacity: 0; transform: translateY(15px); }
        .card:hover { transform: translateY(-3px); @apply shadow-card-hover; } /* Subtle hover */

        /* Forms */
        .form-input, .form-select, .form-textarea { @apply block w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 focus:ring-1 focus:ring-primary-500 focus:border-primary-500 transition duration-150 ease-in-out text-sm shadow-sm; }
        label { @apply block text-xs font-medium text-gray-600 dark:text-gray-300 mb-1; }

        /* Buttons */
        .btn { @apply inline-flex items-center justify-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-offset-2 transition-all duration-150 ease-in-out transform active:scale-[0.96]; }
        .btn-primary { @apply btn text-white bg-primary-600 hover:bg-primary-700 focus:ring-primary-500; }
        .btn-secondary { @apply btn text-gray-700 dark:text-gray-200 bg-white dark:bg-gray-700 border-gray-300 dark:border-gray-600 hover:bg-gray-50 dark:hover:bg-gray-600 focus:ring-primary-500; }
        .btn-accent { @apply btn text-white bg-accent-500 hover:bg-accent-600 focus:ring-accent-400; }
        .btn-sm { @apply px-3 py-1.5 text-xs; }
        .btn-icon { @apply p-1 h-7 w-7 flex items-center justify-center text-xs rounded transition-colors duration-150 hover:bg-gray-100 dark:hover:bg-gray-700; }

        /* Simple Scrollbar for specific lists */
        .thin-scrollbar { scrollbar-width: thin; scrollbar-color: var(--primary) transparent; }
        .thin-scrollbar::-webkit-scrollbar { width: 5px; }
        .thin-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .thin-scrollbar::-webkit-scrollbar-thumb { @apply bg-gray-300 dark:bg-gray-600 rounded; }

        /* GSAP reveal base */
        .gsap-reveal { opacity: 0; transform: translateY(15px); }
        .gsap-reveal-fade { opacity: 0; }
        [data-gsap-stagger] > * { opacity: 0; transform: translateY(10px); }

        /* Loader */
        #loader.fade-out { animation: fadeOut 0.5s forwards; }

        /* Mobile Modal Styling */
        .modal { @apply fixed inset-0 z-[999] flex items-center justify-center p-3 bg-black/70 backdrop-blur-sm transition-opacity duration-300 ease-out; opacity: 0; pointer-events: none; }
        .modal.open { opacity: 1; pointer-events: auto; }
        .modal-content { @apply bg-white dark:bg-gray-800 rounded-lg shadow-xl max-w-full w-full max-h-[85vh] overflow-y-auto p-5 relative transition-all duration-300 ease-out scale-95 opacity-0 outline-none; }
        .modal.open .modal-content { transform: scale(1); opacity: 1; }
        .modal-close { @apply absolute top-2 right-2 text-gray-500 hover:text-gray-800 dark:text-gray-400 dark:hover:text-white text-2xl leading-none cursor-pointer transition-colors duration-150 z-10 rounded-full bg-white/40 dark:bg-gray-700/40 hover:bg-gray-100 dark:hover:bg-gray-600 w-8 h-8 flex items-center justify-center; }
        .modal-close:focus { @apply ring-1 ring-primary-500 outline-none; }
        .modal-image { @apply w-full h-40 object-cover rounded-md mb-4 shadow bg-gray-200 dark:bg-gray-700; }
        .modal-body { @apply space-y-3 text-sm leading-relaxed; }
        .modal-body dt { @apply font-semibold text-gray-800 dark:text-gray-100 w-24 inline-block flex-shrink-0 mr-1; }
        .modal-body dd { @apply inline text-gray-600 dark:text-gray-300; }
        .modal-body .detail-item { @apply flex items-start mb-1; }
        .modal-body ul { @apply list-disc list-inside space-y-1 pl-1 text-gray-600 dark:text-gray-300; }
        .modal-actions { @apply mt-6 pt-4 border-t dark:border-gray-600 text-center space-x-2; }
        .modal-content::-webkit-scrollbar { width: 5px; }
        .modal-content::-webkit-scrollbar-thumb { @apply bg-gray-300 dark:bg-gray-600 rounded; }

        /* Bottom Navigation */
        #bottom-nav { @apply fixed bottom-0 left-0 right-0 z-[500] h-[60px] bg-white dark:bg-gray-800 border-t border-gray-200 dark:border-gray-700 shadow-top flex items-center justify-around; }
        .bottom-nav-item { @apply flex flex-col items-center justify-center text-gray-500 dark:text-gray-400 text-xs px-2 pt-1 pb-0.5 transition-colors duration-150; flex-grow: 1; flex-basis: 0; }
        .bottom-nav-item i { @apply text-xl mb-0.5; }
        .bottom-nav-item.active { @apply text-primary-600 dark:text-primary-400 font-medium; }
        .bottom-nav-item:active { transform: scale(0.95); } /* Tap feedback */

        /* Simplified Timeline */
        .timeline-wrapper { position: relative; padding-left: 20px; } /* Space for line */
        .timeline-line { @apply absolute left-[6px] top-4 bottom-4 w-[3px] bg-primary-200 dark:bg-primary-700/50 rounded-full; }
        .timeline-item { @apply relative mb-8 pl-6; } /* Space from line */
        .timeline-dot { @apply absolute left-[-1px] top-4 w-4 h-4 bg-primary-500 rounded-full border-2 border-white dark:border-gray-800 z-10 flex items-center justify-center text-[9px] text-white shadow; }
        .timeline-dot.future { @apply bg-gray-400 dark:bg-gray-500; }
        .timeline-dot.final { @apply ring-2 ring-accent-500/30 bg-accent-500 shadow-lg scale-110; }
        .timeline-header { @apply cursor-pointer p-1 rounded mb-1; }
        .timeline-header h3 { @apply text-base font-semibold mb-0.5; }
        .timeline-header p { @apply text-xs text-gray-500 dark:text-gray-400; }
        .timeline-header .indicator { @apply ml-1 text-xs opacity-70 transition-transform duration-300 inline-block; }
        .timeline-header .indicator.rotate-180 { @apply transform rotate-180; }
        .timeline-content { @apply p-4 bg-gray-50 dark:bg-gray-700/60 rounded-lg shadow-sm transition-colors duration-300; }
        .timeline-content.future { @apply bg-gray-50 dark:bg-gray-700 opacity-90; }
        .timeline-content.final { @apply border-l-2 border-accent-500 bg-accent-50 dark:bg-accent-900/20; }
        .timeline-details { @apply mt-3 pt-3 border-t border-gray-200 dark:border-gray-600 overflow-hidden transition-all duration-500 ease-in-out max-h-0 opacity-0; }
        .timeline-details.expanded { @apply max-h-[500px] opacity-100; }
        .timeline-details ul { @apply list-none pl-0 space-y-1.5; }
        .timeline-details li { @apply flex items-start text-xs opacity-0; }
        .timeline-details.expanded li { animation: fadeIn 0.4s ease-out forwards; }
        .timeline-details li i { @apply mr-2 mt-0.5 w-3 text-center text-primary-500 dark:text-primary-400 flex-shrink-0; }
        .timeline-notes-container { @apply mt-3 border-t border-gray-200 dark:border-gray-600 pt-2 space-y-1.5; }
        .timeline-note { @apply text-xs p-2 bg-white dark:bg-gray-600 rounded shadow-sm transition-opacity duration-300 relative; opacity: 0; }
        .timeline-note p { @apply pr-4; } /* Space for delete button */
        .timeline-note button { @apply absolute top-1 right-1; }
        .add-note-form { @apply mt-1 space-y-1; }
        .add-note-form textarea { @apply text-xs; }

        /* School cards specific mobile style */
        .school-card .card-image-zoom { @apply transition-transform duration-200; }
        .school-card:hover .card-image-zoom { transform: scale(1.05); } /* Less zoom */
        .school-card .p-6 { @apply p-4; } /* Smaller padding */
        .school-card h3 { @apply text-base; }

        .public-school-card { @apply text-xs; }
        .public-school-card img { @apply h-32; }
        .public-school-card .p-5 { @apply p-3; }
        .public-school-card h3 { @apply text-sm; }

        /* Splide adjustments */
        .splide__slide { @apply p-1; } /* Less padding around slides */
        .splide__pagination { @apply bottom-[-20px]; } /* Move pagination down */
        .splide__arrow { display: none; } /* Hide arrows on mobile by default */
    </style>
</head>
<body class="antialiased">

    <!-- Loading Screen -->
    <div id="loader" class="fixed inset-0 z-[1000] flex flex-col items-center justify-center bg-gradient-to-br from-primary-500 to-accent-500 text-white">
        <div class="text-center gsap-reveal-fade">
            <h1 class="text-3xl font-bold mb-6 animation-pulseGlow">Valencia Adventure</h1>
            <i class="fas fa-plane-departure text-6xl text-white animation-float"></i>
            <p class="mt-5 text-base">Loading...</p>
        </div>
    </div>

    <!-- Header -->
    <header class="sticky top-0 z-[400] bg-white dark:bg-gray-800 shadow-md px-4 py-3 flex justify-between items-center">
        <div class="flex items-center">
             <svg class="h-7 w-7 text-vlcOrange mr-2" viewBox="0 0 100 100" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
                 <path d="M50 10 A40 40 0 0 1 50 90 A40 40 0 0 1 50 10 Z" />
                 <path fill="#FFC966" d="M50 15 A35 35 0 0 1 50 85 A35 35 0 0 1 50 15 Z"/>
                 <path stroke="#FFF" stroke-width="5" fill="none" d="M50 15 V 85 M20 50 H 80 M29.2 29.2 L 70.8 70.8 M29.2 70.8 L 70.8 29.2"/>
                 <circle cx="50" cy="50" r="8" fill="#FFF"/>
            </svg>
            <span class="text-lg font-bold font-display text-primary-700 dark:text-primary-300 tracking-tight">Valencia<span class="font-normal text-accent-600 dark:text-accent-400">Bound</span></span>
        </div>
         <button id="theme-toggle-mobile" aria-label="Toggle Dark Mode" class="p-2 rounded-full text-gray-600 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors duration-150 focus:outline-none focus:ring-1 focus:ring-primary-500">
             <i class="fas fa-sun text-lg"></i> <!-- Icon updated by JS -->
         </button>
    </header>

    <!-- Main Content -->
    <main class="p-4"> <!-- Added padding to main content area -->

        <!-- Hero Section -->
        <section id="home" class="relative text-center mb-8 overflow-hidden rounded-lg shadow-lg min-h-[50vh] flex flex-col justify-center items-center p-6 bg-gradient-to-br from-primary-500 to-accent-400 text-white">
             <div class="absolute inset-0 z-0 opacity-20">
                 <img src="https://images.unsplash.com/photo-1578881908913-5790755ced30?q=70&w=800&auto=format&fit=crop"
                      alt="" class="object-cover w-full h-full">
             </div>
             <div class="relative z-10">
                <h1 class="text-3xl font-bold font-display mb-4 drop-shadow-md gsap-reveal">Our Valencia Adventure</h1>
                <p class="text-base mb-6 opacity-90 drop-shadow gsap-reveal" data-delay="0.2">Counting down...</p>

                <!-- Countdown Timer -->
                <div class="grid grid-cols-4 gap-2 max-w-xs mx-auto gsap-reveal" data-delay="0.4">
                    <div class="countdown-unit bg-white/20 dark:bg-black/30 p-2 rounded-md shadow backdrop-blur-sm">
                        <div class="text-2xl font-bold font-display" id="days">--</div>
                        <div class="text-[10px] uppercase tracking-wider opacity-80">Days</div>
                    </div>
                    <div class="countdown-unit bg-white/20 dark:bg-black/30 p-2 rounded-md shadow backdrop-blur-sm">
                        <div class="text-2xl font-bold font-display" id="hours">--</div>
                        <div class="text-[10px] uppercase tracking-wider opacity-80">Hours</div>
                    </div>
                    <div class="countdown-unit bg-white/20 dark:bg-black/30 p-2 rounded-md shadow backdrop-blur-sm">
                        <div class="text-2xl font-bold font-display" id="minutes">--</div>
                        <div class="text-[10px] uppercase tracking-wider opacity-80">Mins</div>
                    </div>
                    <div class="countdown-unit bg-white/20 dark:bg-black/30 p-2 rounded-md shadow backdrop-blur-sm">
                        <div class="text-2xl font-bold font-display" id="seconds">--</div>
                        <div class="text-[10px] uppercase tracking-wider opacity-80">Secs</div>
                    </div>
                </div>
            </div>
        </section> <!-- End Hero (#home) -->

        <!-- Rentals Section (Simplified: Tracked Apartments Only) -->
        <section id="rentals" class="mb-8 gsap-reveal">
            <h2 class="text-xl font-bold mb-4">Tracked Apartments</h2>
            <div id="apartment-tracker" class="card p-4">
                <form id="apartment-form" class="space-y-3 mb-6">
                    <div>
                        <label for="apt-location">Location / Ref</label>
                        <input type="text" id="apt-location" class="form-input" required placeholder="e.g., Russafa Ref #123">
                    </div>
                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label for="apt-size">Size (m²)</label>
                            <input type="number" id="apt-size" class="form-input" placeholder="e.g., 85">
                        </div>
                        <div>
                            <label for="apt-price">Price (€/mo)</label>
                            <input type="number" id="apt-price" class="form-input" required placeholder="e.g., 1200">
                        </div>
                    </div>
                    <div>
                        <label for="apt-link">Listing URL</label>
                        <input type="url" id="apt-link" class="form-input" placeholder="https://...">
                    </div>
                    <div>
                        <label for="apt-notes">Notes / Status</label>
                        <textarea id="apt-notes" rows="2" class="form-textarea" placeholder="Pros, cons..."></textarea>
                    </div>
                    <button type="submit" class="btn-accent w-full">
                        <i class="fas fa-plus mr-1.5 text-xs"></i>Add Apartment
                    </button>
                </form>

                <h4 class="text-base font-semibold mb-3 mt-6 border-t dark:border-gray-700 pt-4">Saved Listings</h4>
                <div class="table-wrapper max-h-[300px] overflow-y-auto thin-scrollbar">
                    <table class="data-table text-xs">
                        <thead>
                            <tr>
                                <th class="px-2 py-2">Location</th>
                                <th class="px-2 py-2">Price</th>
                                <th class="px-2 py-2">Size</th>
                                <th class="px-2 py-2">Link</th>
                                <th class="px-2 py-2">Notes</th>
                                <th class="px-2 py-2">Del</th>
                            </tr>
                        </thead>
                        <tbody id="apartment-table-body">
                            <tr><td colspan="6" class="text-center py-3 text-gray-500 dark:text-gray-400">No apartments tracked.</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </section> <!-- End Simplified Rentals -->

        <!-- Timeline Section (Simplified Vertical Layout) -->
        <section id="timeline" class="mb-8 gsap-reveal">
            <h2 class="text-xl font-bold mb-4">Journey Timeline</h2>
            <div class="timeline-wrapper">
                <div class="timeline-line gsap-reveal"></div>
                <div class="space-y-6" id="timeline-items-container">
                    <!-- Items will be populated/managed by JS, structure below is just for reference -->
                    <!-- Example Structure (JS will generate this) -->
                    <div class="timeline-item gsap-reveal" data-timeline-id="prep-research">
                         <div class="timeline-dot"><i class="fas fa-clipboard-check"></i></div>
                         <div class="timeline-header" onclick="toggleTimelineDetails('prep-research')">
                            <h3>✅ Prepping & Research</h3>
                            <p>March–May 2025<i class="fas fa-chevron-down indicator"></i></p>
                         </div>
                         <div class="timeline-content">
                            <p class="mb-3 italic text-xs text-gray-600 dark:text-gray-400">Laying the groundwork...</p>
                            <div class="timeline-details" id="details-prep-research"><ul><li>Item 1</li><li>Item 2</li></ul></div>
                            <div class="timeline-notes-container"><div class="notes-display"></div><button onclick="toggleNoteForm('prep-research')" class="btn-secondary btn-sm"><i class="fas fa-plus mr-1"></i> Note</button><form class="add-note-form hidden">...</form></div>
                         </div>
                    </div>
                     <div class="timeline-item gsap-reveal" data-timeline-id="legal-logistics">
                         <div class="timeline-dot"><i class="fas fa-passport"></i></div>
                         <div class="timeline-header" onclick="toggleTimelineDetails('legal-logistics')">
                            <h3>🛂 Legal & Logistics</h3>
                            <p>June–August 2025<i class="fas fa-chevron-down indicator"></i></p>
                         </div>
                         <div class="timeline-content">
                             <p class="mb-3 italic text-xs text-gray-600 dark:text-gray-400">Navigating paperwork...</p>
                            <div class="timeline-details" id="details-legal-logistics"><ul><li>Item 1</li></ul></div>
                            <div class="timeline-notes-container"><div class="notes-display"></div><button onclick="toggleNoteForm('legal-logistics')" class="btn-secondary btn-sm"><i class="fas fa-plus mr-1"></i> Note</button><form class="add-note-form hidden">...</form></div>
                         </div>
                    </div>
                     <!-- Add other timeline items similarly -->
                     <!-- Final Item -->
                     <div class="timeline-item gsap-reveal" data-timeline-id="move-to-spain">
                         <div class="timeline-dot final"><i class="fas fa-flag"></i></div>
                         <div class="timeline-header" onclick="toggleTimelineDetails('move-to-spain')">
                            <h3 class="text-accent-600 dark:text-accent-400">✈️ Move to Spain!</h3>
                            <p class="font-bold" id="move-date-display">July 2026<i class="fas fa-chevron-down indicator"></i></p>
                         </div>
                         <div class="timeline-content final">
                             <p class="mb-3 font-semibold text-sm">¡Hola Valencia! 🇪🇸❤️</p>
                            <div class="timeline-details" id="details-move-to-spain"><ul><li>Item 1</li></ul></div>
                            <div class="timeline-notes-container"><div class="notes-display"></div><button onclick="toggleNoteForm('move-to-spain')" class="btn-secondary btn-sm"><i class="fas fa-plus mr-1"></i> Note</button><form class="add-note-form hidden">...</form></div>
                         </div>
                    </div>
                </div> <!-- End Timeline Items Container -->
            </div> <!-- End Timeline Wrapper -->
        </section> <!-- End Timeline Section -->

        <!-- Weather Section -->
        <section id="weather" class="mb-8 gsap-reveal">
            <h2 class="text-xl font-bold mb-4">Weather Forecast</h2>
            <div class="grid grid-cols-2 gap-3" data-gsap-stagger>
                <!-- Placeholder Weather Cards -->
                <div class="weather-card card p-3 text-center text-sm">
                    <div class="font-semibold mb-1">Today</div>
                    <i class="fas fa-sun text-4xl text-yellow-500 my-2"></i>
                    <div class="text-xl font-bold">28°C</div>
                    <div class="text-xs text-gray-600 dark:text-gray-400">Sunny</div>
                </div>
                <div class="weather-card card p-3 text-center text-sm">
                    <div class="font-semibold mb-1">Tomorrow</div>
                    <i class="fas fa-cloud-sun text-4xl text-sky-400 my-2"></i>
                    <div class="text-xl font-bold">26°C</div>
                    <div class="text-xs text-gray-600 dark:text-gray-400">Partly Cloudy</div>
                </div>
                <div class="weather-card card p-3 text-center text-sm">
                    <div class="font-semibold mb-1">Thursday</div>
                    <i class="fas fa-cloud text-4xl text-gray-500 my-2"></i>
                    <div class="text-xl font-bold">24°C</div>
                    <div class="text-xs text-gray-600 dark:text-gray-400">Cloudy</div>
                </div>
                <div class="weather-card card p-3 text-center text-sm">
                    <div class="font-semibold mb-1">Friday</div>
                    <i class="fas fa-cloud-showers-heavy text-4xl text-blue-400 my-2"></i>
                    <div class="text-xl font-bold">23°C</div>
                    <div class="text-xs text-gray-600 dark:text-gray-400">Showers</div>
                </div>
            </div>
            <p class="text-center text-[10px] text-gray-500 dark:text-gray-400 mt-3">Illustrative data.</p>
        </section> <!-- End Weather Section -->

        <!-- International Schools Section -->
        <section id="schools" class="mb-8 gsap-reveal">
            <h2 class="text-xl font-bold mb-4">International Schools</h2>
            <div id="international-schools-splide" class="splide" aria-label="International Schools Carousel">
                <div class="splide__track">
                    <ul class="splide__list">
                         <li class="splide__slide p-1"> <div class="h-full card items-center justify-center text-gray-400 p-4"><i class="fas fa-spinner fa-spin text-lg"></i></div> </li>
                    </ul>
                </div>
            </div>
        </section> <!-- End International Schools Section -->

        <!-- Public Schools Section -->
        <section id="public-schools" class="mb-8 gsap-reveal">
            <h2 class="text-xl font-bold mb-4">Public & Concertado Schools</h2>
            <div id="public-school-grid" class="grid grid-cols-2 gap-3" data-gsap-stagger>
                 <div class="text-center text-gray-500 dark:text-gray-400 col-span-2 py-6">
                     <i class="fas fa-spinner fa-spin text-xl mb-2"></i>
                     <p class="text-sm">Loading schools...</p>
                 </div>
            </div>
        </section> <!-- End Public Schools Section -->

        <!-- Planning Section (Stacked) -->
        <section id="planning" class="mb-8 gsap-reveal">
            <h2 class="text-xl font-bold mb-4">Planning Central</h2>

            <!-- Budget Tracker -->
            <div id="budget" class="card p-4 mb-6">
                <h3 class="text-lg font-semibold mb-4 flex items-center"><i class="fas fa-chart-pie mr-2 text-primary-500"></i>Budget</h3>
                <div class="mb-4">
                    <canvas id="budgetChart" class="max-h-48 mx-auto"></canvas>
                    <p class="text-center text-xs mt-2 text-gray-600 dark:text-gray-400">Total Spent: <strong id="total-spent" class="text-sm text-gray-800 dark:text-gray-200">€0.00</strong></p>
                </div>
                <form id="budget-form" class="space-y-3 mb-4">
                     <div class="grid grid-cols-2 gap-3">
                         <div><label for="budget-amount">Amount (€)</label><input type="number" id="budget-amount" class="form-input" required placeholder="55.75"></div>
                         <div><label for="budget-category">Category</label><select id="budget-category" class="form-select"><option value="housing">Housing</option><option value="food">Food</option><option value="transport">Transport</option><option value="utilities">Utilities</option><option value="leisure">Leisure</option><option value="fees">Fees</option><option value="shopping">Shopping</option><option value="kids">Kids</option><option value="misc">Misc</option></select></div>
                     </div>
                     <div><label for="budget-description">Description</label><input type="text" id="budget-description" class="form-input" required placeholder="Mercadona trip"></div>
                     <div><label for="budget-date">Date</label><input type="date" id="budget-date" class="form-input" value=""></div>
                    <button type="submit" class="btn-primary w-full"><i class="fas fa-plus mr-1.5 text-xs"></i>Add Expense</button>
                </form>
                 <h4 class="text-base font-semibold mb-2 mt-4 pt-3 border-t dark:border-gray-700">Recent Expenses</h4>
                 <div class="space-y-1.5 max-h-48 overflow-y-auto thin-scrollbar pr-1" id="budget-transactions">
                     <p class="text-center text-xs text-gray-500 dark:text-gray-400 py-4">No expenses yet.</p>
                 </div>
            </div>

            <!-- Todo List -->
             <div id="todo" class="card p-4 mb-6">
                <h3 class="text-lg font-semibold mb-4 flex items-center"><i class="fas fa-list-check mr-2 text-accent-500"></i>To-Do List</h3>
                <form id="todo-form" class="space-y-3 mb-4">
                     <div><label for="todo-task">New Task</label><input type="text" id="todo-task" class="form-input" required placeholder="Research NIE process"></div>
                     <div class="grid grid-cols-2 gap-3">
                         <div><label for="todo-date">Due Date</label><input type="date" id="todo-date" class="form-input"></div>
                         <div><label for="todo-priority">Priority</label><select id="todo-priority" class="form-select"><option value="low">Low</option><option value="medium" selected>Medium</option><option value="high">High</option></select></div>
                     </div>
                    <button type="submit" class="btn-accent w-full"><i class="fas fa-plus mr-1.5 text-xs"></i>Add Task</button>
                </form>
                 <div class="space-y-2 max-h-60 overflow-y-auto thin-scrollbar pr-1" id="todo-list">
                    <p class="text-center text-xs text-gray-500 dark:text-gray-400 py-4">Task list is clear!</p>
                </div>
            </div>

            <!-- Journal -->
            <div id="journal" class="card p-4">
                 <h3 class="text-lg font-semibold mb-4 flex items-center"><i class="fas fa-book-open mr-2 text-green-500"></i>Journal</h3>
                <form id="journal-form" class="space-y-3 mb-4">
                     <div><label for="journal-title">Entry Title</label><input type="text" id="journal-title" class="form-input" required placeholder="First Spanish Lesson!"></div>
                     <div><label for="journal-content">Thoughts / Notes</label><textarea id="journal-content" rows="3" class="form-textarea" required placeholder="How are things going?..."></textarea></div>
                    <div><label for="journal-mood">Mood</label><select id="journal-mood" class="form-select"><option value="excited">😊 Excited</option><option value="happy">😄 Happy</option><option value="neutral">😐 Neutral</option><option value="anxious">😟 Anxious</option><option value="stressed">😫 Stressed</option><option value="thoughtful">🤔 Thoughtful</option><option value="celebrating">🎉 Celebrating</option></select></div>
                     <button type="submit" class="btn-primary w-full bg-green-600 hover:bg-green-700 focus:ring-green-500"><i class="fas fa-feather-alt mr-1.5 text-xs"></i>Save Entry</button>
                </form>
                 <div class="space-y-3 max-h-60 overflow-y-auto thin-scrollbar pr-1" id="journal-entries">
                    <p class="text-center text-xs text-gray-500 dark:text-gray-400 py-4">No journal entries yet.</p>
                 </div>
            </div>
        </section> <!-- End Planning Section -->

        <!-- More Tools Section (Stacked) -->
        <section id="more-tools" class="mb-8 gsap-reveal">
             <h2 class="text-xl font-bold mb-4">More Tools</h2>

             <!-- Bucket List Card -->
             <div id="bucket-list" class="card p-4 mb-6">
                <h3 class="text-lg font-semibold mb-4 flex items-center"><i class="fas fa-stream mr-2 text-purple-500"></i>Bucket List</h3>
                <form id="bucket-form" class="space-y-3 mb-4">
                    <div><label for="bucket-item">New Item</label><input type="text" id="bucket-item" class="form-input" required placeholder="Visit City of Arts & Sciences"></div>
                    <div class="grid grid-cols-2 gap-3">
                        <div><label for="bucket-category">Category</label><select id="bucket-category" class="form-select"><option value="food">🍽️ Food</option><option value="culture">🏛️ Culture</option><option value="adventure">🚴 Adventure</option><option value="daytrip">🚗 Day Trip</option><option value="sightseeing">📍 Sights</option><option value="event">🎉 Event</option><option value="learning">📚 Learning</option><option value="relaxation">🏖️ Relax</option></select></div>
                        <div><label for="bucket-date">Target</label><input type="month" id="bucket-date" class="form-input"></div>
                    </div>
                    <button type="submit" class="btn-primary w-full bg-purple-600 hover:bg-purple-700 focus:ring-purple-500"><i class="fas fa-plus mr-1.5 text-xs"></i>Add to List</button>
                </form>
                <div class="space-y-2 max-h-60 overflow-y-auto thin-scrollbar pr-1" id="bucket-list-items">
                     <p class="text-center text-xs text-gray-500 dark:text-gray-400 py-4">Add to your wish list!</p>
                </div>
            </div>

            <!-- Resources Card -->
            <div id="resources" class="card p-4 mb-6">
                <h3 class="text-lg font-semibold mb-4 flex items-center"><i class="fas fa-link mr-2 text-teal-500"></i>Resources</h3>
                <form id="resource-form" class="space-y-3 mb-4">
                    <div><label for="resource-title">Link Title</label><input type="text" id="resource-title" class="form-input" required placeholder="Official Empadronamiento Guide"></div>
                    <div><label for="resource-url">URL</label><input type="url" id="resource-url" class="form-input" required placeholder="https://..."></div>
                    <div><label for="resource-category">Category</label><select id="resource-category" class="form-select"><option value="visa">🛂 Visa/NIE</option><option value="housing">🏠 Housing</option><option value="education">🎓 Edu</option><option value="health">❤️ Health</option><option value="transport">🚗 Transport</option><option value="finance">💰 Finance</option><option value="language">🗣️ Lang</option><option value="expat">👥 Expat</option><option value="official">🏛️ Official</option><option value="blog">✍️ Blog</option><option value="other">🔗 Other</option></select></div>
                     <div><label for="resource-description">Description (Opt.)</label><textarea id="resource-description" rows="2" class="form-textarea" placeholder="What is this link about?"></textarea></div>
                     <button type="submit" class="btn-primary w-full bg-teal-600 hover:bg-teal-700 focus:ring-teal-500"><i class="fas fa-plus mr-1.5 text-xs"></i>Add Link</button>
                </form>
                <div class="space-y-2.5 max-h-60 overflow-y-auto thin-scrollbar pr-1" id="resource-list">
                    <p class="text-center text-xs text-gray-500 dark:text-gray-400 py-4">No resources added yet.</p>
                </div>
            </div>

            <!-- Guestbook Card -->
            <div id="guestbook" class="card p-4">
                 <h3 class="text-lg font-semibold mb-4 flex items-center"><i class="fas fa-comments mr-2 text-pink-500"></i>Guestbook</h3>
                 <form id="guestbook-form" class="space-y-3 mb-4">
                     <div><label for="guest-name">Your Name</label><input type="text" id="guest-name" class="form-input" required></div>
                     <div><label for="guest-message">Your Message</label><textarea id="guest-message" rows="3" class="form-textarea" required placeholder="Leave a message..."></textarea></div>
                     <button type="submit" class="btn-primary w-full bg-pink-600 hover:bg-pink-700 focus:ring-pink-500"><i class="fas fa-paper-plane mr-1.5 text-xs"></i>Send Message</button>
                 </form>
                 <div class="space-y-3 max-h-60 overflow-y-auto pr-1 thin-scrollbar border-t dark:border-gray-700 pt-4" id="guestbook-entries">
                    <p class="text-center text-xs text-gray-500 dark:text-gray-400 py-4">No messages yet.</p>
                 </div>
            </div>
        </section> <!-- End More Tools Section -->

    </main> <!-- End Main Content -->

    <!-- Bottom Navigation -->
    <nav id="bottom-nav">
        <a href="#home" class="bottom-nav-item active" data-target-id="home">
            <i class="fas fa-home"></i>
            <span>Home</span>
        </a>
        <a href="#timeline" class="bottom-nav-item" data-target-id="timeline">
            <i class="fas fa-route"></i>
            <span>Timeline</span>
        </a>
         <a href="#planning" class="bottom-nav-item" data-target-id="planning">
             <i class="fas fa-clipboard-list"></i>
            <span>Plan</span>
        </a>
        <a href="#more-tools" class="bottom-nav-item" data-target-id="more-tools">
            <i class="fas fa-toolbox"></i>
            <span>Tools</span>
        </a>
        <a href="#schools" class="bottom-nav-item" data-target-id="schools">
            <i class="fas fa-school"></i>
            <span>Schools</span>
        </a>
    </nav>

    <!-- Detail Modal (Remains the same structure) -->
    <div id="detail-modal" class="modal" onclick="closeDetailModal(event)" tabindex="-1" role="dialog" aria-modal="true" aria-labelledby="modal-title">
        <div class="modal-content" onclick="event.stopPropagation()">
            <button class="modal-close" onclick="closeDetailModal()" aria-label="Close details">×</button>
            <img id="modal-image" src="" alt="" class="modal-image hidden"/>
            <h3 id="modal-title" class="text-xl font-bold mb-3 border-b pb-2 dark:border-gray-600">Details</h3>
            <div id="modal-body" class="modal-body">
                <div class="detail-item"><dt id="modal-info-label1"></dt> <dd id="modal-info-value1"></dd></div>
                <div class="detail-item"><dt id="modal-info-label2"></dt> <dd id="modal-info-value2"></dd></div>
                <div class="detail-item"><dt id="modal-info-label3"></dt> <dd id="modal-info-value3"></dd></div>
                <div class="pt-3">
                    <strong class="font-semibold text-gray-800 dark:text-gray-100 block mb-1">Description:</strong>
                    <p id="modal-description"></p>
                </div>
                <div id="modal-features-container" class="pt-3 hidden">
                    <strong class="font-semibold text-gray-800 dark:text-gray-100 block mb-1">Key Features:</strong>
                    <ul id="modal-features-list"></ul>
                </div>
            </div>
            <div class="modal-actions">
                <a id="modal-website-link" href="#" target="_blank" rel="noopener noreferrer" class="btn-primary btn-sm hidden">Visit Website</a>
                <button onclick="closeDetailModal()" class="btn-secondary btn-sm">Close</button>
            </div>
        </div>
    </div>

    <!-- Core & Plugin Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/@splidejs/splide@4.1.4/dist/js/splide.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- LEAFLET REMOVED -->
    <!-- GSAP loaded in <head> -->

    <!-- Main Application Script (Modified for Mobile) -->
    <script>
        // --- Config & Constants ---
        const MOVE_DATE_STRING = '2026-07-01T00:00:00';
        const MOVE_DATE = new Date(MOVE_DATE_STRING);
        const LOADER_DURATION = 1500; // Slightly faster loader
        const STORAGE_KEY_PREFIX = 'valenciaJourneyMobile_'; // Different key for mobile version
        const DATA_VERSION = 'v1.1'; // Mobile versioning
        const STORAGE_KEY = `${STORAGE_KEY_PREFIX}${DATA_VERSION}`;

        // --- DOM Elements Cache ---
        const $ = (selector) => document.querySelector(selector);
        const $$ = (selector) => document.querySelectorAll(selector);
        const $modal = $('#detail-modal');

        // --- State Variables ---
        let appState = {
            budgetEntries: [], todos: [], journalEntries: [], trackedApartments: [],
            timelineNotes: {}, bucketList: [], resources: [], guestbookEntries: [],
        };
        let budgetChartInstance;
        let internationalSplide;

        // --- Data Definitions (Schools, Resources - same as before) ---
        const internationalSchools = [
             { id: 'intl1', name: 'American School of Valencia', type: 'International', location: 'Puzol', rating: '4.8/5', description: 'Provides an American curriculum leading to the American High School Diploma. Offers the International Baccalaureate (IB) Diploma Programme as well. For ages 2-18.', features: ['American Curriculum', 'IB Diploma Option', 'Ages 2-18', 'Extensive Campus', 'Bus Service'], website: 'https://www.asvalencia.org/en/', image: 'https://images.unsplash.com/photo-1580582932707-520aed937b7b?ixlib=rb-4.0.3&auto=format&fit=crop&w=600&q=75'}, // Smaller image
            { id: 'intl2', name: 'British School of Valencia', type: 'International', location: 'Central Valencia', rating: '4.7/5', description: 'Follows the British National Curriculum, preparing students for IGCSE and A-Level examinations. Caters to students aged 2-18.', features: ['British Curriculum', 'IGCSE / A-Levels', 'Ages 2-18', 'City Center Location'], website: 'https://bsvalencia.com/en/', image: 'https://images.unsplash.com/photo-1594608661623-aa0bd3a69d98?ixlib=rb-4.0.3&auto=format&fit=crop&w=600&q=75' },
            { id: 'intl3', name: 'Caxton College', type: 'International', location: 'Puzol / Sagunto', rating: '4.6/5', description: 'A well-established British school offering the full British curriculum from early years through to A-Levels. Known for strong academics and facilities. Ages 1-18.', features: ['British Curriculum', 'Ages 1-18', 'Boarding Available', 'Wide range of subjects'], website: 'https://www.caxtoncollege.com/en/', image: 'https://images.unsplash.com/photo-1517486808906-6ca8b3f04846?ixlib=rb-4.0.3&auto=format&fit=crop&w=600&q=75'},
            { id: 'intl4', name: 'Lycée Français de Valence', type: 'International', location: 'Paterna', rating: '4.5/5', description: 'Follows the French national education system from Maternelle (preschool) through to Terminale (final year, leading to the Baccalauréat).', features: ['French Curriculum', 'Baccalauréat', 'Trilingual options', 'Part of AEFE network'], website: 'https://lfvalencia.org/', image: 'https://images.unsplash.com/photo-1497633762265-9d179a990aa6?ixlib=rb-4.0.3&auto=format&fit=crop&w=600&q=75' },
             { id: 'intl5', name: 'Global Valencia', type: 'International', location: 'Near Valencia', rating: '4.4/5', description: 'Offers the International Baccalaureate (IB) programmes (PYP, MYP, DP) providing a globally recognized education framework.', features: ['IB Curriculum (PYP, MYP, DP)', 'Inquiry-based Learning', 'Global Perspective'], website: '#', image: 'https://images.unsplash.com/photo-1607499457689-3fd1ac3ffc5d?ixlib=rb-4.0.3&auto=format&fit=crop&w=600&q=75' },
        ];
        const defaultPublicSchools = [ // Use slightly smaller images if needed
            { id: 'ps1', name: 'CEIP Alejandra Soler', type: 'Public', location: 'Russafa', rating: '9.1/10', description: 'Well-regarded public primary school in a popular neighborhood.', features: ['Infantil', 'Primaria', 'Good facilities (Illustrative)'], website: '#', image: 'https://images.unsplash.com/photo-1541339907198-e08756dedf3f?ixlib=rb-4.0.3&auto=format&fit=crop&w=600&q=75' },
            { id: 'ps2', name: 'IES Lluís Vives', type: 'Public', location: 'Central', rating: '8.8/10', description: 'Historic public secondary school (Instituto) near Estació del Nord.', features: ['ESO', 'Bachillerato', 'Strong academic focus (Illustrative)'], website: '#', image: 'https://images.unsplash.com/photo-1591123120675-6f7f1aae4f8b?ixlib=rb-4.0.3&auto=format&fit=crop&w=600&q=75' },
            { id: 'ps3', name: 'Colegio El Pilar', type: 'Concertado', location: 'Eixample', rating: '9.3/10', description: 'Popular semi-private school known for its educational project.', features: ['Infantil', 'Primaria', 'ESO', 'Bachillerato', 'Religious affiliation'], website: '#', image: 'https://images.unsplash.com/photo-1562774053-701939374585?ixlib=rb-4.0.3&auto=format&fit=crop&w=600&q=75' },
            { id: 'ps4', name: 'Colegio Jesús-María', type: 'Concertado', location: 'Extramurs', rating: '8.9/10', description: 'Another well-established Concertado option.', features: ['All levels', 'Focus on values (Illustrative)'], website: '#', image: 'https://images.unsplash.com/photo-1577896851231-70f144b4ecd3?ixlib=rb-4.0.3&auto=format&fit=crop&w=600&q=75'},
            { id: 'ps5', name: 'CEIP Explorador Andrés', type: 'Public', location: 'Patraix', rating: '8.5/10', description: 'Primary school serving the Patraix area.', features: ['Infantil', 'Primaria'], website: '#', image: 'https://images.unsplash.com/photo-1588075592465-5f4fd106a54f?ixlib=rb-4.0.3&auto=format&fit=crop&w=600&q=75'},
            { id: 'ps6', name: 'IES Benlliure', type: 'Public', location: 'Benimaclet', rating: '8.6/10', description: 'Secondary school in the Benimaclet neighborhood.', features: ['ESO', 'Bachillerato'], website: '#', image: 'https://images.unsplash.com/photo-1610484826911-08c3c4cf64d6?ixlib=rb-4.0.3&auto=format&fit=crop&w=600&q=75'},
        ];
        const defaultResources = [ /* Same as before */
            { id: Date.now()+1, title: "Idealista", url: "https://www.idealista.com/en/", category: "housing", description: "Major portal for rentals and sales." },
            { id: Date.now()+2, title: "Fotocasa", url: "https://www.fotocasa.es/en/", category: "housing", description: "Another large property site." },
            { id: Date.now()+3, title: "Expat Forum (Spain)", url: "https://www.expatforum.com/forums/spain-expat-forum/", category: "expat", description: "Community forum for expats." },
            { id: Date.now()+4, title: "Valencia City Hall", url: "https://www.valencia.es/", category: "official", description: "Official city website." },
        ];

        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            console.log("Valencia Adventure Mobile - DOM Loaded");
            initializeBaseUI();
            initializeTheme();
            loadData();
            initializeComponents();
            initializeAnimations(); // Keep animations, they are simple enough
            setupEventListeners();
            hideLoader();
        });

        function initializeBaseUI() {
            // Set current year in footer (if footer exists, though we removed it for bottom nav)
            // Set move date display
            if ($('#move-date-display')) $('#move-date-display').textContent = MOVE_DATE.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
            // Set default date for budget
            const budgetDateInput = $('#budget-date');
            if (budgetDateInput) { try { budgetDateInput.valueAsDate = new Date(); } catch(e){ budgetDateInput.value = new Date().toISOString().split('T')[0]; } }
        }

        function initializeTheme() { // Same as before
             const storedTheme = localStorage.getItem('theme');
             const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
             if (storedTheme === 'dark' || (!storedTheme && prefersDark)) { document.documentElement.classList.add('dark'); }
             else { document.documentElement.classList.remove('dark'); }
             updateThemeIcons();
        }

        function initializeComponents() {
            console.log("Initializing mobile components...");
            renderInternationalSchools();
             if (typeof Splide !== 'undefined' && $('#international-schools-splide')) {
                 initializeSplide(); // Initialize AFTER rendering slides
             }
            // LEAFLET/HEATMAP REMOVED

            renderPublicSchools();
            updateBudgetUI();
            updateTodoList();
            updateJournalEntries();
            updateApartmentTable();
            renderAllTimelineNotes(); // JS populates timeline items structure too
            updateBucketList();
            updateResources();
            updateGuestbook();

            updateCountdown();
            setInterval(updateCountdown, 1000);
        }

        // --- School Rendering (Mobile adjustments) ---
        function renderInternationalSchools() {
             const splideList = $('#international-schools-splide .splide__list');
             if (!splideList) return;
             if (!internationalSchools || internationalSchools.length === 0) {
                splideList.innerHTML = '<li class="splide__slide p-1"><div class="card h-full p-4 text-center text-sm text-gray-500">No School data.</div></li>';
                return;
             }
             splideList.innerHTML = internationalSchools.map((school) => `
                 <li class="splide__slide p-1">
                     <div class="school-card card h-full flex flex-col" onclick="openDetailModal('international', '${school.id}')">
                         <div class="relative overflow-hidden h-36">
                             <img src="${school.image}" alt="${school.name}" class="w-full h-full object-cover card-image-zoom bg-gray-200 dark:bg-gray-700">
                         </div>
                         <div class="p-4 flex-grow flex flex-col">
                             <h3 class="text-base font-semibold mb-1 line-clamp-2">${school.name}</h3>
                             <p class="text-gray-600 dark:text-gray-400 mb-2 text-xs flex-grow line-clamp-2">${school.description || ''}</p>
                             <div class="flex items-center justify-between text-xs mt-auto pt-2 border-t dark:border-gray-700">
                                 <span class="text-yellow-500 font-medium"><i class="fas fa-star mr-1"></i> ${school.rating || 'N/A'}</span>
                                 <span class="text-primary-500 font-medium">Details <i class="fas fa-info-circle ml-0.5"></i></span>
                             </div>
                         </div>
                     </div>
                 </li>
             `).join('');
             // Refresh splide if already initialized
             if (internationalSplide && internationalSplide.state.is('mounted')) {
                 internationalSplide.refresh();
             }
        }

        function renderPublicSchools() {
             const gridContainer = $('#public-school-grid');
             if (!gridContainer) return;
             if (!defaultPublicSchools || defaultPublicSchools.length === 0) {
                 gridContainer.innerHTML = `<p class="text-center text-sm text-gray-500 dark:text-gray-400 col-span-2 py-6">No school data.</p>`;
                 return;
             }
             gridContainer.innerHTML = defaultPublicSchools.map((school) => `
                <div class="public-school-card card flex flex-col text-xs" onclick="openDetailModal('public', '${school.id}')">
                    <div class="relative overflow-hidden h-32">
                        <img src="${school.image || 'https://via.placeholder.com/300x150.png?text=School'}" alt="${school.name}" class="w-full h-full object-cover card-image-zoom bg-gray-200 dark:bg-gray-700">
                    </div>
                    <div class="p-3 flex-grow flex flex-col">
                        <h3 class="font-semibold text-sm mb-0.5">${school.name}</h3>
                        <p class="text-[11px] text-gray-500 dark:text-gray-400 mb-1">${school.type} - ${school.location}</p>
                        <p class="text-yellow-500 text-xs mb-2 font-semibold"><i class="fas fa-star text-[10px]"></i> ${school.rating} <span class="text-gray-400 text-[10px] font-normal">(Illust.)</span></p>
                        <p class="text-[11px] text-gray-600 dark:text-gray-300 mb-2 flex-grow line-clamp-2">${school.description}</p>
                        <div class="text-primary-500 font-medium text-[11px] mt-auto pt-1.5 border-t dark:border-gray-600 text-center">
                            View Details <i class="fas fa-info-circle ml-0.5"></i>
                        </div>
                    </div>
                 </div>
            `).join('');
        }

        // --- Animation Init (Keep simple animations) ---
        function initializeAnimations() {
             if (typeof gsap === 'undefined' || typeof ScrollTrigger === 'undefined') return;
             gsap.registerPlugin(ScrollTrigger);
             // Simple fade/slide in for cards and key elements
             gsap.utils.toArray('.gsap-reveal').forEach(el => {
                 gsap.fromTo(el, { opacity: 0, y: 15 }, {
                     opacity: 1, y: 0, duration: 0.6, ease: 'power2.out',
                     delay: parseFloat(el.dataset.delay || 0),
                     scrollTrigger: { trigger: el, start: 'top 95%', toggleActions: 'play none none none' }
                 });
             });
             // Stagger for grid items (weather, schools)
             gsap.utils.toArray('[data-gsap-stagger]').forEach(container => {
                 gsap.fromTo(container.children, { opacity: 0, y: 10 }, {
                     opacity: 1, y: 0, duration: 0.4, ease: 'power1.out', stagger: 0.1,
                     scrollTrigger: { trigger: container, start: 'top 90%', toggleActions: 'play none none none' }
                 });
             });
             // Animate timeline line drawing
             const tlLine = $('.timeline-line');
             if(tlLine) { gsap.from(tlLine, { scaleY: 0, transformOrigin: 'top center', duration: 1, ease: 'power1.inOut', scrollTrigger: { trigger: '.timeline-wrapper', start: 'top 80%', end: 'bottom 90%', scrub: 1, } }); }
        }
        function hideLoader() { // Same logic
            const loader = $('#loader');
             if (loader && typeof gsap !== 'undefined') { gsap.to(loader, { opacity: 0, duration: 0.4, delay: LOADER_DURATION / 1000, onComplete: () => { loader.style.display = 'none'; }}); }
             else if (loader) { setTimeout(() => { loader.style.opacity = '0'; loader.style.display = 'none'; }, LOADER_DURATION); }
        }

        // --- Event Listeners Setup ---
        function setupEventListeners() {
            $('#theme-toggle-mobile')?.addEventListener('click', toggleTheme);
            // Removed mobile menu listeners

            // Bottom Nav click handling
            $$('#bottom-nav a').forEach(anchor => anchor.addEventListener('click', handleNavClick));
            setupSimpleScrollSpy(); // Use simple scroll spy for bottom nav

            handleFormSubmit('budget-form', handleBudgetSubmit);
            handleFormSubmit('todo-form', handleTodoSubmit);
            handleFormSubmit('journal-form', handleJournalSubmit);
            handleFormSubmit('apartment-form', handleApartmentSubmit);
            handleFormSubmit('bucket-form', handleBucketSubmit);
            handleFormSubmit('resource-form', handleResourceSubmit);
            handleFormSubmit('guestbook-form', handleGuestbookSubmit);

            document.addEventListener('keydown', (event) => {
                if (event.key === 'Escape' && $modal && $modal.classList.contains('open')) { closeDetailModal(); }
            });
        }

        // --- Navigation (Simplified for Bottom Nav) ---
        function handleNavClick(e) {
             const href = this.getAttribute('href');
             if (!href || !href.startsWith('#')) return;
             e.preventDefault();
             const targetId = href.substring(1);
             const targetElement = document.getElementById(targetId);
             if (!targetElement) return;

             // Simple scrollIntoView for mobile
             const headerHeight = $('header')?.offsetHeight || 56;
             const elementPosition = targetElement.getBoundingClientRect().top;
             const offsetPosition = elementPosition + window.pageYOffset - headerHeight - 16; // 16px buffer

             window.scrollTo({ top: offsetPosition, behavior: 'smooth' });

             // Update active state immediately on click
             setActiveBottomNavLink(this.dataset.targetId);
        }

        // Basic Scroll Spy for Bottom Nav
        function setupSimpleScrollSpy() {
            const sections = $$('main section[id]');
            const navItems = $$('#bottom-nav a');
            if (sections.length === 0 || navItems.length === 0 || typeof ScrollTrigger === 'undefined') return;

            const headerHeight = $('header')?.offsetHeight || 56;
            let currentActiveId = navItems[0].dataset.targetId; // Start with home active

            ScrollTrigger.create({
                 trigger: "main", start: `top+=${headerHeight} top`, end: "bottom bottom", // Adjust start trigger
                 onUpdate: (self) => {
                    let newActiveId = null;
                    const scrollPos = self.scroll();

                    sections.forEach(section => {
                        const sectionTop = section.offsetTop - headerHeight - window.innerHeight * 0.4; // Activate when 40% from top
                        const sectionBottom = sectionTop + section.offsetHeight;
                         // Find the *last* section that starts above the activation point
                         if (scrollPos >= sectionTop) {
                            newActiveId = section.id;
                        }
                    });

                    // If scrolled near bottom, activate last relevant nav item
                    if ((window.innerHeight + window.scrollY) >= document.body.offsetHeight - 100) {
                         const lastSectionId = sections[sections.length - 1].id;
                         // Find nav item corresponding to the last *relevant* section ID in bottom nav
                         const lastNavItem = Array.from(navItems).reverse().find(item => item.dataset.targetId === lastSectionId || document.getElementById(item.dataset.targetId)?.contains(sections[sections.length-1]));
                         if(lastNavItem) newActiveId = lastNavItem.dataset.targetId;
                    }

                    // Handle top of page case explicitly
                    if (scrollPos < sections[0].offsetTop - headerHeight - 50) {
                        newActiveId = 'home';
                    }

                    if (newActiveId && newActiveId !== currentActiveId) {
                         setActiveBottomNavLink(newActiveId);
                         currentActiveId = newActiveId;
                    }
                 }
             });
             // Set initial based on current view or default to home
             setActiveBottomNavLink(currentActiveId);
        }

        function setActiveBottomNavLink(targetId) {
            $$('#bottom-nav a').forEach(item => {
                if (item.dataset.targetId === targetId) {
                    item.classList.add('active');
                } else {
                    item.classList.remove('active');
                }
            });
        }

        // --- Theme Toggle (same as before) ---
        function toggleTheme() { /* ... same ... */
            document.documentElement.classList.toggle('dark'); const isDark = document.documentElement.classList.contains('dark'); localStorage.setItem('theme', isDark ? 'dark' : 'light'); updateThemeIcons(); if (budgetChartInstance) { budgetChartInstance.destroy(); updateBudgetChart(); }
        }
        function updateThemeIcons() { /* ... same ... */
            const isDark = document.documentElement.classList.contains('dark'); const iconClass = isDark ? 'fa-moon' : 'fa-sun'; const btn = $('#theme-toggle-mobile'); if (btn) { btn.innerHTML = `<i class="fas ${iconClass} text-lg"></i>`; }
        }

        // --- Countdown (same logic) ---
        function updateCountdown() { /* ... same logic ... */
             const now = new Date(); const diff = MOVE_DATE - now; const els = { d: $('#days'), h: $('#hours'), m: $('#minutes'), s: $('#seconds') }; if (!Object.values(els).every(el => el !== null)) return; let days = 0, hours = 0, minutes = 0, seconds = 0; if (diff > 0) { days = Math.floor(diff / (1000 * 60 * 60 * 24)); hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60)); minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60)); seconds = Math.floor((diff % (1000 * 60)) / 1000); } els.d.textContent = String(days).padStart(2, '0'); els.h.textContent = String(hours).padStart(2, '0'); els.m.textContent = String(minutes).padStart(2, '0'); els.s.textContent = String(seconds).padStart(2, '0');
        }

        // --- Splide (Mobile specific config) ---
        function initializeSplide() {
            const splideElement = $('#international-schools-splide');
             if (splideElement && typeof Splide !== 'undefined') {
                 try {
                    if (internationalSplide && internationalSplide.state.is('mounted')) { internationalSplide.destroy(true); }
                    internationalSplide = new Splide(splideElement, {
                        type: 'loop', // Loop is fine for mobile
                        perPage: 1, // Show one school at a time
                        perMove: 1,
                        gap: '0.75rem', // Smaller gap
                        pagination: true, // Show dots
                        arrows: false, // Hide arrows
                        autoplay: true,
                        interval: 4000, // Slightly faster autoplay
                        pauseOnHover: true,
                        pauseOnFocus: true,
                    });
                    internationalSplide.mount();
                    console.log("Splide initialized for Mobile Intl Schools.");
                 } catch (e) { console.error("Splide initialization failed:", e); }
             }
         }

        // --- Heatmap Removed ---

        // --- Property Filtering Removed ---

        // --- Generic Form Handling (same) ---
        function handleFormSubmit(formId, handlerFn) { /* ... same ... */
            const form = $(`#${formId}`); if (!form) { console.warn(`Form with ID #${formId} not found.`); return; } form.addEventListener('submit', (event) => { event.preventDefault(); try { handlerFn(form); form.reset(); if (formId === 'budget-form') { const budgetDateInput = form.querySelector('#budget-date'); if (budgetDateInput) { try { budgetDateInput.valueAsDate = new Date(); } catch(e){ budgetDateInput.value = new Date().toISOString().split('T')[0]; }} } showFeedback(form.querySelector('button[type="submit"]'), 'Added!', 'success'); } catch (error) { console.error(`Error handling form #${formId}:`, error); showFeedback(form.querySelector('button[type="submit"]'), 'Error!', 'error'); } });
        }
        function showFeedback(elementContext, message, type = 'success') { /* ... same ... */
             const target = elementContext; if (!target) return; let feedbackEl = target.parentNode.querySelector('.form-feedback'); if (!feedbackEl) { feedbackEl = document.createElement('span'); feedbackEl.className = 'form-feedback text-xs ml-2 transition-opacity duration-300 opacity-0'; target.parentNode.insertBefore(feedbackEl, target.nextSibling); } feedbackEl.textContent = message; feedbackEl.className = `form-feedback text-xs ml-2 transition-opacity duration-300 ${type === 'success' ? 'text-green-500' : 'text-red-500'} opacity-0`; if(typeof gsap !== 'undefined'){gsap.timeline().to(feedbackEl, { opacity: 1, duration: 0.3 }).to(feedbackEl, { opacity: 0, duration: 0.3, delay: 1 });} else { feedbackEl.style.opacity='1'; setTimeout(()=>{feedbackEl.style.opacity='0';}, 1300);}
        }
        function flashHighlight(element) { /* ... same ... */
            if (element) { element.classList.add('highlight-flash'); setTimeout(() => { element.classList.remove('highlight-flash'); }, 1000); }
        }

        // --- Budget Section (logic same, rendering smaller) ---
        function handleBudgetSubmit(form) { /* ... same logic ... */
            const amountInput = form.querySelector('#budget-amount'); const categoryInput = form.querySelector('#budget-category'); const descriptionInput = form.querySelector('#budget-description'); const dateInput = form.querySelector('#budget-date'); const amount = parseFloat(amountInput?.value); const category = categoryInput?.value; const description = descriptionInput?.value.trim(); const date = dateInput?.value || new Date().toISOString().split('T')[0]; if (description && category && !isNaN(amount) && amount > 0) { const newEntry = { id: Date.now(), amount: amount, category: category, description: description, date: date }; appState.budgetEntries.push(newEntry); updateBudgetUI(); saveData(); } else { alert("Please fill in Amount, Category, and Description."); throw new Error("Invalid budget input"); }
        }
        function updateBudgetUI() { updateBudgetChart(); updateBudgetTransactionList(); updateTotalSpent(); }
        function updateBudgetChart() { /* ... same logic, adjusted options ... */
            const ctx = $('#budgetChart')?.getContext('2d'); if (!ctx) return; if (budgetChartInstance) { budgetChartInstance.destroy(); } const totalsByCategory = appState.budgetEntries.reduce((totals, entry) => { totals[entry.category] = (totals[entry.category] || 0) + entry.amount; return totals; }, {}); const labels = Object.keys(totalsByCategory).map(key => key.charAt(0).toUpperCase() + key.slice(1)); const data = Object.values(totalsByCategory); const backgroundColors = ['#0073FF', '#FF9900', '#48A9A6', '#E17F00', '#389996', '#9A6A5C', '#F18F01', '#A05195', '#D45087', '#FF7C43']; const hoverBackgroundColors = backgroundColors.map(color => `${color}E6`); const borderColor = document.documentElement.classList.contains('dark') ? '#1F2937' : '#FFFFFF';
             try {
                 budgetChartInstance = new Chart(ctx, { type: 'doughnut', data: { labels: data.length > 0 ? labels : ['No Data'], datasets: [{ data: data.length > 0 ? data : [1], backgroundColor: data.length > 0 ? backgroundColors.slice(0, data.length) : ['#E5E7EB'], hoverBackgroundColor: data.length > 0 ? hoverBackgroundColors.slice(0, data.length) : ['#D1D5DB'], borderColor: borderColor, borderWidth: 1, }] }, options: { responsive: true, maintainAspectRatio: false, cutout: '65%', plugins: { legend: { display: false }, tooltip: { /* ... same callback ... */ callbacks: { label: function(context) { if (!context.dataset.data || context.dataset.data.length === 0 || context.dataset.data[0] === 1 && context.label === 'No Data') return ' No expenses yet'; let label = context.label || ''; if (label) { label += ': '; } if (context.parsed !== null) { label += formatCurrency(context.parsed); } return label; } } } } } });
             } catch(e) { console.error("Chart.js mobile error:", e); }
        }
        function updateBudgetTransactionList() { /* ... same logic, potentially smaller text/icons if needed via classes ... */
            const container = $('#budget-transactions'); if (!container) return; const sortedEntries = [...appState.budgetEntries].sort((a, b) => new Date(b.date) - new Date(a.date)); if (sortedEntries.length === 0) { container.innerHTML = `<p class="text-center text-xs text-gray-500 dark:text-gray-400 py-4">No expenses yet.</p>`; return; } container.innerHTML = sortedEntries.map(entry => ` <div class="flex justify-between items-center p-1.5 bg-gray-50 dark:bg-gray-700/50 rounded shadow-sm text-xs mb-1.5" data-id="${entry.id}"> <div class="mr-1 overflow-hidden flex-grow"> <span class="font-medium block truncate" title="${entry.description}">${entry.description}</span> <span class="text-[10px] text-gray-500 dark:text-gray-400">${entry.category} • ${formatDate(entry.date)}</span> </div> <div class="flex-shrink-0 flex items-center"> <span class="font-semibold mr-2">${formatCurrency(entry.amount)}</span> <button onclick="deleteBudgetEntry(${entry.id})" class="btn-icon text-gray-400 hover:text-red-500 focus:outline-none w-6 h-6" aria-label="Delete expense"><i class="fas fa-trash-alt text-[10px]"></i></button> </div> </div> `).join('');
        }
        function deleteBudgetEntry(id) { /* ... same logic ... */ if (confirm('Delete expense?')) { const elementToRemove = $(`#budget-transactions [data-id="${id}"]`); const completeDeletion = () => { appState.budgetEntries = appState.budgetEntries.filter(entry => entry.id !== id); updateBudgetUI(); saveData(); /* No feedback toast on mobile for simplicity? Or keep it? */ }; if (elementToRemove && typeof gsap !== 'undefined') { gsap.to(elementToRemove, { opacity: 0, height: 0, margin:0, padding: 0, duration: 0.3, onComplete: completeDeletion }); } else { completeDeletion(); } } }
        function updateTotalSpent() { /* ... same logic ... */ const total = appState.budgetEntries.reduce((sum, entry) => sum + entry.amount, 0); const totalElement = $('#total-spent'); if (totalElement) { totalElement.textContent = formatCurrency(total); } }

        // --- Todo List Section (logic same) ---
        function handleTodoSubmit(form) { /* ... same logic ... */
            const taskInput = form.querySelector('#todo-task'); const dateInput = form.querySelector('#todo-date'); const priorityInput = form.querySelector('#todo-priority'); const task = taskInput?.value.trim(); const date = dateInput?.value || null; const priority = priorityInput?.value || 'medium'; if (task) { const newTodo = { id: Date.now(), task: task, date: date, priority: priority, completed: false }; appState.todos.push(newTodo); updateTodoList(); saveData(); taskInput.focus(); } else { alert("Please enter a task description."); throw new Error("Invalid todo input"); }
        }
        function updateTodoList() { /* ... same logic, potentially smaller text/icons if needed via classes ... */
             const listContainer = $('#todo-list'); if (!listContainer) return; const sortedTodos = [...appState.todos].sort((a, b) => { if (a.completed !== b.completed) { return a.completed ? 1 : -1; } const priorityOrder = { 'high': 0, 'medium': 1, 'low': 2 }; if (priorityOrder[a.priority] !== priorityOrder[b.priority]) { return priorityOrder[a.priority] - priorityOrder[b.priority]; } const dateA = a.date ? new Date(a.date) : Infinity; const dateB = b.date ? new Date(b.date) : Infinity; if (dateA !== Infinity || dateB !== Infinity) { return dateA - dateB; } return 0; }); if (sortedTodos.length === 0) { listContainer.innerHTML = `<p class="text-center text-xs text-gray-500 dark:text-gray-400 py-4">Task list is clear!</p>`; return; } listContainer.innerHTML = sortedTodos.map(todo => ` <div class="flex items-center justify-between p-2 bg-gray-50 dark:bg-gray-700/50 rounded shadow-sm text-xs mb-1.5" data-id="${todo.id}"> <div class="flex items-center overflow-hidden mr-1 flex-grow min-w-0"> <input type="checkbox" id="todo-${todo.id}" ${todo.completed ? 'checked' : ''} onchange="toggleTodo(${todo.id})" class="mr-2 h-4 w-4 rounded text-primary-600 border-gray-300 dark:border-gray-600 focus:ring-primary-500 flex-shrink-0 cursor-pointer"> <label for="todo-${todo.id}" class="cursor-pointer overflow-hidden min-w-0"> <span class="font-medium block break-words ${todo.completed ? 'line-through text-gray-400 dark:text-gray-500' : 'text-gray-800 dark:text-gray-100'}">${todo.task}</span> ${todo.date ? `<span class="text-[10px] text-gray-500 dark:text-gray-400 ${todo.completed ? 'line-through' : ''}">${formatDate(todo.date)}</span>` : ''} </label> </div> <div class="flex items-center flex-shrink-0 ml-1 space-x-1"> <span class="px-1.5 py-0.5 text-[9px] rounded-full ${getPriorityClasses(todo.priority)} capitalize font-medium">${todo.priority}</span> <button onclick="deleteTodo(${todo.id})" class="btn-icon text-gray-400 hover:text-red-500 focus:outline-none w-6 h-6" aria-label="Delete task"><i class="fas fa-trash-alt text-[10px]"></i></button> </div> </div> `).join('');
         }
        function toggleTodo(id) { /* ... same logic ... */ appState.todos = appState.todos.map(todo => todo.id === id ? { ...todo, completed: !todo.completed } : todo); updateTodoList(); saveData(); }
        function deleteTodo(id) { /* ... same logic ... */ if (confirm('Delete task?')) { const elementToRemove = $(`#todo-list [data-id="${id}"]`); const completeDeletion = () => { appState.todos = appState.todos.filter(todo => todo.id !== id); updateTodoList(); saveData(); }; if (elementToRemove && typeof gsap !== 'undefined') { gsap.to(elementToRemove, { opacity: 0, x: 30, duration: 0.3, onComplete: completeDeletion }); } else { completeDeletion(); } } }
        function getPriorityClasses(priority) { /* ... same logic ... */ switch(priority) { case 'high': return 'bg-red-100 text-red-800 dark:bg-red-900/50 dark:text-red-200'; case 'medium': return 'bg-yellow-100 text-yellow-800 dark:bg-yellow-900/50 dark:text-yellow-200'; case 'low': return 'bg-green-100 text-green-800 dark:bg-green-900/50 dark:text-green-200'; default: return 'bg-gray-100 text-gray-800 dark:bg-gray-600 dark:text-gray-200'; } }

        // --- Journal Section (logic same) ---
        function handleJournalSubmit(form) { /* ... same logic ... */
             const titleInput = form.querySelector('#journal-title'); const contentInput = form.querySelector('#journal-content'); const moodInput = form.querySelector('#journal-mood'); const title = titleInput?.value.trim(); const content = contentInput?.value.trim(); const mood = moodInput?.value || 'neutral'; const date = new Date().toISOString(); if (title && content) { const newEntry = { id: Date.now(), title: title, content: content, mood: mood, date: date }; appState.journalEntries.unshift(newEntry); updateJournalEntries(); saveData(); } else { alert("Please enter both a title and content."); throw new Error("Invalid journal input"); }
         }
        function updateJournalEntries() { /* ... same logic, potentially smaller text if needed ... */
             const container = $('#journal-entries'); if (!container) return; const entries = appState.journalEntries; if (entries.length === 0) { container.innerHTML = `<p class="text-center text-xs text-gray-500 dark:text-gray-400 py-4">No journal entries yet.</p>`; return; } container.innerHTML = entries.map(entry => ` <article class="p-3 bg-gray-50 dark:bg-gray-700/50 rounded-lg shadow-sm relative text-xs mb-2" data-id="${entry.id}"> <div class="flex justify-between items-start mb-1"> <h4 class="font-semibold text-sm text-primary-700 dark:text-primary-300 pr-8 break-words flex-grow">${entry.title}</h4> <span class="text-xl absolute top-2 right-2" title="${entry.mood}">${getMoodEmoji(entry.mood)}</span> </div> <div class="text-[10px] text-gray-500 dark:text-gray-400 mb-1.5">${new Date(entry.date).toLocaleString('en-US', { dateStyle: 'medium', timeStyle: 'short' })}</div> <p class="whitespace-pre-wrap break-words text-gray-700 dark:text-gray-300 leading-relaxed pb-4">${entry.content}</p> <button onclick="deleteJournalEntry(${entry.id})" class="btn-icon text-gray-400 hover:text-red-500 absolute bottom-1 right-1 focus:outline-none w-6 h-6" aria-label="Delete journal entry"><i class="fas fa-trash-alt text-[10px]"></i></button> </article> `).join(''); const newElement = container.querySelector(`[data-id="${entries[0]?.id}"]`); if (newElement && typeof gsap !== 'undefined') { gsap.from(newElement, { opacity: 0, y: 15, duration: 0.4, ease: 'power1.out' }); }
         }
        function deleteJournalEntry(id) { /* ... same logic ... */ if (confirm('Delete entry?')) { const elementToRemove = $(`#journal-entries [data-id="${id}"]`); const completeDeletion = () => { appState.journalEntries = appState.journalEntries.filter(entry => entry.id !== id); updateJournalEntries(); saveData(); }; if (elementToRemove && typeof gsap !== 'undefined') { gsap.to(elementToRemove, { opacity: 0, scale: 0.95, duration: 0.3, onComplete: completeDeletion }); } else { completeDeletion(); } } }
        function getMoodEmoji(mood) { /* ... same logic ... */ const emojiMap = { excited: '😊', happy: '😄', neutral: '😐', anxious: '😟', stressed: '😫', thoughtful: '🤔', celebrating: '🎉' }; return emojiMap[mood] || '📝'; }

        // --- Apartment Tracker (logic same) ---
        function handleApartmentSubmit(form) { /* ... same logic ... */
             const locationInput = form.querySelector('#apt-location'); const sizeInput = form.querySelector('#apt-size'); const priceInput = form.querySelector('#apt-price'); const linkInput = form.querySelector('#apt-link'); const notesInput = form.querySelector('#apt-notes'); const location = locationInput?.value.trim(); const size = sizeInput?.value ? parseInt(sizeInput.value, 10) : null; const price = priceInput?.value ? parseFloat(priceInput.value) : null; const link = linkInput?.value.trim(); const notes = notesInput?.value.trim(); if (location && price !== null && price > 0) { const newApartment = { id: Date.now(), location: location, size: size, price: price, link: (link && (link.startsWith('http:') || link.startsWith('https://'))) ? link : null, notes: notes }; appState.trackedApartments.push(newApartment); updateApartmentTable(); saveData(); } else { alert("Please provide Location and Price."); throw new Error("Invalid apartment input"); }
        }
        function updateApartmentTable() { /* ... same logic, rendered table is already small ... */
             const tableBody = $('#apartment-table-body'); if (!tableBody) return; const sortedApartments = [...appState.trackedApartments].sort((a, b) => a.price - b.price); if (sortedApartments.length === 0) { tableBody.innerHTML = `<tr><td colspan="6" class="text-center py-3 text-xs text-gray-500 dark:text-gray-400">No apartments tracked.</td></tr>`; return; } tableBody.innerHTML = sortedApartments.map(apt => ` <tr data-id="${apt.id}"> <td class="py-2 px-1 font-medium text-gray-800 dark:text-gray-100">${apt.location}</td> <td class="py-2 px-1">${formatCurrency(apt.price)}</td> <td class="py-2 px-1">${apt.size ? apt.size + 'm²' : '-'}</td> <td class="py-2 px-1"> ${apt.link ? `<a href="${apt.link}" target="_blank" rel="noopener noreferrer" class="text-primary-500 hover:text-primary-700 dark:hover:text-primary-300" title="${apt.link}"><i class="fas fa-external-link-alt"></i></a>` : '-'} </td> <td class="py-2 px-1 text-[10px] max-w-[60px] truncate" title="${apt.notes}">${apt.notes || '-'}</td> <td class="py-2 px-1"> <button onclick="deleteApartment(${apt.id})" class="btn-icon text-red-500 hover:text-red-700 focus:outline-none w-5 h-5" aria-label="Delete apartment"><i class="fas fa-trash-alt text-[10px]"></i></button> </td> </tr> `).join(''); const lastAddedId = appState.trackedApartments[appState.trackedApartments.length - 1]?.id; if(lastAddedId){ const newRow = tableBody.querySelector(`tr[data-id="${lastAddedId}"]`); flashHighlight(newRow); }
        }
        function deleteApartment(id) { /* ... same logic ... */ if (confirm('Remove apartment?')) { const rowToRemove = $(`#apartment-table-body tr[data-id="${id}"]`); const completeDeletion = () => { appState.trackedApartments = appState.trackedApartments.filter(apt => apt.id !== id); updateApartmentTable(); saveData(); }; if (rowToRemove && typeof gsap !== 'undefined') { gsap.to(rowToRemove, { opacity: 0, height: 0, duration: 0.3, onComplete: completeDeletion }); } else { completeDeletion(); } } }

        // --- Timeline Interactions (logic same, simpler CSS handled layout) ---
        function toggleTimelineDetails(timelineId) { /* ... same logic as previous fixed version ... */
            const detailsDiv = $(`#details-${timelineId}`); const headerDiv = $(`.timeline-item[data-timeline-id="${timelineId}"] .timeline-header`); const indicatorIcon = headerDiv?.querySelector('.indicator'); if (!detailsDiv || !indicatorIcon) return; const isExpanded = detailsDiv.classList.contains('expanded'); if (typeof gsap !== 'undefined') { if (isExpanded) { indicatorIcon.classList.remove('rotate-180'); gsap.to(detailsDiv.querySelectorAll('li'), { opacity: 0, duration: 0.1 }); gsap.to(detailsDiv, { height: 0, opacity: 0, paddingTop: 0, paddingBottom: 0, marginTop: 0, duration: 0.4, ease: 'power2.inOut', onComplete: () => detailsDiv.classList.remove('expanded') }); } else { indicatorIcon.classList.add('rotate-180'); detailsDiv.classList.add('expanded'); gsap.set(detailsDiv, { height: 'auto', opacity: 1, paddingTop: '0.75rem', paddingBottom: '0.75rem', marginTop: '0.75rem' }); gsap.from(detailsDiv, { height: 0, opacity: 0, paddingTop: 0, paddingBottom: 0, marginTop: 0, duration: 0.5, ease: 'power2.out' }); gsap.fromTo(detailsDiv.querySelectorAll('li'), { opacity: 0, y: 10 }, { opacity: 1, y: 0, duration: 0.3, stagger: 0.08, delay: 0.2, ease: 'power1.out' } ); } } else { if (isExpanded) { detailsDiv.classList.remove('expanded'); detailsDiv.style.maxHeight = '0px'; indicatorIcon.classList.remove('rotate-180'); } else { detailsDiv.classList.add('expanded'); detailsDiv.style.maxHeight = detailsDiv.scrollHeight + 'px'; indicatorIcon.classList.add('rotate-180'); } }
        }
        function toggleNoteForm(timelineId) { /* ... same logic ... */ const itemContainer = $(`.timeline-item[data-timeline-id="${timelineId}"]`); if (!itemContainer) return; const form = itemContainer.querySelector('.add-note-form'); const button = itemContainer.querySelector('button[onclick^="toggleNoteForm"]'); if (!form || !button) return; const isHidden = form.classList.contains('hidden'); if (typeof gsap !== 'undefined') { if (isHidden) { form.classList.remove('hidden'); button.classList.add('hidden'); gsap.fromTo(form, { height: 0, opacity: 0, marginTop: 0 }, { height: 'auto', opacity: 1, marginTop: '0.25rem', duration: 0.3, ease: 'power1.out', onComplete: () => form.querySelector('textarea')?.focus() }); } else { gsap.to(form, { height: 0, opacity: 0, marginTop: 0, duration: 0.3, ease: 'power1.in', onComplete: () => { form.classList.add('hidden'); button.classList.remove('hidden'); }}); } } else { if (isHidden) { form.classList.remove('hidden'); button.classList.add('hidden'); form.querySelector('textarea')?.focus(); } else { form.classList.add('hidden'); button.classList.remove('hidden'); } } }
        function addTimelineNote(event, timelineId) { /* ... same logic ... */ event.preventDefault(); const form = event.target; const textarea = form.querySelector('textarea'); const noteText = textarea?.value.trim(); if (noteText) { if (!appState.timelineNotes[timelineId]) { appState.timelineNotes[timelineId] = []; } const newNote = { id: Date.now(), text: noteText, date: new Date().toISOString() }; appState.timelineNotes[timelineId].unshift(newNote); renderTimelineNotes(timelineId); saveData(); textarea.value = ''; toggleNoteForm(timelineId); } }
        function renderTimelineNotes(timelineId) { /* ... same logic, potentially smaller CSS via classes ... */ const itemContainer = $(`.timeline-item[data-timeline-id="${timelineId}"]`); if (!itemContainer) return; const notesDisplayContainer = itemContainer.querySelector('.notes-display'); if (!notesDisplayContainer) return; const notes = appState.timelineNotes[timelineId] || []; notes.sort((a, b) => new Date(b.date) - new Date(a.date)); if (notes.length === 0) { notesDisplayContainer.innerHTML = ''; return; } notesDisplayContainer.innerHTML = notes.map(note => ` <div class="timeline-note" data-id="${note.id}" style="opacity: 0;"> <p class="text-[10px] text-gray-500 dark:text-gray-300 mb-0.5">${new Date(note.date).toLocaleDateString('en-GB', { day: '2-digit', month: 'short', year:'2-digit' })}</p> <p class="whitespace-pre-wrap break-words text-gray-800 dark:text-gray-200 leading-snug">${note.text}</p> <button onclick="deleteTimelineNote('${timelineId}', ${note.id})" class="btn-icon w-5 h-5 text-gray-400 hover:text-red-500 focus:outline-none" aria-label="Delete note"><i class="fas fa-times text-[10px]"></i></button> </div> `).join(''); if (typeof gsap !== 'undefined') { gsap.fromTo(notesDisplayContainer.querySelectorAll('.timeline-note'), { opacity: 0, y: 10 }, { opacity: 1, y: 0, duration: 0.4, stagger: 0.1, ease: 'power1.out' } ); } else { notesDisplayContainer.querySelectorAll('.timeline-note').forEach(el => el.style.opacity='1');} }
        function deleteTimelineNote(timelineId, noteId) { /* ... same logic ... */ if (confirm('Delete note?')) { if (appState.timelineNotes[timelineId]) { const noteElement = $(`.timeline-item[data-timeline-id="${timelineId}"] .timeline-note[data-id="${noteId}"]`); const completeDeletion = () => { appState.timelineNotes[timelineId] = appState.timelineNotes[timelineId].filter(note => note.id !== noteId); renderTimelineNotes(timelineId); saveData(); }; if (noteElement && typeof gsap !== 'undefined') { gsap.to(noteElement, {opacity: 0, height: 0, margin:0, padding:0, duration: 0.3, onComplete: completeDeletion}); } else { completeDeletion(); } } } }
        function renderAllTimelineNotes() { Object.keys(appState.timelineNotes).forEach(id => renderTimelineNotes(id)); renderStaticTimelineItems(); } // Modified to call static render

        // --- NEW: Render Static Timeline Items (to ensure structure exists) ---
        function renderStaticTimelineItems() {
            const container = $('#timeline-items-container');
            if (!container || container.children.length > 0) return; // Don't re-render if already populated

            const staticItems = [
                 { id: 'prep-research', icon: 'fa-clipboard-check', title: '✅ Prepping & Research', date: 'March–May 2025', intro: 'Laying the groundwork...', tasks: ['Finalize decision', 'Research cities/schools', 'Budgeting & savings', 'Review visa options', 'Look into schools', 'Get records'], future: false, final: false },
                 { id: 'legal-logistics', icon: 'fa-passport', title: '🛂 Legal & Logistics', date: 'June–Aug 2025', intro: 'Navigating paperwork...', tasks: ['Start visa paperwork', 'Consulate appointments', 'Renew passports', 'FBI checks/apostilles', 'Optional trial trip'], future: false, final: false },
                 { id: 'docs-downsizing', icon: 'fa-box-open', title: '📦 Docs & Downsizing', date: 'Sept–Nov 2025', intro: 'Translating & decluttering...', tasks: ['Translate documents', 'Declutter/sell items', 'List car/home', 'Research shipping', 'Contact banks'], future: false, final: false },
                 { id: 'health-housing', icon: 'fa-heartbeat', title: '🩺 Health & Housing', date: 'Dec 2025–Feb 2026', intro: 'Medical checks & finding base...', tasks: ['Medical/dental checkups', 'Collect records', 'Health insurance', 'Secure housing', 'Submit visa app'], future: false, final: false },
                 { id: 'schooling-systems', icon: 'fa-book-reader', title: '📘 Schooling & Systems', date: 'March–May 2026', intro: 'Finalizing education & US admin...', tasks: ['Confirm school enrollment', 'Finish visa paperwork', 'Notify U.S. institutions', 'Set up forwarding address', 'Practice Spanish'], future: true, final: false },
                 { id: 'final-prep', icon: 'fa-calendar-check', title: '🗓️ Final Prep', date: 'June 2026', intro: 'Packing, goodbyes, checks...', tasks: ['Sell car, pack, party', 'Cancel subscriptions', 'Confirm flights', 'Gather final docs'], future: true, final: false },
                 { id: 'move-to-spain', icon: 'fa-flag', title: '✈️ Move to Spain!', date: 'July 2026', dateId: 'move-date-display', intro: '¡Hola Valencia! 🇪🇸❤️', tasks: ['Fly to Valencia', 'Get Empadronamiento', 'Start TIE process', 'Settle in!'], future: true, final: true }, // Future true here ensures styling if date is future
            ];

            container.innerHTML = staticItems.map(item => `
                <div class="timeline-item gsap-reveal ${item.future ? 'future-item' : ''}" data-timeline-id="${item.id}">
                     <div class="timeline-dot ${item.future ? 'future' : ''} ${item.final ? 'final' : ''}"><i class="fas ${item.icon}"></i></div>
                     <div class="timeline-header" onclick="toggleTimelineDetails('${item.id}')">
                        <h3 class="${item.final ? 'text-accent-600 dark:text-accent-400' : ''}">${item.title}</h3>
                        <p class="${item.final ? 'font-bold' : ''}" ${item.dateId ? `id="${item.dateId}"` : ''}>${item.date}<i class="fas fa-chevron-down indicator"></i></p>
                     </div>
                     <div class="timeline-content ${item.future ? 'future' : ''} ${item.final ? 'final' : ''}">
                        <p class="mb-3 italic text-xs text-gray-600 dark:text-gray-400">${item.intro}</p>
                        <div class="timeline-details" id="details-${item.id}">
                            <ul>${item.tasks.map(task => `<li class="${item.future ? 'future-task' : ''}"><i class="fas fa-circle text-[6px]"></i>${task}</li>`).join('')}</ul>
                        </div>
                        <div class="timeline-notes-container">
                            <div class="notes-display space-y-1.5 mb-1.5"></div>
                            <button onclick="toggleNoteForm('${item.id}')" class="btn-secondary btn-sm"><i class="fas fa-plus mr-1 text-[9px]"></i> Note</button>
                            <form class="add-note-form hidden" onsubmit="addTimelineNote(event, '${item.id}')">
                                <textarea class="form-textarea text-xs" rows="2" placeholder="Add note..."></textarea>
                                <div class="flex space-x-1 mt-1">
                                    <button type="submit" class="btn-primary btn-sm">Save</button>
                                    <button type="button" onclick="toggleNoteForm('${item.id}')" class="btn-secondary btn-sm">Cancel</button>
                                </div>
                            </form>
                        </div>
                     </div>
                </div>
            `).join('');

            // Re-render any loaded notes after static structure is built
            renderAllTimelineNotes();
        }


        // --- Bucket List (logic same) ---
        function handleBucketSubmit(form) { /* ... same logic ... */ const itemInput = form.querySelector('#bucket-item'); const categoryInput = form.querySelector('#bucket-category'); const dateInput = form.querySelector('#bucket-date'); const item = itemInput?.value.trim(); const category = categoryInput?.value || 'sightseeing'; const date = dateInput?.value || null; if (item) { const newItem = { id: Date.now(), item: item, category: category, date: date, completed: false }; appState.bucketList.push(newItem); updateBucketList(); saveData(); itemInput.focus(); } else { alert("Please enter an item."); throw new Error("Invalid bucket list input"); } }
        function updateBucketList() { /* ... same logic, potentially smaller CSS classes ... */ const listContainer = $('#bucket-list-items'); if (!listContainer) return; const sortedList = [...appState.bucketList].sort((a, b) => { if (a.completed !== b.completed) { return a.completed ? 1 : -1; } const dateA = a.date ? new Date(a.date + '-01') : Infinity; const dateB = b.date ? new Date(b.date + '-01') : Infinity; if (dateA !== Infinity || dateB !== Infinity) { if(dateA !== dateB) return dateA - dateB; } return a.item.localeCompare(b.item); }); if (sortedList.length === 0) { listContainer.innerHTML = `<p class="text-center text-xs text-gray-500 dark:text-gray-400 py-4">Add to your wish list!</p>`; return; } listContainer.innerHTML = sortedList.map(item => ` <div class="flex items-center justify-between p-2 bg-gray-50 dark:bg-gray-700/50 rounded shadow-sm text-xs mb-1.5" data-id="${item.id}"> <div class="flex items-center overflow-hidden mr-1 flex-grow min-w-0"> <input type="checkbox" id="bucket-${item.id}" ${item.completed ? 'checked' : ''} onchange="toggleBucketItem(${item.id})" class="mr-2 h-4 w-4 rounded text-primary-600 border-gray-300 dark:border-gray-600 focus:ring-primary-500 flex-shrink-0 cursor-pointer"> <label for="bucket-${item.id}" class="cursor-pointer overflow-hidden min-w-0"> <span class="font-medium block break-words ${item.completed ? 'line-through text-gray-400 dark:text-gray-500' : 'text-gray-800 dark:text-gray-100'}">${item.item}</span> <span class="text-[10px] text-gray-500 dark:text-gray-400 ${item.completed ? 'line-through' : ''}">${item.category.split(' ')[0]} ${item.date ? ` • ${formatMonthYear(item.date)}` : ''}</span> </label> </div> <button onclick="deleteBucketItem(${item.id})" class="btn-icon text-gray-400 hover:text-red-500 flex-shrink-0 focus:outline-none w-6 h-6" aria-label="Delete bucket list item"><i class="fas fa-trash-alt text-[10px]"></i></button> </div> `).join(''); const lastAddedId = appState.bucketList[appState.bucketList.length - 1]?.id; if (lastAddedId) { const newItemElement = listContainer.querySelector(`[data-id="${lastAddedId}"]`); flashHighlight(newItemElement); } }
        function toggleBucketItem(id) { /* ... same logic ... */ appState.bucketList = appState.bucketList.map(item => item.id === id ? { ...item, completed: !item.completed } : item); updateBucketList(); saveData(); }
        function deleteBucketItem(id) { /* ... same logic ... */ if (confirm('Remove item?')) { const elementToRemove = $(`#bucket-list-items [data-id="${id}"]`); const completeDeletion = () => { appState.bucketList = appState.bucketList.filter(item => item.id !== id); updateBucketList(); saveData(); }; if (elementToRemove && typeof gsap !== 'undefined') { gsap.to(elementToRemove, { opacity: 0, x: 30, duration: 0.3, onComplete: completeDeletion }); } else { completeDeletion(); } } }

        // --- Resources (logic same, uses modal) ---
        function handleResourceSubmit(form) { /* ... same logic ... */ const titleInput = form.querySelector('#resource-title'); const urlInput = form.querySelector('#resource-url'); const categoryInput = form.querySelector('#resource-category'); const descriptionInput = form.querySelector('#resource-description'); const title = titleInput?.value.trim(); const url = urlInput?.value.trim(); const category = categoryInput?.value || 'other'; const description = descriptionInput?.value.trim(); if (title && url && (url.startsWith('http://') || url.startsWith('https://') || url.startsWith('/'))) { const newResource = { id: Date.now(), title: title, url: url, category: category, description: description }; appState.resources.push(newResource); updateResources(); saveData(); titleInput.focus(); } else { alert("Please enter a valid Title and URL."); throw new Error("Invalid resource input"); } }
        function updateResources() { /* ... same logic, potentially smaller CSS classes ... */ const listContainer = $('#resource-list'); if (!listContainer) return; const sortedResources = [...appState.resources].sort((a, b) => { const categoryCompare = a.category.localeCompare(b.category); if (categoryCompare !== 0) { return categoryCompare; } return a.title.localeCompare(b.title, undefined, { sensitivity: 'base' }); }); if (sortedResources.length === 0) { listContainer.innerHTML = `<p class="text-center text-xs text-gray-500 dark:text-gray-400 py-4">No resources added yet.</p>`; return; } listContainer.innerHTML = sortedResources.map(resource => ` <div class="p-2.5 bg-gray-50 dark:bg-gray-700/50 rounded-lg shadow-sm relative text-xs mb-2 group" data-id="${resource.id}"> <div class="flex justify-between items-start mb-1"> <h4 class="font-semibold flex-grow mr-14"> <button type="button" onclick="openDetailModal('resource', ${resource.id})" class="text-left text-primary-600 dark:text-primary-400 hover:underline focus:outline-none focus:ring-1 focus:ring-primary-400 rounded break-words text-sm"> ${resource.title} </button> </h4> <span class="px-1.5 py-0.5 text-[9px] rounded-full bg-gray-200 text-gray-700 dark:bg-gray-600 dark:text-gray-200 absolute top-2 right-2 whitespace-nowrap font-medium capitalize">${resource.category.split(' ')[0]}</span> </div> ${resource.description ? `<p class="text-[11px] text-gray-600 dark:text-gray-300 mb-0.5 pr-12 leading-snug line-clamp-2">${resource.description}</p>` : ''} <div class="absolute bottom-1.5 right-1.5 flex space-x-0.5"> <a href="${resource.url}" target="_blank" rel="noopener noreferrer" class="btn-icon text-gray-400 hover:text-primary-500 w-6 h-6" title="Open link"> <i class="fas fa-external-link-alt text-[10px]"></i></a> <button onclick="deleteResource(${resource.id})" class="btn-icon text-gray-400 hover:text-red-500 focus:outline-none w-6 h-6" aria-label="Delete resource"> <i class="fas fa-trash-alt text-[10px]"></i> </button> </div> </div> `).join(''); const lastAddedId = appState.resources[appState.resources.length - 1]?.id; if(lastAddedId) { const newElement = listContainer.querySelector(`[data-id="${lastAddedId}"]`); flashHighlight(newElement); } }
        function deleteResource(id) { /* ... same logic ... */ if (confirm('Delete resource?')) { const elementToRemove = $(`#resource-list [data-id="${id}"]`); const completeDeletion = () => { appState.resources = appState.resources.filter(res => res.id !== id); updateResources(); saveData(); }; if (elementToRemove && typeof gsap !== 'undefined') { gsap.to(elementToRemove, { opacity: 0, scale: 0.95, duration: 0.3, onComplete: completeDeletion }); } else { completeDeletion(); } } }

        // --- Modal Functions (logic same, CSS handles mobile size) ---
        function openDetailModal(type, id) { /* ... same logic ... */ let item; if (type === 'international') { item = internationalSchools.find(school => school.id === id); } else if (type === 'public') { item = defaultPublicSchools.find(school => school.id === id); } else if (type === 'resource') { item = appState.resources.find(res => res.id === parseInt(id)); } if (!item || !$modal) return console.error(`Item/Modal not found for ${type} ${id}`); const $modalContent = $modal.querySelector('.modal-content'); const $modalImage = $('#modal-image'); const $modalTitle = $('#modal-title'); const $modalInfoLabel1 = $('#modal-info-label1'); const $modalInfoValue1 = $('#modal-info-value1'); const $modalInfoLabel2 = $('#modal-info-label2'); const $modalInfoValue2 = $('#modal-info-value2'); const $modalInfoLabel3 = $('#modal-info-label3'); const $modalInfoValue3 = $('#modal-info-value3'); const $modalDescription = $('#modal-description'); const $modalFeaturesContainer = $('#modal-features-container'); const $modalFeaturesList = $('#modal-features-list'); const $modalWebsiteLink = $('#modal-website-link'); $modalImage.classList.add('hidden'); $modalImage.src = ''; $modalImage.alt = ''; $modalFeaturesContainer.classList.add('hidden'); $modalFeaturesList.innerHTML = ''; $modalWebsiteLink.classList.add('hidden'); $modalWebsiteLink.href = '#'; $modalInfoLabel1.textContent = ''; $modalInfoValue1.textContent = ''; $modalInfoLabel2.textContent = ''; $modalInfoValue2.textContent = ''; $modalInfoLabel3.textContent = ''; $modalInfoValue3.innerHTML = ''; $modalInfoValue3.classList.remove('rating-value'); $modalTitle.textContent = item.name || item.title; if ((type === 'international' || type === 'public') && item.image) { $modalImage.src = item.image; $modalImage.alt = item.name; $modalImage.classList.remove('hidden'); } if (type === 'international' || type === 'public') { $modalInfoLabel1.textContent = 'Type:'; $modalInfoValue1.textContent = item.type; $modalInfoLabel2.textContent = 'Location:'; $modalInfoValue2.textContent = item.location; if(item.rating) { $modalInfoLabel3.textContent = 'Rating:'; $modalInfoValue3.innerHTML = `<i class="fas fa-star mr-1 text-xs"></i> ${item.rating} ${item.rating.includes('/5') ? '' : ' (Illust.)'}`; $modalInfoValue3.classList.add('rating-value'); } } else if (type === 'resource') { $modalInfoLabel1.textContent = 'Category:'; $modalInfoValue1.textContent = item.category; $modalInfoLabel2.textContent = 'URL:'; $modalInfoValue2.textContent = item.url; $modalInfoLabel3.textContent = ''; $modalInfoValue3.innerHTML = ''; } $modalDescription.textContent = item.description || 'No description provided.'; if ((type === 'international' || type === 'public') && Array.isArray(item.features) && item.features.length > 0) { $modalFeaturesList.innerHTML = item.features.map(f => `<li>${f}</li>`).join(''); $modalFeaturesContainer.classList.remove('hidden'); } const websiteUrl = item.website || item.url; if (websiteUrl && websiteUrl !== '#') { $modalWebsiteLink.href = websiteUrl; $modalWebsiteLink.classList.remove('hidden'); if (type === 'resource') { $modalWebsiteLink.innerHTML = 'Visit Link <i class="fas fa-external-link-alt ml-1 text-xs"></i>'; } else { $modalWebsiteLink.innerHTML = 'Visit Website <i class="fas fa-external-link-alt ml-1 text-xs"></i>'; } } $modal.classList.add('open'); document.body.style.overflow = 'hidden'; $modalContent.scrollTop = 0; $modal.focus(); }
        function closeDetailModal(event) { /* ... same logic ... */ if (!$modal || !$modal.classList.contains('open')) return; if (!event || event.target === $modal || event.target.closest('.modal-close')) { if (event && event.stopPropagation) event.stopPropagation(); $modal.classList.remove('open'); setTimeout(() => { document.body.style.overflow = ''; }, 300); } }

        // --- Utilities (same) ---
        function formatCurrency(amount) { /* ... same ... */ try { return new Intl.NumberFormat('es-ES', { style: 'currency', currency: 'EUR' }).format(amount); } catch (e) { return amount.toFixed(2) + ' €'; } }
        function formatDate(dateString) { /* ... same ... */ if (!dateString) return ''; try { const date = new Date(dateString + 'T00:00:00'); if (isNaN(date.getTime())) throw new Error("Invalid date"); return date.toLocaleDateString('en-GB', { day: '2-digit', month: 'short', year: 'numeric' }); } catch (e) { console.warn("Error formatting date:", dateString, e); return dateString; } }
        function formatMonthYear(yyyyMM) { /* ... same ... */ if (!yyyyMM) return ''; try { const [year, month] = yyyyMM.split('-'); const date = new Date(year, month - 1); return date.toLocaleDateString('en-US', { year: 'numeric', month: 'short' }); } catch (e) { return yyyyMM; } }

        // --- Guestbook (logic same) ---
        function handleGuestbookSubmit(form) { /* ... same logic ... */
             const nameInput = form.querySelector('#guest-name'); const messageInput = form.querySelector('#guest-message'); const name = nameInput?.value.trim(); const message = messageInput?.value.trim(); const date = new Date().toISOString(); if (name && message) { const newEntry = { id: Date.now(), name: name, message: message, date: date }; appState.guestbookEntries.unshift(newEntry); updateGuestbook(); saveData(); alert('Thank you!'); } else { alert('Please enter name and message.'); throw new Error("Invalid guestbook input"); }
        }
        function updateGuestbook() { /* ... same logic, potentially smaller CSS classes ... */
             const container = $('#guestbook-entries'); if (!container) return; const entries = appState.guestbookEntries; if (entries.length === 0) { container.innerHTML = `<p class="text-center text-xs text-gray-500 dark:text-gray-400 py-4">No messages yet.</p>`; return; } container.innerHTML = entries.map(entry => ` <div class="p-3 bg-gray-50 dark:bg-gray-700/50 rounded-lg shadow-sm text-xs mb-2" data-id="${entry.id}"> <div class="flex justify-between items-start mb-1"> <h4 class="font-semibold text-gray-800 dark:text-gray-100 break-words">${entry.name}</h4> <span class="text-[10px] text-gray-500 dark:text-gray-400 flex-shrink-0 ml-2 whitespace-nowrap">${new Date(entry.date).toLocaleDateString('en-GB', { day:'numeric', month:'short', year:'2-digit' })}</span> </div> <p class="whitespace-pre-wrap break-words text-gray-700 dark:text-gray-300 leading-relaxed">${entry.message}</p> </div> `).join(''); const newElement = container.querySelector(`[data-id="${entries[0]?.id}"]`); if (newElement && typeof gsap !== 'undefined') { gsap.from(newElement, { opacity: 0, y: 15, duration: 0.4, ease: 'power1.out' }); }
        }

        // --- Local Storage (logic same) ---
        function saveData() { /* ... same ... */ try { localStorage.setItem(STORAGE_KEY, JSON.stringify(appState)); } catch (e) { console.error("Error saving data:", e); } }
        function loadData() { /* ... same logic, ensure defaults used if needed ... */ try { const savedDataString = localStorage.getItem(STORAGE_KEY); if (savedDataString) { const loadedState = JSON.parse(savedDataString); if (loadedState && typeof loadedState === 'object') { appState.budgetEntries = Array.isArray(loadedState.budgetEntries) ? loadedState.budgetEntries : []; appState.todos = Array.isArray(loadedState.todos) ? loadedState.todos : []; appState.journalEntries = Array.isArray(loadedState.journalEntries) ? loadedState.journalEntries : []; appState.trackedApartments = Array.isArray(loadedState.trackedApartments) ? loadedState.trackedApartments : []; appState.timelineNotes = (typeof loadedState.timelineNotes === 'object' && loadedState.timelineNotes !== null) ? loadedState.timelineNotes : {}; appState.bucketList = Array.isArray(loadedState.bucketList) ? loadedState.bucketList : []; appState.resources = (Array.isArray(loadedState.resources) && loadedState.resources.length > 0) ? loadedState.resources : [...defaultResources]; appState.guestbookEntries = Array.isArray(loadedState.guestbookEntries) ? loadedState.guestbookEntries : []; console.log("Mobile data loaded."); } else { throw new Error("Invalid loaded data format."); } } else { appState.resources = [...defaultResources]; console.log("No mobile data found, using defaults."); } } catch (e) { console.error("Error loading mobile data:", e); appState = { budgetEntries: [], todos: [], journalEntries: [], trackedApartments: [], timelineNotes: {}, bucketList: [], resources: [...defaultResources], guestbookEntries: [] }; } }

    </script>
</body>
</html>
