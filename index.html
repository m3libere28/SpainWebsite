<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Our Valencia Adventure - The Enhanced Journey!</title>
    <!-- UPDATED Favicon Concept (Orange Slice) -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><path fill='%23FFA500' d='M50 10 A40 40 0 0 1 50 90 A40 40 0 0 1 50 10 Z' /><path fill='%23FFC966' d='M50 15 A35 35 0 0 1 50 85 A35 35 0 0 1 50 15 Z'/><path stroke='%23FFF' stroke-width='3' fill='none' d='M50 15 V 85 M20 50 H 80 M29.2 29.2 L 70.8 70.8 M29.2 70.8 L 70.8 29.2'/><circle cx='50' cy='50' r='7' fill='%23FFF'/></svg>">

    <!-- Core CSS Dependencies -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Plugin CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@splidejs/splide@4.1.4/dist/css/splide.min.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
    <!-- Optional Leaflet.heat CSS (Uncomment if you use it actively) -->
    <!-- <link rel="stylesheet" href="https://unpkg.com/leaflet.heat@0.2.0/dist/leaflet-heat.css" /> -->
    <!-- NEW: GSAP for Animations -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/ScrollTrigger.min.js"></script>
    <!-- Tailwind Config -->
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        display: ['Poppins', 'sans-serif'],
                    },
                    colors: {
                        primary: { 50: '#F0F7FF', 100: '#E0EFFF', 200: '#B8DBFF', 300: '#8AC2FF', 400: '#5CA9FF', 500: '#2E90FF', 600: '#0073FF', 700: '#0059CC', 800: '#004299', 900: '#002B66' },
                        accent: { 50: '#FFF7E6', 100: '#FFE9BF', 200: '#FFD580', 300: '#FFC140', 400: '#FFAD00', 500: '#FF9900', 600: '#CC7A00', 700: '#995C00', 800: '#663D00', 900: '#331F00' },
                        vlcOrange: '#FFA500', // Added Valencia Orange
                    },
                    keyframes: {
                        float: { '0%, 100%': { transform: 'translateY(0)' }, '50%': { transform: 'translateY(-12px)' } },
                        pulseGlow: { '0%, 100%': { opacity: '1', boxShadow: '0 0 5px rgba(255, 255, 255, 0.2)' }, '50%': { opacity: '0.8', boxShadow: '0 0 15px rgba(255, 255, 255, 0.4)' } },
                        fadeIn: { 'from': { opacity: '0' }, 'to': { opacity: '1' } },
                        slideInUp: { 'from': { transform: 'translateY(30px)', opacity: '0' }, 'to': { transform: 'translateY(0)', opacity: '1' } },
                        fadeOut: { 'to': { opacity: '0', visibility: 'hidden' } },
                        highlight: { '0%': { backgroundColor: 'rgba(var(--accent-rgb), 0.3)' }, '100%': { backgroundColor: 'transparent' } }, // Use --accent-rgb
                    },
                    animation: {
                        float: 'float 3.5s ease-in-out infinite',
                        pulseGlow: 'pulseGlow 2.8s ease-in-out infinite',
                        fadeIn: 'fadeIn 0.6s ease-out forwards',
                        slideInUp: 'slideInUp 0.7s ease-out forwards',
                        fadeOut: 'fadeOut 0.5s ease-out forwards',
                        highlight: 'highlight 1s ease-out',
                    },
                    boxShadow: {
                        'card': '0 4px 15px rgba(0, 0, 0, 0.08)',
                        'card-hover': '0 8px 25px rgba(0, 0, 0, 0.12)',
                        'inner-soft': 'inset 0 2px 6px rgba(0,0,0,0.06)',
                    }
                }
            }
        }
    </script>
     <!-- Custom Styles (Includes Updated Modal CSS) -->
    <style>
        :root {
            --primary: #2E90FF;
            --primary-rgb: 46, 144, 255;
            --accent: #FF9900;
            --accent-rgb: 255, 153, 0;
            --vlcOrange: #FFA500; /* Define CSS variable */
        }
        /* --- START Styles Part 1/2 --- */
        html { scroll-behavior: smooth; } /* Ensure smooth scrolling */
        body { font-family: 'Inter', sans-serif; @apply bg-gray-50 dark:bg-gray-900 text-gray-800 dark:text-gray-200 min-h-screen transition-colors duration-300; overflow-x: hidden; }
        h1, h2, h3, h4, h5, h6 { font-family: 'Poppins', sans-serif; @apply font-semibold; }
        .glass { background: rgba(255, 255, 255, 0.7); backdrop-filter: blur(16px) saturate(180%); -webkit-backdrop-filter: blur(16px) saturate(180%); @apply border-b border-black/5 transition-colors duration-300; }
        .dark .glass { background: rgba(30, 41, 59, 0.7); @apply border-b border-white/10; }
        .card { @apply bg-white dark:bg-gray-800 rounded-xl shadow-card overflow-hidden transition-all duration-300 ease-out; opacity: 0; transform: translateY(20px); }
        .card:hover { transform: translateY(-6px) scale(1.02); @apply shadow-card-hover; }
        .card .card-image-zoom { @apply transition-transform duration-300 ease-out; }
        .card:hover .card-image-zoom { transform: scale(1.08); }
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { @apply bg-gray-100 dark:bg-gray-800; }
        ::-webkit-scrollbar-thumb { background: var(--primary); @apply rounded-full; }
        ::-webkit-scrollbar-thumb:hover { background: #0073FF; }
        .gsap-reveal { opacity: 0; transform: translateY(20px); }
        .gsap-reveal-fade { opacity: 0; }
        .gsap-reveal-scale { opacity: 0; transform: scale(0.95); }
        #loader.fade-out { animation: fadeOut 0.5s forwards; }
        .form-input, .form-select, .form-textarea { @apply block w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 focus:ring-2 focus:ring-primary-500/50 focus:border-primary-500 transition duration-200 ease-in-out text-sm shadow-sm; }
        label { @apply block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1; }
        .btn { @apply inline-flex items-center justify-center px-5 py-2 border border-transparent text-base font-medium rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-offset-2 transition-all duration-200 ease-in-out transform active:scale-[0.97]; }
        .btn-primary { @apply btn text-white bg-primary-600 hover:bg-primary-700 focus:ring-primary-500; }
        .btn-secondary { @apply btn text-gray-700 dark:text-gray-200 bg-white dark:bg-gray-700 border-gray-300 dark:border-gray-600 hover:bg-gray-50 dark:hover:bg-gray-600 focus:ring-primary-500; }
        .btn-accent { @apply btn text-white bg-accent-500 hover:bg-accent-600 focus:ring-accent-400; }
        .btn-sm { @apply px-3 py-1 text-sm; }
        .btn-danger { @apply btn bg-red-600 text-white hover:bg-red-700 focus:ring-red-500; }
        .btn-icon { @apply p-1 h-7 w-7 flex items-center justify-center text-xs rounded transition-colors duration-150 hover:bg-gray-100 dark:hover:bg-gray-700; }
        #heatmap-container { height: 450px; @apply rounded-lg z-0 shadow-inner-soft bg-gray-200 dark:bg-gray-700; }
        .splide__arrow { background: rgba(var(--primary-rgb), 0.8); backdrop-filter: blur(5px); @apply transition-all duration-200; }
        .splide__arrow:hover { background: rgba(var(--primary-rgb), 1); transform: scale(1.1); }
        .splide__arrow svg { fill: white; }
        .splide__pagination__page.is-active { background: var(--primary); transform: scale(1.2); }
        .splide__pagination__page { @apply transition-all duration-200 bg-gray-300 dark:bg-gray-600; }
        .timeline-wrapper { position: relative; }

        .timeline-line { @apply absolute left-1/2 transform -translate-x-1/2 h-full w-[3px] bg-primary-200 dark:bg-primary-700/50 top-6 bottom-6 rounded-full; }
        .timeline-item { @apply relative mb-12; }
        .timeline-dot { @apply absolute left-1/2 top-6 transform -translate-x-1/2 w-6 h-6 bg-primary-500 rounded-full border-4 border-white dark:border-gray-800 z-10 flex items-center justify-center text-xs text-white shadow-md transition-colors duration-300; }
        .timeline-dot.future { @apply bg-gray-400 dark:bg-gray-500; }
        .timeline-dot.final { @apply ring-4 ring-accent-500/30 bg-accent-500 shadow-lg scale-110; }
        .timeline-header { @apply cursor-pointer transition-colors duration-200 hover:text-primary-700 dark:hover:text-primary-300 p-1 rounded; }
        .timeline-header .indicator { @apply ml-2 text-xs opacity-70 transition-transform duration-300 ease-out inline-block; }
        .timeline-header .indicator.rotate-180 { @apply transform rotate-180; }
        .timeline-content { @apply p-6 bg-gray-50 dark:bg-gray-700/60 rounded-lg shadow-md transition-colors duration-300; }
        .timeline-content.future { @apply bg-gray-50 dark:bg-gray-700 opacity-90; }
        .timeline-content.final { @apply border-l-4 border-accent-500 bg-accent-50 dark:bg-accent-900/20; }
        .timeline-details { @apply mt-4 pt-4 border-t border-gray-200 dark:border-gray-600 overflow-hidden transition-all duration-500 ease-in-out max-h-0 opacity-0; }
        .timeline-details.expanded { @apply max-h-[1000px] opacity-100; }
        .timeline-details ul { @apply list-none pl-1 space-y-2; }
        .timeline-details li { @apply flex items-start text-sm opacity-0; }
        .timeline-details.expanded li { animation: fadeIn 0.5s ease-out forwards; }
        .timeline-details li i { @apply mr-3 mt-1 w-4 text-center text-primary-500 dark:text-primary-400 flex-shrink-0; }
        .timeline-details li.future-task { @apply opacity-70; }
        .timeline-notes-container { @apply mt-4 border-t border-gray-200 dark:border-gray-600 pt-3 space-y-2; }
        .timeline-note { @apply text-sm p-2 bg-white dark:bg-gray-600 rounded shadow-sm transition-opacity duration-300; opacity: 0; }
        .add-note-form { @apply mt-2 space-y-2; }
        .nav-link.active, .mobile-nav-link.active { @apply text-primary-600 dark:text-primary-400 font-semibold; }
        .nav-link, .mobile-nav-link { @apply relative; padding-bottom: 4px; }
        .nav-link::after, .mobile-nav-link::after { content: ''; position: absolute; bottom: 0; left: 50%; transform: translateX(-50%); width: 0; height: 2px; background-color: var(--primary); transition: width 0.3s ease-out; }
        .nav-link:hover::after, .mobile-nav-link:hover::after, .nav-link.active::after, .mobile-nav-link.active::after { width: 70%; }
        .nav-link:not(.active):hover::after, .mobile-nav-link:not(.active):hover::after { opacity: 0.6; }

        /* --- UPDATED Modal Styling & Animation --- */
        .modal {
            @apply fixed inset-0 z-[999] flex items-center justify-center p-4 bg-black/70 backdrop-blur-sm transition-opacity duration-300 ease-out;
            opacity: 0; pointer-events: none; /* Initial hidden state */
        }
        .modal.open { opacity: 1; pointer-events: auto; } /* State when open */

        .modal-content {
            @apply bg-white dark:bg-gray-800 rounded-lg shadow-xl max-w-2xl w-full max-h-[90vh] overflow-y-auto p-6 sm:p-8 relative transition-all duration-300 ease-out scale-95 opacity-0 outline-none; /* Added outline-none for focused state */
             /* Custom scrollbar styling for modal */
             scrollbar-width: thin; /* Firefox */
             scrollbar-color: var(--primary) transparent; /* Firefox */
        }
        .modal.open .modal-content { transform: scale(1); opacity: 1; } /* Animated state when open */

        .modal-close { @apply absolute top-3 right-3 sm:top-4 sm:right-4 text-gray-500 hover:text-gray-800 dark:text-gray-400 dark:hover:text-white text-3xl leading-none cursor-pointer transition-colors duration-150 z-10 rounded-full bg-white/50 dark:bg-gray-700/50 hover:bg-gray-100 dark:hover:bg-gray-600 w-8 h-8 flex items-center justify-center; }
         .modal-close:focus { @apply ring-2 ring-primary-500 ring-offset-2 ring-offset-white dark:ring-offset-gray-800 outline-none; }
         /* Style for image inside modal */
        .modal-image { @apply w-full h-48 sm:h-64 object-cover rounded-lg mb-6 shadow-md bg-gray-200 dark:bg-gray-700; } /* Added bg placeholder */
        .modal-body { @apply space-y-4 text-sm leading-relaxed; }
         .modal-body dt { @apply font-semibold text-gray-800 dark:text-gray-100 w-28 inline-block flex-shrink-0 mr-2; } /* Label styling */
         .modal-body dd { @apply inline text-gray-600 dark:text-gray-300; } /* Value styling */
         .modal-body .detail-item { @apply flex items-start mb-2; } /* For label/value pairs */
         .modal-body .detail-item:last-child { @apply mb-0; }
         .modal-body .rating-value { @apply text-yellow-500 font-semibold; } /* Specific styling for rating value */
         .modal-body ul { @apply list-disc list-inside space-y-1 pl-2 text-gray-600 dark:text-gray-300; } /* List styling */
        .modal-actions { @apply mt-8 pt-6 border-t dark:border-gray-600 text-center space-x-3; }
        /* --- END Modal Styles --- */

        .table-wrapper { @apply overflow-x-auto rounded-lg border border-gray-200 dark:border-gray-700 shadow-sm; }
        .data-table { @apply w-full text-sm text-left text-gray-600 dark:text-gray-400; }
        .data-table thead { @apply text-xs text-gray-700 uppercase bg-gray-50 dark:bg-gray-700 dark:text-gray-300 sticky top-0; }
        .data-table th, .data-table td { @apply px-4 py-3; }
        .data-table tbody tr { @apply bg-white dark:bg-gray-800 border-b dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-700/50 transition-colors duration-150; }
        .data-table tbody tr:last-child { @apply border-b-0; }
        .data-table tbody tr.highlight-flash { animation: highlight 1s ease-out; }
        [data-gsap-stagger] > * { opacity: 0; transform: translateY(15px); }
        /* Simple scrollbar for modal content */
         .modal-content::-webkit-scrollbar { width: 6px; }
         .modal-content::-webkit-scrollbar-track { background: transparent; }
         .modal-content::-webkit-scrollbar-thumb { @apply bg-gray-300 dark:bg-gray-600 rounded; }

        /* ADDED: Cursor pointer for clickable school cards */
        .school-card, .public-school-card { @apply cursor-pointer; }

        /* General thin scrollbar utility */
        .thin-scrollbar { scrollbar-width: thin; scrollbar-color: var(--primary) transparent; }
        .thin-scrollbar::-webkit-scrollbar { width: 6px; }
        .thin-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .thin-scrollbar::-webkit-scrollbar-thumb { @apply bg-gray-300 dark:bg-gray-600 rounded; }
    </style>
</head>
<body class="antialiased">

    <!-- Loading Screen -->
    <div id="loader" class="fixed inset-0 z-[1000] flex flex-col items-center justify-center bg-gradient-to-br from-primary-500 to-accent-500 text-white">
        <div class="text-center gsap-reveal-fade" data-duration="1">
            <h1 class="text-4xl font-bold mb-8 animation-pulseGlow">Our Valencia Adventure</h1>
            <div class="relative">
                <i class="fas fa-plane-departure text-7xl text-white animation-float"></i>
                 <div class="absolute w-24 h-2 bg-white/20 -bottom-2 left-1/2 transform -translate-x-1/2 rounded-full blur-lg"></div>
            </div>
            <p class="mt-6 text-lg">Preparing for takeoff...</p>
        </div>
    </div>

    <!-- Navigation -->
    <nav class="fixed top-0 left-0 right-0 z-[500] glass">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-16">
                <!-- Logo -->
                <a href="#home" class="flex items-center group focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-transparent dark:focus:ring-offset-gray-800 focus:ring-primary-500 rounded-md p-1 -ml-1">
                    <svg class="h-8 w-8 text-vlcOrange group-hover:animate-pulse mr-2 transition-transform duration-200 group-hover:scale-110" viewBox="0 0 100 100" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
                         <path d="M50 10 A40 40 0 0 1 50 90 A40 40 0 0 1 50 10 Z" />
                         <path fill="#FFC966" d="M50 15 A35 35 0 0 1 50 85 A35 35 0 0 1 50 15 Z"/>
                         <path stroke="#FFF" stroke-width="5" fill="none" d="M50 15 V 85 M20 50 H 80 M29.2 29.2 L 70.8 70.8 M29.2 70.8 L 70.8 29.2"/>
                         <circle cx="50" cy="50" r="8" fill="#FFF"/>
                    </svg>
                    <span class="text-xl font-bold font-display text-primary-700 dark:text-primary-300 group-hover:text-primary-900 dark:group-hover:text-primary-100 transition-colors duration-200 tracking-tight">Valencia<span class="font-normal text-accent-600 dark:text-accent-400">Bound</span></span>
                </a>
                <!-- Desktop Links -->
                <div class="hidden md:flex items-center space-x-1 lg:space-x-2">
                    <a href="#home" class="nav-link px-3 py-2 rounded-md text-sm font-medium text-gray-700 dark:text-gray-300 hover:text-primary-600 dark:hover:text-primary-400 transition-colors duration-200">Home</a>
                    <a href="#rentals" class="nav-link px-3 py-2 rounded-md text-sm font-medium text-gray-700 dark:text-gray-300 hover:text-primary-600 dark:hover:text-primary-400 transition-colors duration-200">Rentals</a>
                    <a href="#timeline" class="nav-link px-3 py-2 rounded-md text-sm font-medium text-gray-700 dark:text-gray-300 hover:text-primary-600 dark:hover:text-primary-400 transition-colors duration-200">Timeline</a>
                    <a href="#weather" class="nav-link px-3 py-2 rounded-md text-sm font-medium text-gray-700 dark:text-gray-300 hover:text-primary-600 dark:hover:text-primary-400 transition-colors duration-200">Weather</a>
                    <a href="#schools" class="nav-link px-3 py-2 rounded-md text-sm font-medium text-gray-700 dark:text-gray-300 hover:text-primary-600 dark:hover:text-primary-400 transition-colors duration-200">Int'l Schools</a>
                    <a href="#public-schools" class="nav-link px-3 py-2 rounded-md text-sm font-medium text-gray-700 dark:text-gray-300 hover:text-primary-600 dark:hover:text-primary-400 transition-colors duration-200">Public Schools</a>
                    <a href="#planning" class="nav-link px-3 py-2 rounded-md text-sm font-medium text-gray-700 dark:text-gray-300 hover:text-primary-600 dark:hover:text-primary-400 transition-colors duration-200">Planning</a>
                    <a href="#more-tools" class="nav-link px-3 py-2 rounded-md text-sm font-medium text-gray-700 dark:text-gray-300 hover:text-primary-600 dark:hover:text-primary-400 transition-colors duration-200">Tools</a>
                </div>
                 <!-- Theme Toggle (Desktop) -->
                 <div class="hidden md:block">
                     <button id="theme-toggle-desktop" aria-label="Toggle Dark Mode" class="p-2 rounded-full text-gray-600 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-gray-700 transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500">
                         <i class="fas fa-sun text-lg"></i> <!-- Icon updated by JS -->
                     </button>
                 </div>
                <!-- Mobile Menu Buttons -->
                 <div class="md:hidden flex items-center">
                     <button id="theme-toggle-mobile" aria-label="Toggle Dark Mode" class="p-2 mr-2 rounded-full text-gray-600 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-gray-700 transition-all duration-200 focus:outline-none focus:ring-1 focus:ring-primary-500">
                         <i class="fas fa-sun text-lg"></i> <!-- Icon updated by JS -->
                     </button>
                     <button id="mobile-menu-button" aria-label="Open Menu" class="p-2 rounded-md text-gray-600 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-gray-700 transition-colors duration-200 focus:outline-none focus:ring-1 focus:ring-primary-500">
                         <i class="fas fa-bars text-xl"></i>
                     </button>
                 </div>
            </div>
        </div>
    </nav>

    <!-- Mobile Navigation Menu -->
    <div id="mobile-menu" class="hidden fixed inset-0 z-[600] md:hidden" role="dialog" aria-modal="true">
        <!-- Background backdrop -->
        <div class="fixed inset-0 bg-black/60 backdrop-blur-sm transition-opacity duration-300 ease-in-out opacity-0" aria-hidden="true" id="mobile-menu-overlay"></div>
        <!-- Mobile menu panel -->
        <div id="mobile-menu-panel" class="fixed top-0 right-0 bottom-0 w-64 bg-white dark:bg-gray-800 p-5 shadow-lg transition-transform duration-300 ease-in-out transform translate-x-full">
            <div class="flex justify-between items-center mb-8">
                <span class="text-lg font-semibold font-display text-primary-600 dark:text-primary-400">Menu</span>
                <button id="mobile-menu-close-button" aria-label="Close Menu" class="p-2 -mr-2 rounded-md text-gray-600 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-gray-700 transition-colors duration-200">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <!-- Stagger container for GSAP -->
            <div class="flex flex-col space-y-3" data-gsap-stagger>
                <a href="#home" class="mobile-nav-link block px-3 py-2 rounded-md text-base font-medium text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors duration-150">Home</a>
                <a href="#rentals" class="mobile-nav-link block px-3 py-2 rounded-md text-base font-medium text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors duration-150">Rentals</a>
                <a href="#timeline" class="mobile-nav-link block px-3 py-2 rounded-md text-base font-medium text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors duration-150">Timeline</a>
                <a href="#weather" class="mobile-nav-link block px-3 py-2 rounded-md text-base font-medium text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors duration-150">Weather</a>
                <a href="#schools" class="mobile-nav-link block px-3 py-2 rounded-md text-base font-medium text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors duration-150">Int'l Schools</a>
                <a href="#public-schools" class="mobile-nav-link block px-3 py-2 rounded-md text-base font-medium text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors duration-150">Public Schools</a>
                <a href="#planning" class="mobile-nav-link block px-3 py-2 rounded-md text-base font-medium text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors duration-150">Planning</a>
                <a href="#more-tools" class="mobile-nav-link block px-3 py-2 rounded-md text-base font-medium text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors duration-150">Tools</a>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <main class="pt-16"> <!-- Ensure padding equals nav height -->

        <!-- Hero Section -->
        <section id="home" class="relative min-h-[calc(100vh-4rem)] flex items-center justify-center text-white overflow-hidden">
            <div class="absolute inset-0 z-0">
                 <img src="dji_mimo_20241209_115306_0_1733760145853_photo.jpg"
                      alt="Panoramic view of Valencia, Spain skyline at sunset"
                      class="object-cover w-full h-full opacity-80 dark:opacity-60 bg-gray-700"> <!-- Added placeholder bg -->
                 <div class="absolute inset-0 bg-gradient-to-t from-black/50 via-black/20 to-transparent"></div>
            </div>
            <div class="relative z-10 max-w-4xl mx-auto px-4 py-24 text-center">
                <h1 class="text-5xl md:text-7xl font-bold font-display mb-6 drop-shadow-lg gsap-reveal" data-delay="0.1">Our Valencia Adventure</h1>
                <p class="text-xl md:text-2xl mb-10 opacity-90 drop-shadow-md gsap-reveal" data-delay="0.3">Counting down the moments until our new chapter begins in Spain!</p>
                <!-- Countdown Timer -->
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 md:gap-6 max-w-3xl mx-auto gsap-reveal" data-delay="0.5">
                    <div class="countdown-unit bg-white/20 dark:bg-black/30 p-4 rounded-lg shadow-md backdrop-blur-sm transition-shadow hover:shadow-lg">
                        <div class="text-4xl lg:text-5xl font-bold font-display" id="days">--</div>
                        <div class="text-sm uppercase tracking-wider opacity-80">Days</div>
                    </div>
                    <div class="countdown-unit bg-white/20 dark:bg-black/30 p-4 rounded-lg shadow-md backdrop-blur-sm transition-shadow hover:shadow-lg">
                        <div class="text-4xl lg:text-5xl font-bold font-display" id="hours">--</div>
                        <div class="text-sm uppercase tracking-wider opacity-80">Hours</div>
                    </div>
                    <div class="countdown-unit bg-white/20 dark:bg-black/30 p-4 rounded-lg shadow-md backdrop-blur-sm transition-shadow hover:shadow-lg">
                        <div class="text-4xl lg:text-5xl font-bold font-display" id="minutes">--</div>
                        <div class="text-sm uppercase tracking-wider opacity-80">Minutes</div>
                    </div>
                    <div class="countdown-unit bg-white/20 dark:bg-black/30 p-4 rounded-lg shadow-md backdrop-blur-sm transition-shadow hover:shadow-lg">
                        <div class="text-4xl lg:text-5xl font-bold font-display" id="seconds">--</div>
                        <div class="text-sm uppercase tracking-wider opacity-80">Seconds</div>
                    </div>
                </div>
                 <div class="mt-12 gsap-reveal" data-delay="0.7">
                     <a href="#timeline" class="btn-accent py-3 px-8 text-lg transform hover:scale-105 active:scale-100">
                         Follow Our Journey <i class="fas fa-arrow-right ml-2 transition-transform duration-200 group-hover:translate-x-1"></i>
                     </a>
                 </div>
            </div>
        </section> <!-- End Hero (#home) -->

        <!-- Rentals Section -->
        <section id="rentals" class="py-20 bg-gray-100 dark:bg-gray-900 overflow-hidden">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <h2 class="text-3xl md:text-4xl font-bold text-center mb-6 gsap-reveal">Finding Our Valencian Home</h2>
                <p class="text-lg text-center text-gray-600 dark:text-gray-400 mb-12 max-w-3xl mx-auto gsap-reveal" data-delay="0.1">Exploring potential apartments and neighborhoods for our new life.</p>

                <!-- Filters -->
                <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md mb-12 gsap-reveal" data-delay="0.2">
                    <h3 class="text-xl font-semibold mb-5">Filter Listings</h3>
                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-5 items-end">
                        <div>
                            <label for="area-filter" class="text-sm">Area / Neighborhood</label>
                            <select id="area-filter" class="form-select w-full">
                                <option value="">All Areas</option>
                                <option value="Ciutat Vella">Ciutat Vella</option>
                                <option value="Eixample">Eixample</option>
                                <option value="Russafa">Russafa</option>
                                <option value="Extramurs">Extramurs</option>
                                <option value="Benimaclet">Benimaclet</option>
                                <option value="El Cabanyal">El Cabanyal</option>
                            </select>
                        </div>
                        <div>
                            <label for="price-filter" class="text-sm">Max Price (€/month)</label>
                            <select id="price-filter" class="form-select w-full">
                                <option value="">Any Price</option>
                                <option value="1000">Up to 1000</option>
                                <option value="1500">Up to 1500</option>
                                <option value="2000">Up to 2000</option>
                                <option value="2500">Up to 2500</option>
                                <option value="2500+">2500+</option>
                            </select>
                        </div>
                        <div>
                             <label for="beds-filter" class="text-sm">Min. Bedrooms</label>
                            <select id="beds-filter" class="form-select w-full">
                                <option value="">Any</option>
                                <option value="1">1+</option>
                                <option value="2">2+</option>
                                <option value="3">3+</option>
                                <option value="4">4+</option>
                            </select>
                        </div>
                        <button class="btn-primary w-full sm:w-auto lg:w-full mt-4 sm:mt-0" onclick="filterProperties()">
                            <i class="fas fa-filter mr-2 text-xs"></i>Filter Results
                        </button>
                    </div>
                </div>

                <!-- Property Grid -->
                <div id="property-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8 mb-16" data-gsap-stagger>
                    <!-- Example Property Card 1 -->
                    <div class="card property-card" data-area="Eixample" data-price="1450" data-beds="2">
                        <div class="relative overflow-hidden">
                            <img src="https://images.unsplash.com/photo-1560448204-e02f11c3d0e2?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=870&q=80" alt="Modern Apartment" class="w-full h-56 object-cover card-image-zoom bg-gray-200">
                             <div class="absolute top-4 right-4 bg-primary-600 text-white px-3 py-1 rounded-full text-xs font-semibold shadow-md">€1,450/mo</div>
                             <div class="absolute bottom-0 left-0 right-0 p-4 bg-gradient-to-t from-black/60 to-transparent">
                                 <h3 class="text-xl font-semibold text-white truncate">Chic Apartment in Eixample</h3>
                             </div>
                        </div>
                        <div class="p-6">
                            <div class="flex items-center text-gray-600 dark:text-gray-400 mb-4 text-sm">
                                <i class="fas fa-map-marker-alt mr-2 text-primary-500 text-base"></i>
                                <span>Eixample, Valencia</span>
                            </div>
                            <div class="flex justify-between text-sm text-gray-700 dark:text-gray-300 border-t dark:border-gray-600 pt-4 mt-4">
                                <span><i class="fas fa-bed mr-1.5 text-gray-400 dark:text-gray-500"></i> 2 Beds</span>
                                <span><i class="fas fa-bath mr-1.5 text-gray-400 dark:text-gray-500"></i> 2 Baths</span>
                                <span><i class="fas fa-ruler-combined mr-1.5 text-gray-400 dark:text-gray-500"></i> 90m²</span>
                            </div>
                            <a href="#" class="btn-secondary btn-sm mt-5 w-full text-center block">View Details</a>
                        </div>
                    </div>
                    <!-- Example Property Card 2 -->
                    <div class="card property-card" data-area="Russafa" data-price="1100" data-beds="1">
                       <div class="relative overflow-hidden">
                            <img src="https://images.unsplash.com/photo-1512917774080-9991f1c4c750?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=870&q=80" alt="Cosy Flat" class="w-full h-56 object-cover card-image-zoom bg-gray-200">
                             <div class="absolute top-4 right-4 bg-primary-600 text-white px-3 py-1 rounded-full text-xs font-semibold shadow-md">€1,100/mo</div>
                             <div class="absolute bottom-0 left-0 right-0 p-4 bg-gradient-to-t from-black/60 to-transparent">
                                 <h3 class="text-xl font-semibold text-white truncate">Cosy Flat in Trendy Russafa</h3>
                             </div>
                        </div>
                        <div class="p-6">
                            <div class="flex items-center text-gray-600 dark:text-gray-400 mb-4 text-sm">
                                <i class="fas fa-map-marker-alt mr-2 text-primary-500 text-base"></i>
                                <span>Russafa, Valencia</span>
                            </div>
                             <div class="flex justify-between text-sm text-gray-700 dark:text-gray-300 border-t dark:border-gray-600 pt-4 mt-4">
                                <span><i class="fas fa-bed mr-1.5 text-gray-400 dark:text-gray-500"></i> 1 Bed</span>
                                <span><i class="fas fa-bath mr-1.5 text-gray-400 dark:text-gray-500"></i> 1 Bath</span>
                                <span><i class="fas fa-ruler-combined mr-1.5 text-gray-400 dark:text-gray-500"></i> 65m²</span>
                            </div>
                             <a href="#" class="btn-secondary btn-sm mt-5 w-full text-center block">View Details</a>
                        </div>
                    </div>
                    <!-- Example Property Card 3 -->
                     <div class="card property-card" data-area="El Cabanyal" data-price="1600" data-beds="3">
                        <div class="relative overflow-hidden">
                            <img src="https://images.unsplash.com/photo-1493809842364-78817add7ffb?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=870&q=80" alt="Beachside Home" class="w-full h-56 object-cover card-image-zoom bg-gray-200">
                            <div class="absolute top-4 right-4 bg-primary-600 text-white px-3 py-1 rounded-full text-xs font-semibold shadow-md">€1,600/mo</div>
                             <div class="absolute bottom-0 left-0 right-0 p-4 bg-gradient-to-t from-black/60 to-transparent">
                                 <h3 class="text-xl font-semibold text-white truncate">Spacious Home near Beach</h3>
                             </div>
                        </div>
                        <div class="p-6">
                             <div class="flex items-center text-gray-600 dark:text-gray-400 mb-4 text-sm">
                                <i class="fas fa-map-marker-alt mr-2 text-primary-500 text-base"></i>
                                <span>El Cabanyal, Valencia</span>
                            </div>
                             <div class="flex justify-between text-sm text-gray-700 dark:text-gray-300 border-t dark:border-gray-600 pt-4 mt-4">
                                <span><i class="fas fa-bed mr-1.5 text-gray-400 dark:text-gray-500"></i> 3 Beds</span>
                                <span><i class="fas fa-bath mr-1.5 text-gray-400 dark:text-gray-500"></i> 2 Baths</span>
                                <span><i class="fas fa-ruler-combined mr-1.5 text-gray-400 dark:text-gray-500"></i> 110m²</span>
                            </div>
                             <a href="#" class="btn-secondary btn-sm mt-5 w-full text-center block">View Details</a>
                        </div>
                    </div>

                     <!-- No Results Placeholder -->
                     <div id="no-results" class="hidden md:col-span-2 lg:col-span-3 text-center py-16 text-gray-500 dark:text-gray-400 gsap-reveal-fade">
                         <i class="fas fa-house-damage text-5xl mb-5 text-gray-400"></i>
                         <p class="text-lg">No properties match your current filters.</p>
                         <p class="text-sm mt-1">Try adjusting your search criteria!</p>
                     </div>
                </div>

                <!-- Apartment Tracker -->
                <div id="apartment-tracker" class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg gsap-reveal">
                    <h3 class="text-2xl font-semibold mb-6 flex items-center"><i class="fas fa-clipboard-list mr-3 text-accent-500"></i>Tracked Apartments</h3>
                    <form id="apartment-form" class="grid grid-cols-1 md:grid-cols-2 gap-5 mb-8">
                        <div>
                            <label for="apt-location">Location / Ref</label>
                            <input type="text" id="apt-location" class="form-input" required placeholder="e.g., Russafa near Park, Ref #123">
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label for="apt-size">Size (m²)</label>
                                <input type="number" id="apt-size" class="form-input" placeholder="e.g., 85" min="10">
                            </div>
                            <div>
                                <label for="apt-price">Price (€/mo)</label>
                                <input type="number" id="apt-price" class="form-input" required placeholder="e.g., 1200" min="100" step="10">
                            </div>
                        </div>
                        <div>
                            <label for="apt-link">Listing URL</label>
                            <input type="url" id="apt-link" class="form-input" placeholder="https://...">
                        </div>
                        <div>
                            <label for="apt-notes">Notes / Status</label>
                            <textarea id="apt-notes" rows="2" class="form-textarea" placeholder="Pros, cons, contacted date..."></textarea>
                        </div>
                        <div class="md:col-span-2 mt-2">
                            <button type="submit" class="btn-accent w-full md:w-auto transform hover:scale-105 active:scale-100">
                                <i class="fas fa-plus mr-2 text-xs"></i>Add Apartment to Tracker
                            </button>
                        </div>
                    </form>

                    <h4 class="text-lg font-semibold mb-4 mt-8 border-t dark:border-gray-700 pt-5">Saved Listings</h4>
                    <div class="table-wrapper max-h-[400px] overflow-y-auto thin-scrollbar">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Location/Ref</th>
                                    <th>Price (€)</th>
                                    <th>Size (m²)</th>
                                    <th>Link</th>
                                    <th>Notes</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="apartment-table-body">
                                <tr><td colspan="6" class="text-center py-4 text-sm text-gray-500 dark:text-gray-400">No apartments tracked yet.</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div><!-- End Apartment Tracker -->
            </div>
        </section> <!-- End Rentals (#rentals) -->

        <!-- Timeline Section -->
        <section id="timeline" class="py-24 bg-white dark:bg-gray-800 overflow-hidden">
            <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8">
                <h2 class="text-3xl md:text-4xl font-bold text-center mb-16 gsap-reveal">🇺🇸✈️ Our Journey Timeline 🇪🇸</h2>
                <div class="timeline-wrapper">
                    <div class="timeline-line gsap-reveal"></div>
                    <div class="space-y-12" id="timeline-items-container">
                        <!-- Item 1 -->
                        <div class="timeline-item gsap-reveal" data-timeline-id="prep-research">
                            <div class="flex flex-col md:flex-row items-start md:items-center">
                                <div class="md:w-1/2 md:pr-8 text-center md:text-right mb-4 md:mb-0">
                                    <div class="timeline-header" onclick="toggleTimelineDetails('prep-research')">
                                        <h3 class="text-xl font-semibold mb-1">✅ Prepping & Research</h3>
                                        <p class="text-sm text-gray-500 dark:text-gray-400">March–May 2025<i class="fas fa-chevron-down indicator"></i></p>
                                    </div>
                                </div>
                                <div class="timeline-dot gsap-reveal-scale" data-delay="0.1"><i class="fas fa-clipboard-check"></i></div>
                                <div class="md:w-1/2 md:pl-8">
                                    <div class="timeline-content gsap-reveal" data-delay="0.2">
                                        <p class="mb-4 italic text-sm text-gray-600 dark:text-gray-400">Laying the groundwork...</p>
                                        <div class="timeline-details" id="details-prep-research"><ul>
                                            <li><i class="fas fa-flag-checkered"></i>Finalize decision to move</li>
                                            <li><i class="fas fa-map-marked-alt"></i>Research cities, schools, neighborhoods</li>
                                            <li><i class="fas fa-piggy-bank"></i>Begin budgeting & savings plan</li>
                                            <li><i class="fas fa-file-contract"></i>Review visa/residency options</li>
                                            <li><i class="fas fa-school"></i>Look into international schools</li>
                                            <li><i class="fas fa-folder-open"></i>Request school/immunization records</li>
                                        </ul></div>
                                        <div class="timeline-notes-container"><div class="notes-display space-y-2 mb-2"></div><button onclick="toggleNoteForm('prep-research')" class="btn-secondary btn-sm"><i class="fas fa-plus mr-1"></i> Note</button><form class="add-note-form hidden" onsubmit="addTimelineNote(event, 'prep-research')"><textarea class="form-textarea text-sm" rows="2" placeholder="Add a quick note..."></textarea><div class="flex space-x-2 mt-1"><button type="submit" class="btn-primary btn-sm">Save</button><button type="button" onclick="toggleNoteForm('prep-research')" class="btn-secondary btn-sm">Cancel</button></div></form></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <!-- Item 2 (Reversed) -->
                        <div class="timeline-item gsap-reveal" data-timeline-id="legal-logistics">
                            <div class="flex flex-col md:flex-row-reverse items-start md:items-center">
                                <div class="md:w-1/2 md:pl-8 text-center md:text-left mb-4 md:mb-0">
                                    <div class="timeline-header" onclick="toggleTimelineDetails('legal-logistics')">
                                        <h3 class="text-xl font-semibold mb-1">🛂 Legal & Logistics</h3>
                                        <p class="text-sm text-gray-500 dark:text-gray-400">June–August 2025<i class="fas fa-chevron-down indicator"></i></p>
                                    </div>
                                </div>
                                <div class="timeline-dot gsap-reveal-scale" data-delay="0.1"><i class="fas fa-passport"></i></div>
                                <div class="md:w-1/2 md:pr-8">
                                    <div class="timeline-content gsap-reveal" data-delay="0.2">
                                         <p class="mb-4 italic text-sm text-gray-600 dark:text-gray-400">Navigating the paperwork...</p>
                                         <div class="timeline-details" id="details-legal-logistics"><ul>
                                             <li><i class="fas fa-file-signature"></i>Start visa paperwork (NLV/DNV)</li>
                                             <li><i class="fas fa-calendar-alt"></i>Make consulate appointments</li>
                                             <li><i class="fas fa-address-card"></i>Renew passports (if needed)</li>
                                             <li><i class="fas fa-fingerprint"></i>Get FBI checks & apostilles</li>
                                             <li><i class="fas fa-plane-departure"></i>Book optional Spain trial trip</li>
                                         </ul></div>
                                        <div class="timeline-notes-container"><div class="notes-display space-y-2 mb-2"></div><button onclick="toggleNoteForm('legal-logistics')" class="btn-secondary btn-sm"><i class="fas fa-plus mr-1"></i> Note</button><form class="add-note-form hidden" onsubmit="addTimelineNote(event, 'legal-logistics')"><textarea class="form-textarea text-sm" rows="2" placeholder="Add a quick note..."></textarea><div class="flex space-x-2 mt-1"><button type="submit" class="btn-primary btn-sm">Save</button><button type="button" onclick="toggleNoteForm('legal-logistics')" class="btn-secondary btn-sm">Cancel</button></div></form></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <!-- Item 3 -->
                         <div class="timeline-item gsap-reveal" data-timeline-id="docs-downsizing">
                            <div class="flex flex-col md:flex-row items-start md:items-center">
                                <div class="md:w-1/2 md:pr-8 text-center md:text-right mb-4 md:mb-0">
                                    <div class="timeline-header" onclick="toggleTimelineDetails('docs-downsizing')">
                                        <h3 class="text-xl font-semibold mb-1">📦 Docs & Downsizing</h3>
                                        <p class="text-sm text-gray-500 dark:text-gray-400">Sept–Nov 2025<i class="fas fa-chevron-down indicator"></i></p>
                                    </div>
                                </div>
                                <div class="timeline-dot gsap-reveal-scale" data-delay="0.1"><i class="fas fa-box-open"></i></div>
                                <div class="md:w-1/2 md:pl-8">
                                    <div class="timeline-content gsap-reveal" data-delay="0.2">
                                        <p class="mb-4 italic text-sm text-gray-600 dark:text-gray-400">Translating and decluttering...</p>
                                         <div class="timeline-details" id="details-docs-downsizing"><ul>
                                             <li><i class="fas fa-language"></i>Translate required documents</li>
                                             <li><i class="fas fa-box"></i>Begin decluttering/selling items</li>
                                             <li><i class="fas fa-home"></i>List car/home for sale/rent</li>
                                             <li><i class="fas fa-truck-loading"></i>Research shipping/storage</li>
                                             <li><i class="fas fa-university"></i>Contact banks, financial planning</li>
                                         </ul></div>
                                        <div class="timeline-notes-container"><div class="notes-display space-y-2 mb-2"></div><button onclick="toggleNoteForm('docs-downsizing')" class="btn-secondary btn-sm"><i class="fas fa-plus mr-1"></i> Note</button><form class="add-note-form hidden" onsubmit="addTimelineNote(event, 'docs-downsizing')"><textarea class="form-textarea text-sm" rows="2" placeholder="Add a quick note..."></textarea><div class="flex space-x-2 mt-1"><button type="submit" class="btn-primary btn-sm">Save</button><button type="button" onclick="toggleNoteForm('docs-downsizing')" class="btn-secondary btn-sm">Cancel</button></div></form></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <!-- Item 4 (Reversed) -->
                        <div class="timeline-item gsap-reveal" data-timeline-id="health-housing">
                            <div class="flex flex-col md:flex-row-reverse items-start md:items-center">
                                <div class="md:w-1/2 md:pl-8 text-center md:text-left mb-4 md:mb-0">
                                    <div class="timeline-header" onclick="toggleTimelineDetails('health-housing')">
                                        <h3 class="text-xl font-semibold mb-1">🩺 Health & Housing</h3>
                                        <p class="text-sm text-gray-500 dark:text-gray-400">Dec 2025–Feb 2026<i class="fas fa-chevron-down indicator"></i></p>
                                    </div>
                                </div>
                                <div class="timeline-dot gsap-reveal-scale" data-delay="0.1"><i class="fas fa-heartbeat"></i></div>
                                <div class="md:w-1/2 md:pr-8">
                                    <div class="timeline-content gsap-reveal" data-delay="0.2">
                                        <p class="mb-4 italic text-sm text-gray-600 dark:text-gray-400">Medical checks & finding a base...</p>
                                         <div class="timeline-details" id="details-health-housing"><ul>
                                             <li><i class="fas fa-user-md"></i>Get medical/dental checkups</li>
                                             <li><i class="fas fa-notes-medical"></i>Collect medical records/scripts</li>
                                             <li><i class="fas fa-shield-alt"></i>Look into health insurance</li>
                                             <li><i class="fas fa-key"></i>Secure housing in Valencia</li>
                                             <li><i class="fas fa-stamp"></i>Submit visa application</li>
                                         </ul></div>
                                        <div class="timeline-notes-container"><div class="notes-display space-y-2 mb-2"></div><button onclick="toggleNoteForm('health-housing')" class="btn-secondary btn-sm"><i class="fas fa-plus mr-1"></i> Note</button><form class="add-note-form hidden" onsubmit="addTimelineNote(event, 'health-housing')"><textarea class="form-textarea text-sm" rows="2" placeholder="Add a quick note..."></textarea><div class="flex space-x-2 mt-1"><button type="submit" class="btn-primary btn-sm">Save</button><button type="button" onclick="toggleNoteForm('health-housing')" class="btn-secondary btn-sm">Cancel</button></div></form></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <!-- Item 5 -->
                        <div class="timeline-item future-item gsap-reveal" data-timeline-id="schooling-systems">
                            <div class="flex flex-col md:flex-row items-start md:items-center">
                                <div class="md:w-1/2 md:pr-8 text-center md:text-right mb-4 md:mb-0">
                                     <div class="timeline-header" onclick="toggleTimelineDetails('schooling-systems')">
                                        <h3 class="text-xl font-semibold mb-1">📘 Schooling & Systems</h3>
                                        <p class="text-sm text-gray-500 dark:text-gray-400">March–May 2026<i class="fas fa-chevron-down indicator"></i></p>
                                    </div>
                                </div>
                                <div class="timeline-dot future gsap-reveal-scale" data-delay="0.1"><i class="fas fa-book-reader"></i></div>
                                <div class="md:w-1/2 md:pl-8">
                                    <div class="timeline-content future gsap-reveal" data-delay="0.2">
                                         <p class="mb-4 italic text-sm text-gray-600 dark:text-gray-400">Finalizing education & US admin...</p>
                                         <div class="timeline-details" id="details-schooling-systems"><ul>
                                            <li class="future-task"><i class="fas fa-check-circle"></i>Confirm school enrollment</li>
                                            <li class="future-task"><i class="fas fa-tasks"></i>Finish pending visa paperwork</li>
                                            <li class="future-task"><i class="fas fa-building"></i>Notify U.S. institutions</li>
                                            <li class="future-task"><i class="fas fa-envelope-open-text"></i>Set up forwarding address</li>
                                            <li class="future-task"><i class="fas fa-comments"></i>Practice basic Spanish</li>
                                         </ul></div>
                                        <div class="timeline-notes-container"><div class="notes-display space-y-2 mb-2"></div><button onclick="toggleNoteForm('schooling-systems')" class="btn-secondary btn-sm"><i class="fas fa-plus mr-1"></i> Note</button><form class="add-note-form hidden" onsubmit="addTimelineNote(event, 'schooling-systems')"><textarea class="form-textarea text-sm" rows="2" placeholder="Add a quick note..."></textarea><div class="flex space-x-2 mt-1"><button type="submit" class="btn-primary btn-sm">Save</button><button type="button" onclick="toggleNoteForm('schooling-systems')" class="btn-secondary btn-sm">Cancel</button></div></form></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <!-- Item 6 (Reversed) -->
                        <div class="timeline-item future-item gsap-reveal" data-timeline-id="final-prep">
                            <div class="flex flex-col md:flex-row-reverse items-start md:items-center">
                                <div class="md:w-1/2 md:pl-8 text-center md:text-left mb-4 md:mb-0">
                                    <div class="timeline-header" onclick="toggleTimelineDetails('final-prep')">
                                        <h3 class="text-xl font-semibold mb-1">🗓️ Final Prep</h3>
                                        <p class="text-sm text-gray-500 dark:text-gray-400">June 2026<i class="fas fa-chevron-down indicator"></i></p>
                                    </div>
                                </div>
                                <div class="timeline-dot future gsap-reveal-scale" data-delay="0.1"><i class="fas fa-calendar-check"></i></div>
                                <div class="md:w-1/2 md:pr-8">
                                    <div class="timeline-content future gsap-reveal" data-delay="0.2">
                                        <p class="mb-4 italic text-sm text-gray-600 dark:text-gray-400">Packing, goodbyes, final checks...</p>
                                         <div class="timeline-details" id="details-final-prep"><ul>
                                             <li class="future-task"><i class="fas fa-car-side"></i>Sell car, final pack, goodbye party</li>
                                             <li class="future-task"><i class="fas fa-phone-slash"></i>Cancel U.S. subscriptions</li>
                                             <li class="future-task"><i class="fas fa-plane-up"></i>Confirm flight/accommodations</li>
                                             <li class="future-task"><i class="fas fa-copy"></i>Gather & copy final docs</li>
                                         </ul></div>
                                        <div class="timeline-notes-container"><div class="notes-display space-y-2 mb-2"></div><button onclick="toggleNoteForm('final-prep')" class="btn-secondary btn-sm"><i class="fas fa-plus mr-1"></i> Note</button><form class="add-note-form hidden" onsubmit="addTimelineNote(event, 'final-prep')"><textarea class="form-textarea text-sm" rows="2" placeholder="Add a quick note..."></textarea><div class="flex space-x-2 mt-1"><button type="submit" class="btn-primary btn-sm">Save</button><button type="button" onclick="toggleNoteForm('final-prep')" class="btn-secondary btn-sm">Cancel</button></div></form></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <!-- Item 7: THE MOVE -->
                        <div class="timeline-item gsap-reveal" data-timeline-id="move-to-spain">
                            <div class="flex flex-col md:flex-row items-start md:items-center">
                                <div class="md:w-1/2 md:pr-8 text-center md:text-right mb-4 md:mb-0">
                                    <div class="timeline-header" onclick="toggleTimelineDetails('move-to-spain')">
                                        <h3 class="text-xl font-semibold text-accent-600 dark:text-accent-400 mb-1">✈️ Move to Spain!</h3>
                                        <p class="text-sm font-bold text-gray-600 dark:text-gray-300" id="move-date-display">July 2026<i class="fas fa-chevron-down indicator"></i></p>
                                    </div>
                                </div>
                                <div class="timeline-dot final gsap-reveal-scale" data-delay="0.1"><i class="fas fa-flag"></i></div>
                                <div class="md:w-1/2 md:pl-8">
                                    <div class="timeline-content final gsap-reveal" data-delay="0.2">
                                        <p class="mb-4 font-semibold">The adventure begins! ¡Hola Valencia! 🇪🇸❤️</p>
                                         <div class="timeline-details" id="details-move-to-spain"><ul>
                                             <li class="future-task"><i class="fas fa-plane-arrival"></i>Fly to Valencia (VLC)</li>
                                             <li class="future-task"><i class="fas fa-map-pin"></i>Get Empadronamiento</li>
                                             <li class="future-task"><i class="fas fa-id-card"></i>Start TIE process</li>
                                             <li class="future-task"><i class="fas fa-door-open"></i>Settle into new home!</li>
                                         </ul></div>
                                        <div class="timeline-notes-container"><div class="notes-display space-y-2 mb-2"></div><button onclick="toggleNoteForm('move-to-spain')" class="btn-secondary btn-sm"><i class="fas fa-plus mr-1"></i> Note</button><form class="add-note-form hidden" onsubmit="addTimelineNote(event, 'move-to-spain')"><textarea class="form-textarea text-sm" rows="2" placeholder="First impressions, important numbers..."></textarea><div class="flex space-x-2 mt-1"><button type="submit" class="btn-primary btn-sm">Save</button><button type="button" onclick="toggleNoteForm('move-to-spain')" class="btn-secondary btn-sm">Cancel</button></div></form></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div> <!-- End Timeline Items Container -->
                </div> <!-- End Timeline Wrapper -->
            </div> <!-- End Max-width container -->
        </section> <!-- End Timeline Section -->

        <!-- Weather Section -->
        <section id="weather" class="py-20 bg-gradient-to-b from-gray-100 to-gray-200 dark:from-gray-900 dark:to-gray-800 overflow-hidden">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <h2 class="text-3xl md:text-4xl font-bold text-center mb-12 gsap-reveal">Valencia Weather Forecast</h2>
                <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 gap-6 text-center" data-gsap-stagger>
                    <!-- Placeholder Weather Cards -->
                    <div class="weather-card card p-6 transform transition-transform duration-300 hover:scale-105">
                        <div class="text-lg font-semibold mb-2">Today</div>
                        <i class="fas fa-sun text-6xl text-yellow-500 my-4"></i>
                        <div class="text-4xl font-bold">28°C</div>
                        <div class="text-sm text-gray-600 dark:text-gray-400 mt-1">Sunny</div>
                        <div class="text-xs text-gray-500 dark:text-gray-500 mt-3">Feels like 30°C</div>
                    </div>
                    <div class="weather-card card p-6 transform transition-transform duration-300 hover:scale-105">
                        <div class="text-lg font-semibold mb-2">Tomorrow</div>
                        <i class="fas fa-cloud-sun text-6xl text-sky-400 my-4"></i>
                        <div class="text-4xl font-bold">26°C</div>
                        <div class="text-sm text-gray-600 dark:text-gray-400 mt-1">Partly Cloudy</div>
                        <div class="text-xs text-gray-500 dark:text-gray-500 mt-3">Wind: 15 km/h NE</div>
                    </div>
                    <div class="weather-card card p-6 transform transition-transform duration-300 hover:scale-105">
                        <div class="text-lg font-semibold mb-2">Thursday</div>
                        <i class="fas fa-cloud text-6xl text-gray-500 my-4"></i>
                        <div class="text-4xl font-bold">24°C</div>
                        <div class="text-sm text-gray-600 dark:text-gray-400 mt-1">Cloudy</div>
                        <div class="text-xs text-gray-500 dark:text-gray-500 mt-3">Humidity: 65%</div>
                    </div>
                    <div class="weather-card card p-6 transform transition-transform duration-300 hover:scale-105">
                        <div class="text-lg font-semibold mb-2">Friday</div>
                        <i class="fas fa-cloud-showers-heavy text-6xl text-blue-400 my-4"></i>
                        <div class="text-4xl font-bold">23°C</div>
                        <div class="text-sm text-gray-600 dark:text-gray-400 mt-1">Chance of Showers</div>
                        <div class="text-xs text-gray-500 dark:text-gray-500 mt-3">Precip: 40%</div>
                    </div>
                </div> <!-- End Weather Grid -->
                <p class="text-center text-xs text-gray-500 dark:text-gray-400 mt-8 gsap-reveal-fade">Weather data is illustrative. Integrate a real weather API for live updates.</p>
            </div>
        </section> <!-- End Weather Section -->

        <!-- International Schools Section (Carousel, populated by JS) -->
        <section id="schools" class="py-20 bg-white dark:bg-gray-800 overflow-hidden">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <h2 class="text-3xl md:text-4xl font-bold text-center mb-12 gsap-reveal">Exploring International Schools</h2>
                <div id="international-schools-splide" class="splide gsap-reveal" aria-label="International Schools Carousel">
                    <div class="splide__track">
                        <ul class="splide__list">
                             <!-- Slides will be populated here by JS function renderInternationalSchools() -->
                            <li class="splide__slide p-2"> <div class="h-full card items-center justify-center text-gray-400"><i class="fas fa-spinner fa-spin text-2xl"></i> Loading Schools...</div> </li>
                        </ul>
                    </div>
                </div> <!-- End Splide -->
            </div> <!-- End Container -->
        </section> <!-- End International Schools Section -->

        <!-- *** Generic Detail Modal (Populated by JS) *** -->
        <div id="detail-modal" class="modal" onclick="closeDetailModal(event)" tabindex="-1" role="dialog" aria-modal="true" aria-labelledby="modal-title">
            <div class="modal-content" onclick="event.stopPropagation()">
                <button class="modal-close" onclick="closeDetailModal()" aria-label="Close details">×</button>

                <!-- Visual (Optional) -->
                <img id="modal-image" src="" alt="" class="modal-image hidden bg-gray-200 dark:bg-gray-700" />

                 <!-- Header -->
                <h3 id="modal-title" class="text-2xl font-bold mb-4 border-b pb-3 dark:border-gray-600">Details</h3>

                 <!-- Main Body -->
                <div id="modal-body" class="modal-body">
                    <!-- Basic Info (Populated Dynamically) -->
                    <div class="detail-item"><dt id="modal-info-label1"></dt> <dd id="modal-info-value1"></dd></div>
                    <div class="detail-item"><dt id="modal-info-label2"></dt> <dd id="modal-info-value2"></dd></div>
                    <div class="detail-item"><dt id="modal-info-label3"></dt> <dd id="modal-info-value3"></dd></div>

                    <!-- Description -->
                    <div class="pt-4">
                        <strong class="font-semibold text-gray-800 dark:text-gray-100 block mb-1">Description:</strong>
                        <p id="modal-description" class="text-gray-600 dark:text-gray-300"></p>
                    </div>

                    <!-- Features/Key Points (Optional, uses unordered list) -->
                    <div id="modal-features-container" class="pt-4 hidden"> <!-- Hidden by default -->
                        <strong class="font-semibold text-gray-800 dark:text-gray-100 block mb-1">Key Features:</strong>
                        <ul id="modal-features-list" class="list-disc list-inside space-y-1 pl-2 text-gray-600 dark:text-gray-300"></ul>
                    </div>
                </div>

                <!-- Actions -->
                 <div class="modal-actions">
                    <a id="modal-website-link" href="#" target="_blank" rel="noopener noreferrer" class="btn-primary hidden">
                        Visit Website <i class="fas fa-external-link-alt ml-1 text-xs"></i>
                    </a>
                     <button onclick="closeDetailModal()" class="btn-secondary">Close</button>
                </div>
            </div>
        </div> <!-- End Detail Modal -->

        <!-- Public Schools Section -->
        <section id="public-schools" class="py-20 bg-gray-100 dark:bg-gray-900 overflow-hidden">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <h2 class="text-3xl md:text-4xl font-bold text-center mb-6 gsap-reveal">Public & Concertado Schools</h2>
                <p class="text-lg text-center text-gray-600 dark:text-gray-400 mb-12 max-w-3xl mx-auto gsap-reveal" data-delay="0.1">Exploring local options, including semi-private (Concertado) schools (Ratings are illustrative).</p>
                <!-- Grid for Public Schools with Stagger Animation -->
                <div id="public-school-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8" data-gsap-stagger>
                    <!-- Cards populated by renderPublicSchools() JS -->
                     <div class="text-center text-gray-500 dark:text-gray-400 md:col-span-3 py-10">
                         <i class="fas fa-spinner fa-spin text-3xl mb-4"></i>
                         <p>Loading school information...</p>
                     </div>
                </div>
            </div>
        </section> <!-- End Public Schools Section -->

        <!-- Combined Planning Section -->
        <section id="planning" class="py-24 bg-white dark:bg-gray-800 overflow-hidden">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <h2 class="text-3xl md:text-4xl font-bold text-center mb-16 gsap-reveal">Planning Central</h2>
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-8" data-gsap-stagger>

                    <!-- Budget Tracker Column -->
                    <div id="budget" class="card p-6 flex flex-col">
                        <h3 class="text-2xl font-semibold mb-6 flex items-center"><i class="fas fa-chart-pie mr-3 text-primary-500"></i>Budget Tracker</h3>
                        <div class="mb-6 flex-shrink-0">
                            <canvas id="budgetChart" class="max-h-60 mx-auto"></canvas>
                            <p class="text-center text-sm mt-3 text-gray-600 dark:text-gray-400">Total Spent: <strong id="total-spent" class="text-lg text-gray-800 dark:text-gray-200">€0.00</strong></p>
                        </div>
                        <form id="budget-form" class="space-y-4 mb-6 flex-shrink-0">
                             <div class="grid grid-cols-2 gap-4">
                                 <div><label for="budget-amount">Amount (€)</label><input type="number" id="budget-amount" class="form-input" min="0.01" step="0.01" required placeholder="e.g. 55.75"></div>
                                 <div><label for="budget-category">Category</label><select id="budget-category" class="form-select"><option value="housing">Housing</option><option value="food">Food/Groceries</option><option value="transport">Transport</option><option value="utilities">Utilities</option><option value="leisure">Leisure</option><option value="fees">Fees/Admin</option><option value="shopping">Shopping</option><option value="kids">Kids</option><option value="misc">Misc</option></select></div>
                             </div>
                             <div><label for="budget-description">Description</label><input type="text" id="budget-description" class="form-input" required placeholder="e.g. Weekly Mercadona trip"></div>
                             <div><label for="budget-date">Date</label><input type="date" id="budget-date" class="form-input" value=""></div> <!-- Value set by JS -->
                            <button type="submit" class="btn-primary w-full"><i class="fas fa-plus mr-2 text-xs"></i>Add Expense</button>
                        </form>
                         <h4 class="text-lg font-semibold mb-3 mt-auto pt-4 border-t dark:border-gray-700 flex-shrink-0">Recent Expenses</h4>
                         <div class="space-y-2 flex-grow overflow-y-auto max-h-72 pr-2 thin-scrollbar" id="budget-transactions">
                             <p class="text-center text-sm text-gray-500 dark:text-gray-400 py-6">No expenses added yet.</p>
                         </div>
                    </div>

                    <!-- Todo List Column -->
                     <div id="todo" class="card p-6 flex flex-col">
                        <h3 class="text-2xl font-semibold mb-6 flex items-center"><i class="fas fa-list-check mr-3 text-accent-500"></i>To-Do List</h3>
                        <form id="todo-form" class="space-y-4 mb-6 flex-shrink-0">
                             <div><label for="todo-task">New Task</label><input type="text" id="todo-task" class="form-input" required placeholder="e.g. Research NIE process"></div>
                             <div class="grid grid-cols-2 gap-4">
                                 <div><label for="todo-date">Due Date (Optional)</label><input type="date" id="todo-date" class="form-input"></div>
                                 <div><label for="todo-priority">Priority</label><select id="todo-priority" class="form-select"><option value="low">Low</option><option value="medium" selected>Medium</option><option value="high">High</option></select></div>
                             </div>
                            <button type="submit" class="btn-accent w-full"><i class="fas fa-plus mr-2 text-xs"></i>Add Task</button>
                        </form>
                         <div class="space-y-3 flex-grow overflow-y-auto max-h-[30rem] pr-2 thin-scrollbar" id="todo-list">
                            <p class="text-center text-sm text-gray-500 dark:text-gray-400 py-6">Your task list is clear!</p>
                        </div>
                    </div>

                    <!-- Journal Column -->
                    <div id="journal" class="card p-6 flex flex-col">
                         <h3 class="text-2xl font-semibold mb-6 flex items-center"><i class="fas fa-book-open mr-3 text-green-500"></i>Journey Journal</h3>
                        <form id="journal-form" class="space-y-4 mb-6 flex-shrink-0">
                             <div><label for="journal-title">Entry Title</label><input type="text" id="journal-title" class="form-input" required placeholder="e.g. First Spanish Lesson!"></div>
                             <div><label for="journal-content">Thoughts / Notes</label><textarea id="journal-content" rows="5" class="form-textarea" required placeholder="How are things going?..."></textarea></div>
                            <div><label for="journal-mood">Mood</label><select id="journal-mood" class="form-select"><option value="excited">😊 Excited</option><option value="happy">😄 Happy</option><option value="neutral">😐 Neutral</option><option value="anxious">😟 Anxious/Worried</option><option value="stressed">😫 Stressed</option><option value="thoughtful">🤔 Thoughtful/Planning</option><option value="celebrating">🎉 Celebrating</option></select></div>
                             <button type="submit" class="btn-primary w-full bg-green-600 hover:bg-green-700 focus:ring-green-500"><i class="fas fa-feather-alt mr-2 text-xs"></i>Save Journal Entry</button>
                        </form>
                         <div class="space-y-4 flex-grow overflow-y-auto max-h-[30rem] pr-2 thin-scrollbar" id="journal-entries">
                            <p class="text-center text-sm text-gray-500 dark:text-gray-400 py-6">No journal entries yet.</p>
                         </div>
                    </div>
                </div> <!-- End Grid -->
            </div> <!-- End Container -->
        </section> <!-- End Planning Section -->

        <!-- More Tools Section -->
        <section id="more-tools" class="py-20 bg-gray-100 dark:bg-gray-900 overflow-hidden">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                 <h2 class="text-3xl md:text-4xl font-bold text-center mb-12 gsap-reveal">More Tools & Fun Stuff</h2>
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">

                     <!-- Heat Map Card -->
                     <div id="heatmap" class="card p-6 lg:col-span-2 gsap-reveal">
                        <h3 class="text-2xl font-semibold mb-4 flex items-center"><i class="fas fa-map-marked-alt mr-3 text-red-500"></i>Neighborhood Heat Map</h3>
                        <p class="text-sm text-gray-600 dark:text-gray-400 mb-5">Density of schools and points of interest (Illustrative Data - centered on Valencia).</p>
                        <div id="heatmap-container">
                             <div class="flex items-center justify-center h-full text-gray-500">Map loading...</div>
                        </div>
                        <div class="flex justify-center space-x-4 text-xs mt-4 text-gray-600 dark:text-gray-400">
                           <span><span class="inline-block w-3 h-3 rounded-full bg-red-500 mr-1"></span>High Density</span>
                           <span><span class="inline-block w-3 h-3 rounded-full bg-lime-500 mr-1"></span>Medium Density</span>
                           <span><span class="inline-block w-3 h-3 rounded-full bg-blue-500 mr-1"></span>Low Density</span>
                       </div>
                     </div>

                    <!-- Bucket List Card -->
                     <div id="bucket-list" class="card p-6 flex flex-col gsap-reveal">
                        <h3 class="text-2xl font-semibold mb-6 flex items-center"><i class="fas fa-stream mr-3 text-purple-500"></i>Valencia Bucket List</h3>
                        <form id="bucket-form" class="space-y-4 mb-6 flex-shrink-0">
                            <div><label for="bucket-item">New Bucket List Item</label><input type="text" id="bucket-item" class="form-input" required placeholder="e.g. Visit City of Arts & Sciences"></div>
                            <div class="grid grid-cols-2 gap-4">
                                <div><label for="bucket-category">Category</label><select id="bucket-category" class="form-select"><option value="food">🍽️ Food</option><option value="culture">🏛️ Culture/History</option><option value="adventure">🚴 Adventure</option><option value="daytrip">🚗 Day Trip</option><option value="sightseeing">📍 Sights</option><option value="event">🎉 Event</option><option value="learning">📚 Learning</option><option value="relaxation">🏖️ Relax</option></select></div>
                                <div><label for="bucket-date">Target Month (Opt)</label><input type="month" id="bucket-date" class="form-input"></div>
                            </div>
                            <button type="submit" class="btn-primary w-full bg-purple-600 hover:bg-purple-700 focus:ring-purple-500"><i class="fas fa-plus mr-2 text-xs"></i>Add to List</button>
                        </form>
                        <div class="space-y-3 flex-grow overflow-y-auto max-h-96 pr-2 thin-scrollbar" id="bucket-list-items">
                             <p class="text-center text-sm text-gray-500 dark:text-gray-400 py-6">What's on your Valencia wish list?</p>
                        </div>
                    </div>

                    <!-- Resources Card (Items now open modal via title button) -->
                    <div id="resources" class="card p-6 flex flex-col gsap-reveal">
                        <h3 class="text-2xl font-semibold mb-6 flex items-center"><i class="fas fa-link mr-3 text-teal-500"></i>Helpful Resources</h3>
                        <form id="resource-form" class="space-y-4 mb-6 flex-shrink-0">
                            <div><label for="resource-title">Link Title</label><input type="text" id="resource-title" class="form-input" required placeholder="e.g. Official Empadronamiento Guide"></div>
                            <div><label for="resource-url">URL</label><input type="url" id="resource-url" class="form-input" required placeholder="https://..."></div>
                            <div><label for="resource-category">Category</label><select id="resource-category" class="form-select"><option value="visa">🛂 Visa/NIE</option><option value="housing">🏠 Housing</option><option value="education">🎓 Education</option><option value="health">❤️ Health</option><option value="transport">🚗 Transport</option><option value="finance">💰 Finance/Tax</option><option value="language">🗣️ Language</option><option value="expat">👥 Expat Life</option><option value="official">🏛️ Official</option><option value="blog">✍️ Blog/Info</option><option value="other">🔗 Other</option></select></div>
                             <div><label for="resource-description">Short Description (Opt.)</label><textarea id="resource-description" rows="2" class="form-textarea" placeholder="What is this link about?"></textarea></div>
                             <button type="submit" class="btn-primary w-full bg-teal-600 hover:bg-teal-700 focus:ring-teal-500"><i class="fas fa-plus mr-2 text-xs"></i>Add Link</button>
                        </form>
                        <div class="space-y-4 flex-grow overflow-y-auto max-h-96 pr-2 thin-scrollbar" id="resource-list">
                            <p class="text-center text-sm text-gray-500 dark:text-gray-400 py-6">No resources added yet.</p>
                            <!-- Resource cards rendered by updateResources() JS -->
                        </div>
                    </div>


                    <!-- Guestbook Card -->
                    <div id="guestbook" class="card p-6 lg:col-span-2 gsap-reveal">
                         <h3 class="text-2xl font-semibold mb-6 flex items-center"><i class="fas fa-comments mr-3 text-pink-500"></i>Guestbook</h3>
                        <p class="text-sm text-gray-600 dark:text-gray-400 mb-6">Leave us a message or words of encouragement!</p>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
                             <form id="guestbook-form" class="space-y-4 md:col-span-1">
                                 <div><label for="guest-name">Your Name</label><input type="text" id="guest-name" class="form-input" required></div>
                                 <div><label for="guest-message">Your Message</label><textarea id="guest-message" rows="5" class="form-textarea" required placeholder="Write your message here..."></textarea></div>
                                 <button type="submit" class="btn-primary w-full bg-pink-600 hover:bg-pink-700 focus:ring-pink-500"><i class="fas fa-paper-plane mr-2 text-xs"></i>Send Message</button>
                             </form>
                             <div class="space-y-4 max-h-[30rem] overflow-y-auto pr-2 md:col-span-2 border-t md:border-t-0 md:border-l border-gray-200 dark:border-gray-700 pt-6 md:pt-0 md:pl-6 thin-scrollbar" id="guestbook-entries">
                                <p class="text-center text-sm text-gray-500 dark:text-gray-400 py-6">No messages yet. Be the first!</p>
                             </div>
                         </div>
                    </div>
                </div> <!-- End Grid -->
            </div> <!-- End Container -->
        </section> <!-- End More Tools Section -->

    </main> <!-- End Main Content -->

    <!-- Footer -->
    <footer class="bg-gray-200 dark:bg-gray-800 text-gray-600 dark:text-gray-400 py-10 mt-16 border-t dark:border-gray-700/50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 text-center">
            <p class="text-sm">© <span id="current-year"></span> Our Valencia Adventure. All rights reserved.</p>
            <p class="text-xs mt-2">Crafted with ❤️, fueled by ☕ and 🇪🇸 excitement!</p>
             <!-- Optional: Add links back to top or social -->
            <div class="mt-4">
                <a href="#home" class="text-xs text-primary-600 dark:text-primary-400 hover:underline">Back to Top</a>
            </div>
        </div>
    </footer>

    <!-- Core & Plugin Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/@splidejs/splide@4.1.4/dist/js/splide.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.heat@0.2.0/dist/leaflet-heat.js"></script>
    <!-- GSAP loaded in <head> -->

    <!-- Main Application Script -->
    <script>
        // --- Config & Constants ---
        const MOVE_DATE_STRING = '2026-07-01T00:00:00'; // Target Move Date
        const MOVE_DATE = new Date(MOVE_DATE_STRING);
        const VALENCIA_COORDS = [39.4699, -0.3763];
        const LOADER_DURATION = 1800; // ms for loader fade
        const STORAGE_KEY_PREFIX = 'valenciaJourney_';
        const DATA_VERSION = 'v3.8'; // Incremented version for accessibility/UX fixes
        const STORAGE_KEY = `${STORAGE_KEY_PREFIX}${DATA_VERSION}`;

        // --- DOM Elements Cache ---
        const $ = (selector) => document.querySelector(selector);
        const $$ = (selector) => document.querySelectorAll(selector);
        const $modal = $('#detail-modal'); // Cache modal element

        // --- State Variables ---
        let appState = {
            budgetEntries: [], todos: [], journalEntries: [], trackedApartments: [],
            timelineNotes: {}, bucketList: [], resources: [], guestbookEntries: [],
        };
        let heatMap; // Leaflet map instance
        let budgetChartInstance; // Chart.js instance
        let internationalSplide; // Splide instance reference

        // --- Data Definitions ---
        const internationalSchools = [
            { id: 'intl1', name: 'American School of Valencia', type: 'International', location: 'Puzol', rating: '4.8/5', description: 'Provides an American curriculum leading to the American High School Diploma. Offers the International Baccalaureate (IB) Diploma Programme as well. For ages 2-18.', features: ['American Curriculum', 'IB Diploma Option', 'Ages 2-18', 'Extensive Campus', 'Bus Service'], website: 'https://www.asvalencia.org/en/', image: 'https://images.unsplash.com/photo-1580582932707-520aed937b7b?ixlib=rb-4.0.3&auto=format&fit=crop&w=774&q=80'},
            { id: 'intl2', name: 'British School of Valencia', type: 'International', location: 'Central Valencia', rating: '4.7/5', description: 'Follows the British National Curriculum, preparing students for IGCSE and A-Level examinations. Caters to students aged 2-18.', features: ['British Curriculum', 'IGCSE / A-Levels', 'Ages 2-18', 'City Center Location'], website: 'https://bsvalencia.com/en/', image: 'https://images.unsplash.com/photo-1594608661623-aa0bd3a69d98?ixlib=rb-4.0.3&auto=format&fit=crop&w=774&q=80' },
            { id: 'intl3', name: 'Caxton College', type: 'International', location: 'Puzol / Sagunto', rating: '4.6/5', description: 'A well-established British school offering the full British curriculum from early years through to A-Levels. Known for strong academics and facilities. Ages 1-18.', features: ['British Curriculum', 'Ages 1-18', 'Boarding Available', 'Wide range of subjects'], website: 'https://www.caxtoncollege.com/en/', image: 'https://images.unsplash.com/photo-1517486808906-6ca8b3f04846?ixlib=rb-4.0.3&auto=format&fit=crop&w=774&q=80'},
            { id: 'intl4', name: 'Lycée Français de Valence', type: 'International', location: 'Paterna', rating: '4.5/5', description: 'Follows the French national education system from Maternelle (preschool) through to Terminale (final year, leading to the Baccalauréat).', features: ['French Curriculum', 'Baccalauréat', 'Trilingual options', 'Part of AEFE network'], website: 'https://lfvalencia.org/', image: 'https://images.unsplash.com/photo-1497633762265-9d179a990aa6?ixlib=rb-4.0.3&auto=format&fit=crop&w=873&q=80' },
             { id: 'intl5', name: 'Global Valencia', type: 'International', location: 'Near Valencia', rating: '4.4/5', description: 'Offers the International Baccalaureate (IB) programmes (PYP, MYP, DP) providing a globally recognized education framework.', features: ['IB Curriculum (PYP, MYP, DP)', 'Inquiry-based Learning', 'Global Perspective'], website: '#', image: 'https://images.unsplash.com/photo-1607499457689-3fd1ac3ffc5d?ixlib=rb-4.0.3&auto=format&fit=crop&w=870&q=80' }, // Sample - Add real data
        ];

        const defaultPublicSchools = [
            { id: 'ps1', name: 'CEIP Alejandra Soler', type: 'Public', location: 'Russafa', rating: '9.1/10', description: 'Well-regarded public primary school in a popular neighborhood.', features: ['Infantil', 'Primaria', 'Good facilities (Illustrative)'], website: '#', image: 'https://images.unsplash.com/photo-1541339907198-e08756dedf3f?ixlib=rb-4.0.3&auto=format&fit=crop&w=870&q=80' },
            { id: 'ps2', name: 'IES Lluís Vives', type: 'Public', location: 'Central', rating: '8.8/10', description: 'Historic public secondary school (Instituto) near Estació del Nord.', features: ['ESO', 'Bachillerato', 'Strong academic focus (Illustrative)'], website: '#', image: 'https://images.unsplash.com/photo-1591123120675-6f7f1aae4f8b?ixlib=rb-4.0.3&auto=format&fit=crop&w=774&q=80' },
            { id: 'ps3', name: 'Colegio El Pilar', type: 'Concertado', location: 'Eixample', rating: '9.3/10', description: 'Popular semi-private school known for its educational project.', features: ['Infantil', 'Primaria', 'ESO', 'Bachillerato', 'Religious affiliation'], website: '#', image: 'https://images.unsplash.com/photo-1562774053-701939374585?ixlib=rb-4.0.3&auto=format&fit=crop&w=841&q=80' },
            { id: 'ps4', name: 'Colegio Jesús-María', type: 'Concertado', location: 'Extramurs', rating: '8.9/10', description: 'Another well-established Concertado option.', features: ['All levels', 'Focus on values (Illustrative)'], website: '#', image: 'https://images.unsplash.com/photo-1577896851231-70f144b4ecd3?ixlib=rb-4.0.3&auto=format&fit=crop&w=870&q=80'},
            { id: 'ps5', name: 'CEIP Explorador Andrés', type: 'Public', location: 'Patraix', rating: '8.5/10', description: 'Primary school serving the Patraix area.', features: ['Infantil', 'Primaria'], website: '#', image: 'https://images.unsplash.com/photo-1588075592465-5f4fd106a54f?ixlib=rb-4.0.3&auto=format&fit=crop&w=870&q=80'},
            { id: 'ps6', name: 'IES Benlliure', type: 'Public', location: 'Benimaclet', rating: '8.6/10', description: 'Secondary school in the Benimaclet neighborhood.', features: ['ESO', 'Bachillerato'], website: '#', image: 'https://images.unsplash.com/photo-1610484826911-08c3c4cf64d6?ixlib=rb-4.0.3&auto=format&fit=crop&w=870&q=80'},
        ];

         const schoolHeatData = [[39.475, -0.370, 0.7], [39.465, -0.378, 0.8], [39.480, -0.350, 0.6], [39.471, -0.365, 0.9], [39.468, -0.385, 0.5], [39.479, -0.390, 0.7]];
         const poiHeatData = [[39.470, -0.376, 0.9], [39.474, -0.377, 0.8], [39.455, -0.350, 0.7], [39.478, -0.340, 0.6]];

         const defaultResources = [
            { id: Date.now()+1, title: "Idealista (Spain Property Portal)", url: "https://www.idealista.com/en/", category: "housing", description: "Major portal for rentals and sales in Spain." },
            { id: Date.now()+2, title: "Fotocasa (Property Portal)", url: "https://www.fotocasa.es/en/", category: "housing", description: "Another large Spanish property site." },
            { id: Date.now()+3, title: "Spain Expat Forum (Example)", url: "https://www.expatforum.com/forums/spain-expat-forum/", category: "expat", description: "Community forum for expats in Spain." },
            { id: Date.now()+4, title: "Valencia City Hall (Ayuntamiento)", url: "https://www.valencia.es/", category: "official", description: "Official city website (info often in Spanish/Valencian)." },
        ];

        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            console.log("Valencia Adventure Enhanced - DOM Loaded");
            initializeBaseUI();
            initializeTheme();
            loadData(); // Load data before rendering components that use it
            initializeComponents(); // Calls rendering functions
            initializeAnimations();
            setupEventListeners(); // Add event listeners AFTER elements are created/rendered
            hideLoader();
        });

        function initializeBaseUI() {
            $('#current-year').textContent = new Date().getFullYear();
            if ($('#move-date-display')) $('#move-date-display').textContent = MOVE_DATE.toLocaleDateString('en-US', { year: 'numeric', month: 'long' });
            const budgetDateInput = $('#budget-date');
            if (budgetDateInput) { try { budgetDateInput.valueAsDate = new Date(); } catch(e){ console.warn("Could not set budget date", e); budgetDateInput.value = new Date().toISOString().split('T')[0]; } }
        }

        function initializeTheme() {
             const storedTheme = localStorage.getItem('theme');
             const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
             if (storedTheme === 'dark' || (!storedTheme && prefersDark)) {
                 document.documentElement.classList.add('dark');
             } else {
                 document.documentElement.classList.remove('dark');
             }
             updateThemeIcons();
        }

        function initializeComponents() {
            console.log("Initializing components...");
            renderInternationalSchools(); // Render Intl Schools *before* initializing Splide
             if (typeof Splide !== 'undefined' && $('#international-schools-splide')) {
                 initializeSplide();
             } else if ($('#international-schools-splide')) {
                 console.warn("Splide library or container not ready for Intl Schools.");
             }

            if (typeof L !== 'undefined' && $('#heatmap-container') && !heatMap) {
                 initializeHeatMap();
            } else if ($('#heatmap-container')) {
                 console.warn("Leaflet or container not ready, or map already exists.");
            }

            renderPublicSchools();
            updateBudgetUI();
            updateTodoList();
            updateJournalEntries();
            updateApartmentTable();
            renderAllTimelineNotes();
            updateBucketList();
            updateResources();
            updateGuestbook();

            updateCountdown();
            setInterval(updateCountdown, 1000);
        }

        // --- School Rendering (MODIFIED TO ADD onclick) ---
        function renderInternationalSchools() {
             const splideList = $('#international-schools-splide .splide__list');
             if (!splideList) return console.error("Splide list for international schools not found!");

            if (!internationalSchools || internationalSchools.length === 0) {
                splideList.innerHTML = '<li class="splide__slide p-2"><div class="card h-full p-6 text-center text-gray-500">No International School data found.</div></li>';
                return;
             }

             splideList.innerHTML = internationalSchools.map((school) => `
                 <li class="splide__slide p-2">
                     <div class="school-card card h-full flex flex-col" onclick="openDetailModal('international', '${school.id}')">
                         <div class="relative overflow-hidden h-48">
                             <img src="${school.image}" alt="${school.name}" class="w-full h-full object-cover card-image-zoom bg-gray-200 dark:bg-gray-700">
                         </div>
                         <div class="p-6 flex-grow flex flex-col">
                             <h3 class="text-lg font-semibold mb-1 line-clamp-2">${school.name}</h3>
                             <p class="text-gray-600 dark:text-gray-400 mb-3 text-sm flex-grow line-clamp-3">${school.description || ''}</p>
                             <div class="flex items-center justify-between text-xs mt-auto pt-3 border-t dark:border-gray-700">
                                 <span class="text-yellow-500 font-medium"><i class="fas fa-star mr-1"></i> ${school.rating || 'N/A'}</span>
                                 <span class="text-primary-500 font-medium">Details <i class="fas fa-info-circle ml-1"></i></span>
                             </div>
                         </div>
                     </div>
                 </li>
             `).join('');

            // If Splide instance exists, refresh it
            if (internationalSplide) {
                 try { internationalSplide.refresh(); } catch(e) { console.warn("Error refreshing Splide:", e); }
             }
        }

        function renderPublicSchools() { // MODIFIED TO ADD onclick
             const gridContainer = $('#public-school-grid');
             if (!gridContainer) return;

             if (!defaultPublicSchools || defaultPublicSchools.length === 0) {
                 gridContainer.innerHTML = `<p class="text-center text-sm text-gray-500 dark:text-gray-400 md:col-span-3 py-10">No public/concertado school data available.</p>`;
                 return;
             }

             // Note: card reveal is handled by parent having data-gsap-stagger
             gridContainer.innerHTML = defaultPublicSchools.map((school) => `
                <div class="public-school-card card flex flex-col text-sm" onclick="openDetailModal('public', '${school.id}')">
                    <div class="relative overflow-hidden h-40">
                        <img src="${school.image || 'https://via.placeholder.com/400x200.png?text=School'}" alt="${school.name}" class="w-full h-full object-cover card-image-zoom bg-gray-200 dark:bg-gray-700">
                    </div>
                    <div class="p-5 flex-grow flex flex-col">
                        <h3 class="font-semibold text-base mb-1">${school.name}</h3>
                        <p class="text-xs text-gray-500 dark:text-gray-400 mb-1">${school.type} - ${school.location}</p>
                        <p class="text-yellow-500 text-sm mb-3 font-semibold"><i class="fas fa-star text-xs"></i> ${school.rating} <span class="text-gray-400 text-xs font-normal">(Illust.)</span></p>
                        <p class="text-xs text-gray-600 dark:text-gray-300 mb-4 flex-grow line-clamp-2">${school.description}</p>
                        <div class="text-primary-500 font-medium text-xs mt-auto pt-2 border-t dark:border-gray-600 text-center">
                            View Details <i class="fas fa-info-circle ml-1"></i>
                        </div>
                    </div>
                 </div>
            `).join('');
        }

        function initializeAnimations() {
             console.log("Initializing GSAP animations...");
             if (typeof gsap === 'undefined' || typeof ScrollTrigger === 'undefined') {
                 console.error("GSAP or ScrollTrigger not loaded!");
                 // Fallback: Make elements visible without animation
                 $$('.gsap-reveal, .gsap-reveal-fade, .gsap-reveal-scale, [data-gsap-stagger] > *, .card').forEach(el => { el.style.opacity = '1'; el.style.transform = 'none'; });
                 return;
             }
             gsap.registerPlugin(ScrollTrigger);

             // Simplified GSAP calls for better readability
             const revealElements = gsap.utils.toArray('.gsap-reveal');
             revealElements.forEach(el => {
                 gsap.fromTo(el, { opacity: 0, y: 30 }, {
                     opacity: 1, y: 0, duration: 0.8, ease: 'power3.out',
                     delay: parseFloat(el.dataset.delay || 0),
                     scrollTrigger: { trigger: el, start: 'top 90%', toggleActions: 'play none none none' }
                 });
             });

             const cards = gsap.utils.toArray('.card');
             cards.forEach(card => {
                 gsap.to(card, {
                     opacity: 1, y: 0, duration: 0.6, ease: 'power2.out',
                     scrollTrigger: { trigger: card, start: 'top 95%', toggleActions: 'play none none none' }
                 });
             });

             const staggerContainers = gsap.utils.toArray('[data-gsap-stagger]');
             staggerContainers.forEach(container => {
                 gsap.fromTo(container.children, { opacity: 0, y: 20 }, {
                     opacity: 1, y: 0, duration: 0.5, ease: 'power2.out', stagger: 0.1,
                     scrollTrigger: { trigger: container, start: 'top 85%', toggleActions: 'play none none none' }
                 });
             });

             const tlLine = $('.timeline-line');
             if (tlLine) {
                 gsap.from(tlLine, {
                     scaleY: 0, transformOrigin: 'top center', duration: 1.5, ease: 'power2.inOut',
                     scrollTrigger: { trigger: '.timeline-wrapper', start: 'top 60%', end: 'bottom 80%', scrub: 1 }
                 });
             }

             // Hero specific animations
             gsap.from("#home h1", { opacity: 0, y: 20, duration: 1, delay: 0.5 });
             gsap.from("#home p", { opacity: 0, y: 20, duration: 1, delay: 0.7 });
             gsap.from("#home .countdown-unit", { opacity: 0, scale: 0.9, duration: 0.5, stagger: 0.1, delay: 1.0 });
             gsap.from("#home .btn-accent", { opacity: 0, y: 10, duration: 0.8, delay: 1.4 });

             console.log("GSAP Initialized.");
        }

        function hideLoader() {
            const loader = $('#loader');
             if (loader && typeof gsap !== 'undefined') {
                 gsap.to(loader, {
                     opacity: 0, duration: 0.5, delay: LOADER_DURATION / 1000,
                     onComplete: () => { loader.style.display = 'none'; }
                 });
             } else if (loader) {
                 // Fallback if GSAP fails
                 setTimeout(() => { loader.style.opacity = '0'; loader.style.display = 'none'; }, LOADER_DURATION);
             }
        }

        // --- Event Listeners Setup (Added Esc key for modal) ---
        function setupEventListeners() {
            $$('#theme-toggle-desktop, #theme-toggle-mobile').forEach(btn => btn?.addEventListener('click', toggleTheme));
            $('#mobile-menu-button')?.addEventListener('click', openMobileMenu);
            $('#mobile-menu-close-button')?.addEventListener('click', closeMobileMenu);
            $('#mobile-menu-overlay')?.addEventListener('click', closeMobileMenu);
            $$('.nav-link, .mobile-nav-link').forEach(anchor => anchor.addEventListener('click', handleNavClick));

            setupScrollSpy();

            handleFormSubmit('budget-form', handleBudgetSubmit);
            handleFormSubmit('todo-form', handleTodoSubmit);
            handleFormSubmit('journal-form', handleJournalSubmit);
            handleFormSubmit('apartment-form', handleApartmentSubmit);
            handleFormSubmit('bucket-form', handleBucketSubmit);
            handleFormSubmit('resource-form', handleResourceSubmit);
            handleFormSubmit('guestbook-form', handleGuestbookSubmit);

            // Add Esc key listener for modal closing
            document.addEventListener('keydown', (event) => {
                if (event.key === 'Escape' && $modal && $modal.classList.contains('open')) {
                    closeDetailModal();
                }
            });
        }

        // --- Navigation & Scroll Spy ---
        function handleNavClick(e) {
             const href = this.getAttribute('href');
             if (!href || !href.startsWith('#')) return;
             e.preventDefault();
             const targetId = href.substring(1);
             const targetElement = document.getElementById(targetId);
             if (!targetElement) return;
             const navHeight = $('nav')?.offsetHeight || 64;
             const headerOffset = navHeight + 20; // Extra space above target
             const elementPosition = targetElement.getBoundingClientRect().top;
             const offsetPosition = elementPosition + window.pageYOffset - headerOffset;
             window.scrollTo({ top: offsetPosition, behavior: 'smooth' });
             setActiveNavLink(href);
             closeMobileMenu();
        }

        function setupScrollSpy() {
             const sections = $$('main section[id]');
             if (sections.length === 0) return;
             const navHeight = $('nav')?.offsetHeight || 64;
             let currentActive = null;

             if (typeof ScrollTrigger !== 'undefined') {
                 ScrollTrigger.create({
                     trigger: "main", start: "top top", end: "bottom bottom",
                     onUpdate: (self) => {
                         let newActive = null;
                         const scrollPos = self.scroll();
                         sections.forEach(section => {
                             const sectionTop = section.offsetTop - navHeight - 50; // Adjusted threshold
                             const sectionBottom = sectionTop + section.offsetHeight;
                             if (scrollPos >= sectionTop && scrollPos < sectionBottom) {
                                 newActive = `#${section.id}`;
                             }
                         });

                         if (scrollPos < sections[0].offsetTop - navHeight - 50) {
                             newActive = `#${sections[0].id}`; // Default to first if above all
                         }

                         if (newActive && newActive !== currentActive) {
                             setActiveNavLink(newActive);
                             currentActive = newActive;
                         } else if (!newActive && scrollPos < 200) { // Handle very top of page
                             setActiveNavLink('#home');
                             currentActive = '#home';
                         }
                     }
                 });

                // Set initial active link based on hash or default to #home
                const initialHash = window.location.hash;
                if (initialHash && $(initialHash)) {
                     setActiveNavLink(initialHash);
                     currentActive = initialHash;
                 } else {
                     setActiveNavLink('#home');
                     currentActive = '#home';
                 }
             } else {
                 console.warn("ScrollTrigger not available for ScrollSpy.");
                 // Fallback: just set initial hash or home
                 const initialHash = window.location.hash;
                 setActiveNavLink((initialHash && $(initialHash)) ? initialHash : '#home');
             }
        }

        function setActiveNavLink(targetHref) {
             $$('.nav-link, .mobile-nav-link').forEach(link => {
                 if (link.getAttribute('href') === targetHref) {
                     link.classList.add('active');
                 } else {
                     link.classList.remove('active');
                 }
             });
        }

        // --- Theme Toggle ---
        function toggleTheme() {
            document.documentElement.classList.toggle('dark');
            const isDark = document.documentElement.classList.contains('dark');
            localStorage.setItem('theme', isDark ? 'dark' : 'light');
            updateThemeIcons();
            // Re-render chart with new theme colors
            if (budgetChartInstance) {
                 budgetChartInstance.destroy();
                 updateBudgetChart();
            }
         }
        function updateThemeIcons() {
            const isDark = document.documentElement.classList.contains('dark');
            const iconClass = isDark ? 'fa-moon' : 'fa-sun';
            $$('#theme-toggle-desktop, #theme-toggle-mobile').forEach(btn => {
                if (btn) {
                    btn.innerHTML = `<i class="fas ${iconClass} text-lg transition-transform duration-200 transform group-hover:scale-110"></i>`;
                }
            });
        }

        // --- Mobile Menu ---
        function openMobileMenu() {
            const menu = $('#mobile-menu'); const overlay = $('#mobile-menu-overlay'); const panel = $('#mobile-menu-panel');
            if (!menu || !overlay || !panel || !menu.classList.contains('hidden')) return;
            menu.classList.remove('hidden');
            document.body.style.overflow = 'hidden';
            // Animate opening
            if (typeof gsap !== 'undefined') {
                gsap.timeline()
                    .to(overlay, { opacity: 1, duration: 0.3, ease: 'power2.inOut' })
                    .to(panel, { x: 0, duration: 0.3, ease: 'power2.out' }, "-=0.2")
                    .fromTo(panel.querySelectorAll('[data-gsap-stagger] > a'),
                            { opacity: 0, x: -20 },
                            { opacity: 1, x: 0, duration: 0.3, stagger: 0.07, delay: 0.1, ease: 'power2.out' } );
            } else { // Fallback
                overlay.style.opacity = '1';
                panel.style.transform = 'translateX(0)';
            }
        }
        function closeMobileMenu() {
             const menu = $('#mobile-menu'); const overlay = $('#mobile-menu-overlay'); const panel = $('#mobile-menu-panel');
             if (!menu || !overlay || !panel || menu.classList.contains('hidden')) return;
             // Animate closing
            if (typeof gsap !== 'undefined') {
                gsap.timeline({ onComplete: () => { menu.classList.add('hidden'); document.body.style.overflow = ''; } })
                    .to(panel, { x: '100%', duration: 0.3, ease: 'power2.in' })
                    .to(overlay, { opacity: 0, duration: 0.3, ease: 'power2.inOut' }, "-=0.2");
            } else { // Fallback
                panel.style.transform = 'translateX(100%)';
                overlay.style.opacity = '0';
                menu.classList.add('hidden');
                document.body.style.overflow = '';
            }
         }

        // --- Countdown ---
        function updateCountdown() {
             const now = new Date();
             const diff = MOVE_DATE - now;
             const els = { d: $('#days'), h: $('#hours'), m: $('#minutes'), s: $('#seconds') };
             if (!Object.values(els).every(el => el !== null)) return; // Ensure all elements exist

             let days = 0, hours = 0, minutes = 0, seconds = 0;
             if (diff > 0) {
                 days = Math.floor(diff / (1000 * 60 * 60 * 24));
                 hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                 minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
                 seconds = Math.floor((diff % (1000 * 60)) / 1000);
             }
             els.d.textContent = String(days).padStart(2, '0');
             els.h.textContent = String(hours).padStart(2, '0');
             els.m.textContent = String(minutes).padStart(2, '0');
             els.s.textContent = String(seconds).padStart(2, '0');
        }

        // --- Splide (International Schools specific) ---
        function initializeSplide() {
            const splideElement = $('#international-schools-splide');
             if (splideElement && typeof Splide !== 'undefined') {
                 try {
                    // Destroy existing instance if it exists before re-initializing
                    if (internationalSplide && internationalSplide.state.is('mounted')) {
                        internationalSplide.destroy(true);
                    }
                    internationalSplide = new Splide(splideElement, {
                        type: 'loop', perPage: 3, perMove: 1, gap: '1.5rem',
                        autoplay: true, interval: 5000, pauseOnHover: true,
                        pagination: true, arrows: true, lazyLoad: 'nearby',
                        breakpoints: {
                            1024: { perPage: 2, gap: '1rem' },
                            768: { perPage: 1, gap: '1rem', arrows: false }
                        }
                    });
                    internationalSplide.mount();
                    console.log("Splide initialized for International Schools.");
                 } catch (e) { console.error("Splide initialization failed:", e); }
             } else { console.warn("Splide container or library not ready for Intl Schools."); }
         }

        // --- Leaflet Heatmap ---
        function initializeHeatMap() {
            const mapContainer = $('#heatmap-container');
            if (!mapContainer) return console.warn("Heatmap container not found.");
            try {
                 heatMap = L.map(mapContainer).setView(VALENCIA_COORDS, 13);
                 L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                     attribution: '&copy; <a href="https://www.openstreetmap.org/copyright" target="_blank" rel="noopener noreferrer">OpenStreetMap</a> contributors',
                     maxZoom: 18, minZoom: 11
                 }).addTo(heatMap);

                const schoolsHeat = L.heatLayer(schoolHeatData, { radius: 25, blur: 15, gradient: {0.4: 'blue', 0.65: 'lime', 1.0: 'red'} });
                const poiHeat = L.heatLayer(poiHeatData, { radius: 20, blur: 10, gradient: {0.4: 'cyan', 0.7: 'yellow', 1.0: 'orange'} });

                const overlayLayers = {
                    "<span class='text-blue-500 font-semibold'><i class='fas fa-school mr-1'></i> Schools</span>": schoolsHeat,
                    "<span class='text-orange-500 font-semibold'><i class='fas fa-star mr-1'></i> POIs</span>": poiHeat
                 };
                L.control.layers({}, overlayLayers, { collapsed: false }).addTo(heatMap);
                schoolsHeat.addTo(heatMap); // Start with schools layer visible

                // Marker for Valencia Center
                L.marker(VALENCIA_COORDS, {
                    icon: L.icon({
                        iconUrl: 'data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>🇪🇸</text></svg>',
                        iconSize: [30, 30], iconAnchor: [15, 30],
                    })
                }).addTo(heatMap).bindPopup("<b>Valencia Center</b><br>(Approx.)").openPopup();

                console.log("Leaflet Heatmap initialized.");
             } catch (e) {
                 console.error("Leaflet initialization failed:", e);
                 mapContainer.innerHTML = "<p class='p-4 text-center text-red-500'>Error loading map.</p>";
             }
        }

        // --- Property Filtering ---
        function filterProperties() {
             const areaFilter = $('#area-filter')?.value;
             const priceFilter = $('#price-filter')?.value;
             const bedsFilter = $('#beds-filter')?.value;
             const propertyCards = $$('.property-card');
             const noResultsElement = $('#no-results');
             let visibleCount = 0;

             if (propertyCards.length === 0) return;

             propertyCards.forEach(card => {
                 const cardArea = card.dataset.area || '';
                 const cardPrice = parseInt(card.dataset.price, 10);
                 const cardBeds = parseInt(card.dataset.beds, 10);
                 let show = true;

                 if (areaFilter && cardArea !== areaFilter) { show = false; }

                 if (priceFilter && !isNaN(cardPrice)) {
                     const maxPrice = parseInt(priceFilter.replace('+', ''), 10);
                     if (priceFilter.includes('+')) { // Handle "2500+" case
                         if (cardPrice < maxPrice) show = false;
                     } else { // Handle "Up to X" cases
                         if (cardPrice > maxPrice) show = false;
                     }
                 }

                 if (bedsFilter && !isNaN(cardBeds)) {
                     const minBeds = parseInt(bedsFilter, 10);
                     if (cardBeds < minBeds) show = false;
                 }

                 if (show) {
                     card.classList.remove('hidden');
                     visibleCount++;
                 } else {
                     card.classList.add('hidden');
                 }
             });

             // Toggle 'No Results' message
             if (noResultsElement) {
                 if (visibleCount === 0) {
                     noResultsElement.style.display = 'block';
                     if(typeof gsap !== 'undefined') gsap.fromTo(noResultsElement, { opacity: 0 }, { opacity: 1, duration: 0.5 });
                 } else {
                    if(typeof gsap !== 'undefined') {
                        gsap.to(noResultsElement, { opacity: 0, duration: 0.3, onComplete: () => noResultsElement.style.display = 'none' });
                    } else {
                        noResultsElement.style.display = 'none';
                    }
                 }
             }
        }

        // --- Generic Form Handling ---
        function handleFormSubmit(formId, handlerFn) {
            const form = $(`#${formId}`);
            if (!form) { console.warn(`Form with ID #${formId} not found.`); return; }

            form.addEventListener('submit', (event) => {
                 event.preventDefault();
                 console.log(`Form submitted: #${formId}`);
                 try {
                     handlerFn(form);
                     form.reset();
                     // Special handling for budget date reset
                     if (formId === 'budget-form') {
                         const budgetDateInput = form.querySelector('#budget-date');
                         if (budgetDateInput) { try { budgetDateInput.valueAsDate = new Date(); } catch(e) { console.warn("Could not reset budget date", e); budgetDateInput.value = new Date().toISOString().split('T')[0]; } }
                     }
                     showFeedback(form, 'Item added!', 'success');
                 } catch (error) {
                     console.error(`Error handling form #${formId}:`, error);
                     showFeedback(form, 'Error submitting data.', 'error');
                 }
             });
        }

        function showFeedback(elementContext, message, type = 'success') {
             const target = elementContext.closest('.card') || elementContext; // Try to find parent card or use the form itself
             if (!target) return;

             let feedbackEl = target.querySelector('.form-feedback');
             if (!feedbackEl) { // Create if doesn't exist
                 feedbackEl = document.createElement('div');
                 feedbackEl.className = 'form-feedback text-xs mt-2 text-center transition-opacity duration-300 opacity-0';
                 // Insert after the submit button if possible
                 const submitButton = target.querySelector('button[type="submit"]');
                 if(submitButton && submitButton.parentNode) {
                    submitButton.parentNode.insertBefore(feedbackEl, submitButton.nextSibling);
                 } else {
                     target.appendChild(feedbackEl); // Fallback: append to target
                 }
             }

             feedbackEl.textContent = message;
             feedbackEl.className = `form-feedback text-xs mt-2 text-center transition-opacity duration-300 ${type === 'success' ? 'text-green-500' : 'text-red-500'} opacity-0`;

             // Animation using GSAP if available
             if(typeof gsap !== 'undefined') {
                 gsap.timeline()
                     .to(feedbackEl, { opacity: 1, duration: 0.3 })
                     .to(feedbackEl, { opacity: 0, duration: 0.3, delay: 1.5 });
             } else { // Simple timeout fallback
                 feedbackEl.style.opacity = '1';
                 setTimeout(() => { feedbackEl.style.opacity = '0'; }, 1800);
             }
        }

        function flashHighlight(element) {
            if (element && typeof gsap !== 'undefined') {
                // Use Tailwind's animation definition
                element.classList.add('highlight-flash');
                // Remove class after animation duration (1s)
                setTimeout(() => {
                    element.classList.remove('highlight-flash');
                }, 1000);
            } else if (element) {
                // Simple fallback
                const originalBg = element.style.backgroundColor;
                element.style.backgroundColor = 'rgba(255, 153, 0, 0.3)'; // Accent color
                setTimeout(() => { element.style.backgroundColor = originalBg; }, 1000);
            }
        }

        // --- Budget Section ---
        function handleBudgetSubmit(form) {
             const amountInput = form.querySelector('#budget-amount');
             const categoryInput = form.querySelector('#budget-category');
             const descriptionInput = form.querySelector('#budget-description');
             const dateInput = form.querySelector('#budget-date');

             const amount = parseFloat(amountInput?.value);
             const category = categoryInput?.value;
             const description = descriptionInput?.value.trim();
             const date = dateInput?.value || new Date().toISOString().split('T')[0]; // Default to today

             if (description && category && !isNaN(amount) && amount > 0) {
                 const newEntry = { id: Date.now(), amount: amount, category: category, description: description, date: date };
                 appState.budgetEntries.push(newEntry);
                 updateBudgetUI();
                 saveData();
             } else {
                 alert("Please fill in Amount, Category, and Description.");
                 throw new Error("Invalid budget input");
             }
        }

        function updateBudgetUI() {
            updateBudgetChart();
            updateBudgetTransactionList();
            updateTotalSpent();
        }

        function updateBudgetChart() {
            const ctx = $('#budgetChart')?.getContext('2d');
            if (!ctx) return;

            // Destroy previous chart instance if it exists
            if (budgetChartInstance) { budgetChartInstance.destroy(); }

            const totalsByCategory = appState.budgetEntries.reduce((totals, entry) => {
                totals[entry.category] = (totals[entry.category] || 0) + entry.amount;
                return totals;
            }, {});

            const labels = Object.keys(totalsByCategory).map(key => key.charAt(0).toUpperCase() + key.slice(1));
            const data = Object.values(totalsByCategory);

            const backgroundColors = ['#0073FF', '#FF9900', '#48A9A6', '#E17F00', '#389996', '#9A6A5C', '#F18F01', '#A05195', '#D45087', '#FF7C43']; // Your palette
            const hoverBackgroundColors = backgroundColors.map(color => `${color}E6`); // Add slight transparency on hover
            const borderColor = document.documentElement.classList.contains('dark') ? '#1F2937' : '#FFFFFF'; // Dark/Light mode border

            try {
                 budgetChartInstance = new Chart(ctx, {
                     type: 'doughnut',
                     data: {
                         labels: data.length > 0 ? labels : ['No Data'],
                         datasets: [{
                             data: data.length > 0 ? data : [1], // Placeholder data if empty
                             backgroundColor: data.length > 0 ? backgroundColors.slice(0, data.length) : ['#E5E7EB'],
                             hoverBackgroundColor: data.length > 0 ? hoverBackgroundColors.slice(0, data.length) : ['#D1D5DB'],
                             borderColor: borderColor,
                             borderWidth: 2,
                         }]
                     },
                     options: {
                         responsive: true,
                         maintainAspectRatio: false,
                         cutout: '70%',
                         plugins: {
                             legend: {
                                 position: 'bottom',
                                 labels: {
                                     color: document.documentElement.classList.contains('dark') ? '#E5E7EB' : '#4B5563', // Theme-aware labels
                                     padding: 15,
                                     usePointStyle: true,
                                 }
                             },
                             tooltip: {
                                 callbacks: {
                                     label: function(context) {
                                         // Handle 'No Data' case
                                         if (!context.dataset.data || context.dataset.data.length === 0 || (context.dataset.data[0] === 1 && context.label === 'No Data')) return ' No expenses yet';
                                         let label = context.label || '';
                                         if (label) { label += ': '; }
                                         if (context.parsed !== null) { label += formatCurrency(context.parsed); }
                                         return label;
                                     }
                                 }
                             }
                         }
                     }
                 });
             } catch (e) {
                 console.error("Chart.js initialization error:", e);
                 // Optionally display an error message in the canvas area
                 ctx.font = "14px sans-serif";
                 ctx.fillStyle = "red";
                 ctx.textAlign = "center";
                 ctx.fillText("Error loading chart", ctx.canvas.width / 2, ctx.canvas.height / 2);
            }
        }

        function updateBudgetTransactionList() {
            const container = $('#budget-transactions');
            if (!container) return;

            const sortedEntries = [...appState.budgetEntries].sort((a, b) => new Date(b.date) - new Date(a.date)); // Sort by date desc

            if (sortedEntries.length === 0) {
                container.innerHTML = `<p class="text-center text-sm text-gray-500 dark:text-gray-400 py-6">No expenses added yet.</p>`;
                return;
            }

            container.innerHTML = sortedEntries.map(entry => `
                 <div class="flex justify-between items-center p-2 bg-gray-50 dark:bg-gray-700/50 rounded shadow-sm text-sm mb-2" data-id="${entry.id}">
                     <div class="mr-2 overflow-hidden flex-grow">
                         <span class="font-medium block truncate" title="${entry.description}">${entry.description}</span>
                         <span class="text-xs text-gray-500 dark:text-gray-400">${entry.category} • ${formatDate(entry.date)}</span>
                     </div>
                     <div class="flex-shrink-0 flex items-center">
                         <span class="font-semibold mr-3">${formatCurrency(entry.amount)}</span>
                         <button onclick="deleteBudgetEntry(${entry.id})" class="btn-icon text-gray-400 hover:text-red-500 focus:outline-none focus:ring-1 focus:ring-red-300 rounded" aria-label="Delete expense">
                            <i class="fas fa-trash-alt text-xs"></i>
                         </button>
                     </div>
                 </div>
            `).join('');
        }

        function deleteBudgetEntry(id) {
             if (confirm('Are you sure you want to delete this expense?')) {
                 const elementToRemove = $(`#budget-transactions [data-id="${id}"]`);
                 const completeDeletion = () => {
                     appState.budgetEntries = appState.budgetEntries.filter(entry => entry.id !== id);
                     updateBudgetUI();
                     saveData();
                     showFeedback($('#budget'), 'Expense deleted.', 'success');
                 };

                 if (elementToRemove && typeof gsap !== 'undefined') {
                     gsap.to(elementToRemove, { opacity: 0, height: 0, margin:0, padding: 0, duration: 0.3, onComplete: completeDeletion });
                 } else { // Fallback if element not found or GSAP fails
                     completeDeletion();
                 }
             }
         }

        function updateTotalSpent() {
             const total = appState.budgetEntries.reduce((sum, entry) => sum + entry.amount, 0);
             const totalElement = $('#total-spent');
             if (totalElement) { totalElement.textContent = formatCurrency(total); }
        }

        // --- Todo List Section ---
        function handleTodoSubmit(form) {
            const taskInput = form.querySelector('#todo-task');
            const dateInput = form.querySelector('#todo-date');
            const priorityInput = form.querySelector('#todo-priority');
            const task = taskInput?.value.trim();
            const date = dateInput?.value || null; // Store as null if empty
            const priority = priorityInput?.value || 'medium';

            if (task) {
                 const newTodo = { id: Date.now(), task: task, date: date, priority: priority, completed: false };
                 appState.todos.push(newTodo);
                 updateTodoList();
                 saveData();
                 taskInput.focus(); // Keep focus on input for quick adding
             } else {
                 alert("Please enter a task description.");
                 throw new Error("Invalid todo input");
             }
        }

        function updateTodoList() {
             const listContainer = $('#todo-list');
             if (!listContainer) return;

             // Sort: Incomplete first, then by priority (high->low), then by date (soonest first)
             const sortedTodos = [...appState.todos].sort((a, b) => {
                 if (a.completed !== b.completed) { return a.completed ? 1 : -1; } // Incomplete first
                 const priorityOrder = { 'high': 0, 'medium': 1, 'low': 2 };
                 if (priorityOrder[a.priority] !== priorityOrder[b.priority]) { return priorityOrder[a.priority] - priorityOrder[b.priority]; } // Priority high->low
                 const dateA = a.date ? new Date(a.date) : Infinity; // Treat null dates as far future
                 const dateB = b.date ? new Date(b.date) : Infinity;
                 if (dateA !== Infinity || dateB !== Infinity) { return dateA - dateB; } // Sort by date asc
                 return 0; // Keep original order if all else equal
             });

             if (sortedTodos.length === 0) {
                 listContainer.innerHTML = `<p class="text-center text-sm text-gray-500 dark:text-gray-400 py-6">Your task list is clear!</p>`;
                 return;
             }

             listContainer.innerHTML = sortedTodos.map(todo => `
                 <div class="flex items-center justify-between p-3 bg-gray-50 dark:bg-gray-700/50 rounded shadow-sm text-sm mb-2 transition-opacity duration-300" data-id="${todo.id}">
                     <div class="flex items-center overflow-hidden mr-2 flex-grow min-w-0">
                         <input type="checkbox" id="todo-${todo.id}" ${todo.completed ? 'checked' : ''} onchange="toggleTodo(${todo.id})"
                                class="mr-3 h-4 w-4 rounded text-primary-600 border-gray-300 dark:border-gray-600 focus:ring-primary-500 flex-shrink-0 cursor-pointer">
                         <label for="todo-${todo.id}" class="cursor-pointer overflow-hidden min-w-0">
                             <span class="font-medium block break-words ${todo.completed ? 'line-through text-gray-400 dark:text-gray-500' : 'text-gray-800 dark:text-gray-100'}">${todo.task}</span>
                             ${todo.date ? `<span class="text-xs text-gray-500 dark:text-gray-400 ${todo.completed ? 'line-through' : ''}">${formatDate(todo.date)}</span>` : ''}
                         </label>
                     </div>
                     <div class="flex items-center flex-shrink-0 ml-2 space-x-2">
                         <span class="px-2 py-0.5 text-xs rounded-full ${getPriorityClasses(todo.priority)} capitalize font-medium">${todo.priority}</span>
                         <button onclick="deleteTodo(${todo.id})" class="btn-icon text-gray-400 hover:text-red-500 focus:outline-none focus:ring-1 focus:ring-red-300 rounded" aria-label="Delete task">
                            <i class="fas fa-trash-alt text-xs"></i>
                         </button>
                     </div>
                 </div>
             `).join('');
         }

        function toggleTodo(id) {
             appState.todos = appState.todos.map(todo =>
                 todo.id === id ? { ...todo, completed: !todo.completed } : todo
             );
             updateTodoList(); // Re-sorts and re-renders
             saveData();
        }

        function deleteTodo(id) {
             if (confirm('Are you sure you want to delete this task?')) {
                 const elementToRemove = $(`#todo-list [data-id="${id}"]`);
                 const completeDeletion = () => {
                     appState.todos = appState.todos.filter(todo => todo.id !== id);
                     updateTodoList();
                     saveData();
                     showFeedback($('#todo'), 'Task deleted.', 'success');
                 };

                 if (elementToRemove && typeof gsap !== 'undefined') {
                     gsap.to(elementToRemove, { opacity: 0, x: 50, duration: 0.3, onComplete: completeDeletion });
                 } else {
                     completeDeletion();
                 }
             }
         }

        function getPriorityClasses(priority) {
            switch(priority) {
                case 'high': return 'bg-red-100 text-red-800 dark:bg-red-900/50 dark:text-red-200';
                case 'medium': return 'bg-yellow-100 text-yellow-800 dark:bg-yellow-900/50 dark:text-yellow-200';
                case 'low': return 'bg-green-100 text-green-800 dark:bg-green-900/50 dark:text-green-200';
                default: return 'bg-gray-100 text-gray-800 dark:bg-gray-600 dark:text-gray-200';
            }
        }

        // --- Journal Section ---
        function handleJournalSubmit(form) {
             const titleInput = form.querySelector('#journal-title');
             const contentInput = form.querySelector('#journal-content');
             const moodInput = form.querySelector('#journal-mood');
             const title = titleInput?.value.trim();
             const content = contentInput?.value.trim();
             const mood = moodInput?.value || 'neutral';
             const date = new Date().toISOString();

             if (title && content) {
                 const newEntry = { id: Date.now(), title: title, content: content, mood: mood, date: date };
                 appState.journalEntries.unshift(newEntry); // Add to the beginning
                 updateJournalEntries();
                 saveData();
             } else {
                 alert("Please enter both a title and content for your journal entry.");
                 throw new Error("Invalid journal input");
             }
         }

        function updateJournalEntries() {
             const container = $('#journal-entries');
             if (!container) return;
             const entries = appState.journalEntries; // Already sorted by date desc due to unshift

             if (entries.length === 0) {
                 container.innerHTML = `<p class="text-center text-sm text-gray-500 dark:text-gray-400 py-6">No journal entries yet.</p>`;
                 return;
             }

             container.innerHTML = entries.map((entry) => `
                 <article class="p-4 bg-gray-50 dark:bg-gray-700/50 rounded-lg shadow-sm relative text-sm mb-4 transition-all duration-300" data-id="${entry.id}">
                     <div class="flex justify-between items-start mb-2">
                         <h4 class="font-semibold text-base text-primary-700 dark:text-primary-300 pr-10 break-words flex-grow">${entry.title}</h4>
                         <span class="text-2xl absolute top-3 right-3" title="${entry.mood}">${getMoodEmoji(entry.mood)}</span>
                     </div>
                     <div class="text-xs text-gray-500 mb-3">${new Date(entry.date).toLocaleString('en-US', { dateStyle: 'medium', timeStyle: 'short' })}</div>
                     <p class="whitespace-pre-wrap break-words text-gray-700 dark:text-gray-300 leading-relaxed">${entry.content}</p>
                     <button onclick="deleteJournalEntry(${entry.id})" class="btn-icon text-gray-400 hover:text-red-500 absolute bottom-2 right-2 focus:outline-none focus:ring-1 focus:ring-red-300 rounded" aria-label="Delete journal entry">
                        <i class="fas fa-trash-alt text-xs"></i>
                     </button>
                 </article>
             `).join('');

             // Animate the newly added entry (first element)
             const newElement = container.querySelector(`[data-id="${entries[0]?.id}"]`);
             if (newElement && typeof gsap !== 'undefined') {
                 gsap.from(newElement, { opacity: 0, y: 20, duration: 0.5, ease: 'power2.out' });
             }
         }

        function deleteJournalEntry(id) {
             if (confirm('Are you sure you want to delete this journal entry?')) {
                 const elementToRemove = $(`#journal-entries [data-id="${id}"]`);
                 const completeDeletion = () => {
                     appState.journalEntries = appState.journalEntries.filter(entry => entry.id !== id);
                     updateJournalEntries();
                     saveData();
                     showFeedback($('#journal'), 'Entry deleted.', 'success');
                 };

                 if (elementToRemove && typeof gsap !== 'undefined') {
                     gsap.to(elementToRemove, { opacity: 0, scale: 0.95, duration: 0.3, onComplete: completeDeletion });
                 } else {
                    completeDeletion();
                 }
             }
         }

        function getMoodEmoji(mood) {
             const emojiMap = { excited: '😊', happy: '😄', neutral: '😐', anxious: '😟', stressed: '😫', thoughtful: '🤔', celebrating: '🎉' };
             return emojiMap[mood] || '📝'; // Default emoji
        }

        // --- Apartment Tracker ---
        function handleApartmentSubmit(form) {
             const locationInput = form.querySelector('#apt-location');
             const sizeInput = form.querySelector('#apt-size');
             const priceInput = form.querySelector('#apt-price');
             const linkInput = form.querySelector('#apt-link');
             const notesInput = form.querySelector('#apt-notes');

             const location = locationInput?.value.trim();
             const size = sizeInput?.value ? parseInt(sizeInput.value, 10) : null;
             const price = priceInput?.value ? parseFloat(priceInput.value) : null;
             const link = linkInput?.value.trim();
             const notes = notesInput?.value.trim();

             // Basic validation
             if (location && price !== null && price > 0) {
                 const newApartment = {
                     id: Date.now(),
                     location: location,
                     size: size,
                     price: price,
                     link: (link && (link.startsWith('http:') || link.startsWith('https://'))) ? link : null, // Basic URL check
                     notes: notes
                 };
                 appState.trackedApartments.push(newApartment);
                 updateApartmentTable();
                 saveData();
             } else {
                 alert("Please provide at least a Location/Reference and a valid Price.");
                 throw new Error("Invalid apartment input");
             }
        }

        function updateApartmentTable() {
             const tableBody = $('#apartment-table-body');
             if (!tableBody) return;

             // Sort by price ascending
             const sortedApartments = [...appState.trackedApartments].sort((a, b) => a.price - b.price);

             if (sortedApartments.length === 0) {
                 tableBody.innerHTML = `<tr><td colspan="6" class="text-center py-4 text-sm text-gray-500 dark:text-gray-400">No apartments tracked yet.</td></tr>`;
                 return;
             }

             tableBody.innerHTML = sortedApartments.map(apt => `
                 <tr data-id="${apt.id}">
                     <td class="py-3 px-4 font-medium text-gray-800 dark:text-gray-100">${apt.location}</td>
                     <td class="py-3 px-4">${formatCurrency(apt.price)}</td>
                     <td class="py-3 px-4">${apt.size ? apt.size + 'm²' : '-'}</td>
                     <td class="py-3 px-4">
                         ${apt.link ? `<a href="${apt.link}" target="_blank" rel="noopener noreferrer" class="text-primary-500 hover:text-primary-700 dark:hover:text-primary-300 transition-colors" title="${apt.link}"><i class="fas fa-external-link-alt"></i></a>` : '-'}
                     </td>
                     <td class="py-3 px-4 text-xs max-w-[180px] truncate" title="${apt.notes}">${apt.notes || '-'}</td>
                     <td class="py-3 px-4">
                         <button onclick="deleteApartment(${apt.id})" class="btn-icon text-red-500 hover:text-red-700 focus:outline-none focus:ring-1 focus:ring-red-300 rounded" aria-label="Delete apartment">
                            <i class="fas fa-trash-alt"></i>
                         </button>
                     </td>
                 </tr>
             `).join('');

             // Highlight the newly added row (last one in the original array before sorting)
             const lastAddedId = appState.trackedApartments[appState.trackedApartments.length - 1]?.id;
             if (lastAddedId) {
                 const newRow = tableBody.querySelector(`tr[data-id="${lastAddedId}"]`);
                 flashHighlight(newRow);
             }
        }

        function deleteApartment(id) {
             if (confirm('Are you sure you want to remove this tracked apartment?')) {
                 const rowToRemove = $(`#apartment-table-body tr[data-id="${id}"]`);
                 const completeDeletion = () => {
                     appState.trackedApartments = appState.trackedApartments.filter(apt => apt.id !== id);
                     updateApartmentTable();
                     saveData();
                     showFeedback($('#apartment-tracker'), 'Apartment removed.', 'success');
                 };

                 if (rowToRemove && typeof gsap !== 'undefined') {
                     gsap.to(rowToRemove, { opacity: 0, height: 0, duration: 0.3, onComplete: completeDeletion });
                 } else {
                     completeDeletion();
                 }
             }
         }

        // --- Timeline Interactions ---
        function toggleTimelineDetails(timelineId) {
            const detailsDiv = $(`#details-${timelineId}`);
            const headerDiv = $(`.timeline-item[data-timeline-id="${timelineId}"] .timeline-header`);
            const indicatorIcon = headerDiv?.querySelector('.indicator');
            if (!detailsDiv || !indicatorIcon) return;

            const isExpanded = detailsDiv.classList.contains('expanded');

            if (typeof gsap !== 'undefined') { // Use GSAP for smoother animation
                 if (isExpanded) {
                     indicatorIcon.classList.remove('rotate-180');
                     gsap.to(detailsDiv.querySelectorAll('li'), { opacity: 0, duration: 0.1 }); // Fade out items first
                     gsap.to(detailsDiv, {
                         height: 0, opacity: 0, paddingTop: 0, paddingBottom: 0, marginTop: 0,
                         duration: 0.4, ease: 'power2.inOut',
                         onComplete: () => detailsDiv.classList.remove('expanded')
                     });
                 } else {
                     indicatorIcon.classList.add('rotate-180');
                     detailsDiv.classList.add('expanded'); // Add class immediately for state
                     gsap.set(detailsDiv, { height: 'auto', opacity: 1, paddingTop: '1rem', paddingBottom: '1rem', marginTop: '1rem' }); // Set to auto height to measure
                     gsap.from(detailsDiv, { height: 0, opacity: 0, paddingTop: 0, paddingBottom: 0, marginTop: 0, duration: 0.5, ease: 'power2.out' });
                     gsap.fromTo(detailsDiv.querySelectorAll('li'),
                         { opacity: 0, y: 10 },
                         { opacity: 1, y: 0, duration: 0.3, stagger: 0.08, delay: 0.2, ease: 'power1.out' }
                     );
                 }
             } else { // Basic fallback without GSAP
                 if (isExpanded) {
                     detailsDiv.classList.remove('expanded');
                     detailsDiv.style.maxHeight = '0px';
                     indicatorIcon.classList.remove('rotate-180');
                 } else {
                     detailsDiv.classList.add('expanded');
                     detailsDiv.style.maxHeight = detailsDiv.scrollHeight + 'px'; // Simple max-height toggle
                     indicatorIcon.classList.add('rotate-180');
                 }
             }
        }

        // --- Timeline Notes ---
        function toggleNoteForm(timelineId) {
            const itemContainer = $(`.timeline-item[data-timeline-id="${timelineId}"]`);
            if (!itemContainer) return;
            const form = itemContainer.querySelector('.add-note-form');
            const button = itemContainer.querySelector('button[onclick^="toggleNoteForm"]');
            if (!form || !button) return;

            const isHidden = form.classList.contains('hidden');
            if (typeof gsap !== 'undefined') {
                if (isHidden) {
                     form.classList.remove('hidden');
                     button.classList.add('hidden');
                     gsap.fromTo(form, { height: 0, opacity: 0, marginTop: 0 },
                                    { height: 'auto', opacity: 1, marginTop: '0.5rem', duration: 0.3, ease: 'power1.out', onComplete: () => form.querySelector('textarea')?.focus() });
                 } else {
                     gsap.to(form, { height: 0, opacity: 0, marginTop: 0, duration: 0.3, ease: 'power1.in',
                                    onComplete: () => { form.classList.add('hidden'); button.classList.remove('hidden'); }});
                 }
            } else { // Fallback
                 if (isHidden) {
                     form.classList.remove('hidden');
                     button.classList.add('hidden');
                     form.querySelector('textarea')?.focus();
                 } else {
                     form.classList.add('hidden');
                     button.classList.remove('hidden');
                 }
            }
        }

        function addTimelineNote(event, timelineId) {
            event.preventDefault();
            const form = event.target;
            const textarea = form.querySelector('textarea');
            const noteText = textarea?.value.trim();

            if (noteText) {
                 if (!appState.timelineNotes[timelineId]) {
                     appState.timelineNotes[timelineId] = [];
                 }
                 const newNote = { id: Date.now(), text: noteText, date: new Date().toISOString() };
                 appState.timelineNotes[timelineId].unshift(newNote); // Add to beginning
                 renderTimelineNotes(timelineId); // Re-render notes for this item
                 saveData();
                 textarea.value = ''; // Clear textarea
                 toggleNoteForm(timelineId); // Close form
             }
        }

        function renderTimelineNotes(timelineId) {
            const itemContainer = $(`.timeline-item[data-timeline-id="${timelineId}"]`);
            if (!itemContainer) return;
            const notesDisplayContainer = itemContainer.querySelector('.notes-display');
            if (!notesDisplayContainer) return;

            const notes = appState.timelineNotes[timelineId] || [];
            notes.sort((a, b) => new Date(b.date) - new Date(a.date)); // Ensure sorted by date desc

            if (notes.length === 0) {
                notesDisplayContainer.innerHTML = ''; // Clear if no notes
                return;
            }

            notesDisplayContainer.innerHTML = notes.map(note => `
                <div class="timeline-note relative p-2.5 bg-white dark:bg-gray-600/80 rounded shadow-sm mb-2 text-xs" data-id="${note.id}" style="opacity: 0;">
                     <p class="text-gray-500 dark:text-gray-300 mb-1 text-[11px]">${new Date(note.date).toLocaleDateString('en-GB', { day: '2-digit', month: 'short', year:'2-digit' })}</p>
                     <p class="whitespace-pre-wrap break-words text-gray-800 dark:text-gray-200 pr-6 leading-snug">${note.text}</p>
                     <button onclick="deleteTimelineNote('${timelineId}', ${note.id})" class="absolute top-1 right-1 btn-icon text-gray-400 hover:text-red-500 focus:outline-none focus:ring-1 focus:ring-red-300 rounded" aria-label="Delete note">
                         <i class="fas fa-times"></i>
                     </button>
                 </div>
             `).join('');

            // Animate the notes fading/sliding in
            if (typeof gsap !== 'undefined') {
                gsap.fromTo(notesDisplayContainer.querySelectorAll('.timeline-note'),
                         { opacity: 0, y: 10 },
                         { opacity: 1, y: 0, duration: 0.4, stagger: 0.1, ease: 'power1.out' }
                );
            } else { // Fallback
                 notesDisplayContainer.querySelectorAll('.timeline-note').forEach(el => el.style.opacity = '1');
            }
        }

        function deleteTimelineNote(timelineId, noteId) {
             if (confirm('Are you sure you want to delete this note?')) {
                 if (appState.timelineNotes[timelineId]) {
                     const noteElement = $(`.timeline-item[data-timeline-id="${timelineId}"] .timeline-note[data-id="${noteId}"]`);
                     const completeDeletion = () => {
                         appState.timelineNotes[timelineId] = appState.timelineNotes[timelineId].filter(note => note.id !== noteId);
                         renderTimelineNotes(timelineId); // Re-render remaining notes
                         saveData();
                     };

                     if (noteElement && typeof gsap !== 'undefined') {
                         gsap.to(noteElement, {opacity: 0, height: 0, margin:0, padding:0, duration: 0.3, onComplete: completeDeletion});
                     } else {
                         completeDeletion();
                     }
                 }
             }
         }

        function renderAllTimelineNotes() {
            Object.keys(appState.timelineNotes).forEach(timelineId => {
                renderTimelineNotes(timelineId);
            });
        }

        // --- Bucket List ---
        function handleBucketSubmit(form) {
            const itemInput = form.querySelector('#bucket-item');
            const categoryInput = form.querySelector('#bucket-category');
            const dateInput = form.querySelector('#bucket-date'); // yyyy-mm format
            const item = itemInput?.value.trim();
            const category = categoryInput?.value || 'sightseeing';
            const date = dateInput?.value || null;

            if (item) {
                 const newItem = { id: Date.now(), item: item, category: category, date: date, completed: false };
                 appState.bucketList.push(newItem);
                 updateBucketList();
                 saveData();
                 itemInput.focus();
             } else {
                 alert("Please enter an item for your bucket list.");
                 throw new Error("Invalid bucket list input");
             }
        }

        function updateBucketList() {
            const listContainer = $('#bucket-list-items');
            if (!listContainer) return;

            // Sort: Incomplete first, then by date (earliest first), then alphabetically
            const sortedList = [...appState.bucketList].sort((a, b) => {
                if (a.completed !== b.completed) { return a.completed ? 1 : -1; } // Incomplete first
                const dateA = a.date ? new Date(a.date + '-01') : Infinity; // Treat null as far future
                const dateB = b.date ? new Date(b.date + '-01') : Infinity;
                if (dateA !== Infinity || dateB !== Infinity) {
                    if(dateA !== dateB) return dateA - dateB; // Sort by date asc
                }
                return a.item.localeCompare(b.item); // Sort alphabetically as tie-breaker
            });

            if (sortedList.length === 0) {
                listContainer.innerHTML = `<p class="text-center text-sm text-gray-500 dark:text-gray-400 py-6">What's on your Valencia wish list?</p>`;
                return;
            }

            listContainer.innerHTML = sortedList.map(item => `
                <div class="flex items-center justify-between p-3 bg-gray-50 dark:bg-gray-700/50 rounded shadow-sm text-sm mb-2 transition-all duration-300" data-id="${item.id}">
                    <div class="flex items-center overflow-hidden mr-2 flex-grow min-w-0">
                        <input type="checkbox" id="bucket-${item.id}" ${item.completed ? 'checked' : ''} onchange="toggleBucketItem(${item.id})"
                               class="mr-3 h-4 w-4 rounded text-primary-600 border-gray-300 dark:border-gray-600 focus:ring-primary-500 flex-shrink-0 cursor-pointer">
                        <label for="bucket-${item.id}" class="cursor-pointer overflow-hidden min-w-0">
                            <span class="font-medium block break-words ${item.completed ? 'line-through text-gray-400 dark:text-gray-500' : 'text-gray-800 dark:text-gray-100'}">${item.item}</span>
                            <span class="text-xs text-gray-500 dark:text-gray-400 ${item.completed ? 'line-through' : ''}">${item.category.split(' ')[0]} ${item.date ? ` • Target: ${formatMonthYear(item.date)}` : ''}</span>
                        </label>
                    </div>
                    <button onclick="deleteBucketItem(${item.id})" class="btn-icon text-gray-400 hover:text-red-500 flex-shrink-0 focus:outline-none focus:ring-1 focus:ring-red-300 rounded" aria-label="Delete bucket list item">
                        <i class="fas fa-trash-alt text-xs"></i>
                    </button>
                </div>
            `).join('');

            // Highlight newly added item
             const lastAddedId = appState.bucketList[appState.bucketList.length - 1]?.id;
             if (lastAddedId) {
                 const newItemElement = listContainer.querySelector(`[data-id="${lastAddedId}"]`);
                 flashHighlight(newItemElement);
             }
        }

        function toggleBucketItem(id) {
            appState.bucketList = appState.bucketList.map(item =>
                item.id === id ? { ...item, completed: !item.completed } : item
            );
            updateBucketList(); // Re-sorts and re-renders
            saveData();
        }

        function deleteBucketItem(id) {
            if (confirm('Are you sure you want to remove this bucket list item?')) {
                const elementToRemove = $(`#bucket-list-items [data-id="${id}"]`);
                const completeDeletion = () => {
                    appState.bucketList = appState.bucketList.filter(item => item.id !== id);
                    updateBucketList();
                    saveData();
                    showFeedback($('#bucket-list'), 'Item removed.', 'success');
                };

                if (elementToRemove && typeof gsap !== 'undefined') {
                    gsap.to(elementToRemove, { opacity: 0, x: 50, duration: 0.3, onComplete: completeDeletion });
                } else {
                    completeDeletion();
                }
            }
        }

        // --- Resources (MODIFIED updateResources for modal click via button)---
        function handleResourceSubmit(form) {
            const titleInput = form.querySelector('#resource-title');
            const urlInput = form.querySelector('#resource-url');
            const categoryInput = form.querySelector('#resource-category');
            const descriptionInput = form.querySelector('#resource-description');
            const title = titleInput?.value.trim();
            const url = urlInput?.value.trim();
            const category = categoryInput?.value || 'other';
            const description = descriptionInput?.value.trim();

            if (title && url && (url.startsWith('http://') || url.startsWith('https://') || url.startsWith('/'))) {
                 const newResource = { id: Date.now(), title: title, url: url, category: category, description: description };
                 appState.resources.push(newResource);
                 updateResources();
                 saveData();
                 titleInput.focus();
             } else {
                 alert("Please enter a valid Title and URL (starting with http://, https://, or /).");
                 throw new Error("Invalid resource input");
             }
        }

        function updateResources() {
            const listContainer = $('#resource-list');
            if (!listContainer) return;

            // Sort by category, then title
            const sortedResources = [...appState.resources].sort((a, b) => {
                const categoryCompare = a.category.localeCompare(b.category);
                if (categoryCompare !== 0) { return categoryCompare; }
                return a.title.localeCompare(b.title, undefined, { sensitivity: 'base' });
            });

             if (sortedResources.length === 0) {
                 listContainer.innerHTML = `<p class="text-center text-sm text-gray-500 dark:text-gray-400 py-6">No resources added yet.</p>`;
                 return;
             }

            listContainer.innerHTML = sortedResources.map(resource => `
                 <div class="p-3.5 bg-gray-50 dark:bg-gray-700/50 rounded-lg shadow-sm relative text-sm mb-3 transition-all duration-300 group" data-id="${resource.id}">
                     <div class="flex justify-between items-start mb-1.5">
                        {/* Make title a button to open modal */}
                        <h4 class="font-semibold flex-grow mr-16">
                            <button type="button" onclick="openDetailModal('resource', ${resource.id})" class="text-left text-primary-600 dark:text-primary-400 hover:underline focus:outline-none focus:ring-1 focus:ring-primary-400 rounded break-words">
                                ${resource.title}
                             </button>
                         </h4>
                         <span class="px-2 py-0.5 text-[11px] rounded-full bg-gray-200 text-gray-700 dark:bg-gray-600 dark:text-gray-200 absolute top-3 right-3 whitespace-nowrap font-medium capitalize">${resource.category.split(' ')[0]}</span>
                    </div>
                     ${resource.description ? `<p class="text-xs text-gray-600 dark:text-gray-300 mb-1 pr-6 leading-snug line-clamp-2">${resource.description}</p>` : ''}
                     {/* Action buttons remain at the bottom */}
                     <div class="absolute bottom-2 right-2 flex space-x-1">
                         <a href="${resource.url}" target="_blank" rel="noopener noreferrer" class="btn-icon text-gray-400 hover:text-primary-500" title="Open link in new tab"> <i class="fas fa-external-link-alt"></i></a>
                         <button onclick="deleteResource(${resource.id})" class="btn-icon text-gray-400 hover:text-red-500 focus:outline-none focus:ring-1 focus:ring-red-300 rounded" aria-label="Delete resource">
                            <i class="fas fa-trash-alt"></i>
                         </button>
                    </div>
                </div>
             `).join('');

             // Highlight newly added resource
             const lastAddedId = appState.resources[appState.resources.length - 1]?.id;
             if(lastAddedId) {
                const newElement = listContainer.querySelector(`[data-id="${lastAddedId}"]`);
                flashHighlight(newElement);
             }
         }

         function deleteResource(id) {
             if (confirm('Are you sure you want to delete this resource link?')) {
                 const elementToRemove = $(`#resource-list [data-id="${id}"]`);
                 const completeDeletion = () => {
                     appState.resources = appState.resources.filter(res => res.id !== id);
                     updateResources();
                     saveData();
                     showFeedback($('#resources'), 'Resource deleted.', 'success');
                 };

                 if (elementToRemove && typeof gsap !== 'undefined') {
                     gsap.to(elementToRemove, { opacity: 0, scale: 0.95, duration: 0.3, onComplete: completeDeletion });
                 } else {
                     completeDeletion();
                 }
             }
         }

        // --- Modal Functions (UPDATED for accessibility and different types) ---
        function openDetailModal(type, id) {
            let item;
             // Find the item from the correct data source
             if (type === 'international') { item = internationalSchools.find(school => school.id === id); }
             else if (type === 'public') { item = defaultPublicSchools.find(school => school.id === id); }
             else if (type === 'resource') { item = appState.resources.find(res => res.id === parseInt(id)); }

            if (!item || !$modal) return console.error(`Item not found for type '${type}' with id '${id}' or modal missing.`);

            // --- Cache Modal Elements ---
            const $modalContent = $modal.querySelector('.modal-content');
            const $modalImage = $('#modal-image');
            const $modalTitle = $('#modal-title');
            const $modalInfoLabel1 = $('#modal-info-label1'); const $modalInfoValue1 = $('#modal-info-value1');
            const $modalInfoLabel2 = $('#modal-info-label2'); const $modalInfoValue2 = $('#modal-info-value2');
            const $modalInfoLabel3 = $('#modal-info-label3'); const $modalInfoValue3 = $('#modal-info-value3');
            const $modalDescription = $('#modal-description');
            const $modalFeaturesContainer = $('#modal-features-container');
            const $modalFeaturesList = $('#modal-features-list');
            const $modalWebsiteLink = $('#modal-website-link');

            // --- Reset Previous State ---
            $modalImage.classList.add('hidden'); $modalImage.src = ''; $modalImage.alt = '';
            $modalFeaturesContainer.classList.add('hidden'); $modalFeaturesList.innerHTML = '';
            $modalWebsiteLink.classList.add('hidden'); $modalWebsiteLink.href = '#';
            $modalInfoLabel1.textContent = ''; $modalInfoValue1.textContent = '';
            $modalInfoLabel2.textContent = ''; $modalInfoValue2.textContent = '';
            $modalInfoLabel3.textContent = ''; $modalInfoValue3.innerHTML = '';
            $modalInfoValue3.classList.remove('rating-value'); // Remove specific class

            // --- Populate Modal Content ---
            $modalTitle.textContent = item.name || item.title; // Use 'name' for schools, 'title' for resources

            // Set Image (only for schools)
             if ((type === 'international' || type === 'public') && item.image) {
                $modalImage.src = item.image;
                $modalImage.alt = item.name;
                $modalImage.classList.remove('hidden');
             }

            // Set Body Info based on type
             if (type === 'international' || type === 'public') {
                 $modalInfoLabel1.textContent = 'Type:'; $modalInfoValue1.textContent = item.type;
                 $modalInfoLabel2.textContent = 'Location:'; $modalInfoValue2.textContent = item.location;
                 if(item.rating) {
                    $modalInfoLabel3.textContent = 'Rating:';
                    $modalInfoValue3.innerHTML = `<i class="fas fa-star mr-1 text-xs"></i> ${item.rating} ${item.rating.includes('/5') ? '' : ' (Illust.)'}`;
                    $modalInfoValue3.classList.add('rating-value'); // Add class for styling
                 }
             } else if (type === 'resource') {
                 $modalInfoLabel1.textContent = 'Category:'; $modalInfoValue1.textContent = item.category;
                 $modalInfoLabel2.textContent = 'URL:';
                 $modalInfoValue2.textContent = item.url;
                 // No rating for resources
                 $modalInfoLabel3.textContent = ''; $modalInfoValue3.innerHTML = '';
             }

            // Set Description
             $modalDescription.textContent = item.description || 'No description provided.';

            // Set Features (only for schools, expect array)
             if ((type === 'international' || type === 'public') && Array.isArray(item.features) && item.features.length > 0) {
                 $modalFeaturesList.innerHTML = item.features.map(f => `<li>${f}</li>`).join('');
                 $modalFeaturesContainer.classList.remove('hidden');
            }

             // Set Website Link
             const websiteUrl = item.website || item.url; // Use 'website' for schools, 'url' for resources
             if (websiteUrl && websiteUrl !== '#') {
                $modalWebsiteLink.href = websiteUrl;
                $modalWebsiteLink.classList.remove('hidden');
                 // Update link text based on type
                if (type === 'resource') {
                    $modalWebsiteLink.innerHTML = 'Visit Link <i class="fas fa-external-link-alt ml-1 text-xs"></i>';
                } else {
                    $modalWebsiteLink.innerHTML = 'Visit Website <i class="fas fa-external-link-alt ml-1 text-xs"></i>';
                }
            }

            // --- Open Modal ---
             $modal.classList.add('open');
            document.body.style.overflow = 'hidden'; // Prevent background scroll
            $modalContent.scrollTop = 0; // Scroll modal content to top
            $modal.focus(); // Focus the modal container for accessibility
         }

         function closeDetailModal(event) {
             // Allow closing by clicking backdrop OR the close button OR Esc key (handled by setupEventListeners)
             if (!$modal || !$modal.classList.contains('open')) return;

             // Check if the click was directly on the modal backdrop (event.target === $modal)
             // or if the click was on the close button or an element inside it
             if (!event || event.target === $modal || event.target.closest('.modal-close')) {
                 if (event && event.stopPropagation) event.stopPropagation(); // Prevent propagation if needed

                 $modal.classList.remove('open');
                 // Restore background scroll after animation (match CSS duration)
                 setTimeout(() => {
                    document.body.style.overflow = '';
                 }, 300);
            }
         }

        // --- Utilities ---
        function formatCurrency(amount) {
            try {
                return new Intl.NumberFormat('es-ES', { style: 'currency', currency: 'EUR' }).format(amount);
            } catch (e) {
                // Fallback for older browsers or errors
                return amount.toFixed(2) + ' €';
            }
        }
        function formatDate(dateString) {
            if (!dateString) return '';
            try {
                // Add time to avoid timezone issues with YYYY-MM-DD
                const date = new Date(dateString + 'T00:00:00');
                if (isNaN(date.getTime())) throw new Error("Invalid date");
                return date.toLocaleDateString('en-GB', { day: '2-digit', month: 'short', year: 'numeric' }); // dd Mmm yyyy
            } catch (e) {
                console.warn("Error formatting date:", dateString, e);
                return dateString; // Return original string if formatting fails
            }
        }
        function formatMonthYear(yyyyMM) { // Input format: YYYY-MM
            if (!yyyyMM) return '';
            try {
                const [year, month] = yyyyMM.split('-');
                const date = new Date(year, month - 1); // Month is 0-indexed
                return date.toLocaleDateString('en-US', { year: 'numeric', month: 'short' }); // Mmm YYYY
            } catch (e) {
                return yyyyMM; // Fallback
            }
        }

        // --- Guestbook ---
        function handleGuestbookSubmit(form) {
             const nameInput = form.querySelector('#guest-name');
             const messageInput = form.querySelector('#guest-message');
             const name = nameInput?.value.trim();
             const message = messageInput?.value.trim();
             const date = new Date().toISOString();

             if (name && message) {
                 const newEntry = { id: Date.now(), name: name, message: message, date: date };
                 appState.guestbookEntries.unshift(newEntry); // Add to beginning
                 updateGuestbook();
                 saveData();
                 alert('Thank you for your message!');
             } else {
                 alert('Please enter both your name and a message.');
                 throw new Error("Invalid guestbook input");
             }
        }

        function updateGuestbook() {
             const container = $('#guestbook-entries');
             if (!container) return;
             const entries = appState.guestbookEntries; // Already sorted by date desc

             if (entries.length === 0) {
                 container.innerHTML = `<p class="text-center text-sm text-gray-500 dark:text-gray-400 py-6">No messages yet. Be the first!</p>`;
                 return;
             }

             container.innerHTML = entries.map(entry => `
                 <div class="p-4 bg-gray-50 dark:bg-gray-700/50 rounded-lg shadow-sm text-sm mb-4" data-id="${entry.id}">
                     <div class="flex justify-between items-start mb-2">
                         <h4 class="font-semibold text-gray-800 dark:text-gray-100 break-words">${entry.name}</h4>
                         <span class="text-xs text-gray-500 dark:text-gray-400 flex-shrink-0 ml-2 whitespace-nowrap">${new Date(entry.date).toLocaleDateString('en-GB', { day:'numeric', month:'short', year:'numeric' })}</span>
                     </div>
                     <p class="whitespace-pre-wrap break-words text-gray-700 dark:text-gray-300 leading-relaxed">${entry.message}</p>
                 </div>
             `).join('');

            // Animate the newly added entry
             const newElement = container.querySelector(`[data-id="${entries[0]?.id}"]`);
             if (newElement && typeof gsap !== 'undefined') {
                 gsap.from(newElement, { opacity: 0, y: 20, duration: 0.5, ease: 'power2.out' });
             }
        }

        // --- Local Storage ---
        function saveData() {
             try {
                 localStorage.setItem(STORAGE_KEY, JSON.stringify(appState));
                 // console.log("Data saved.") // Uncomment for debugging
             } catch (e) {
                 console.error("Error saving data to localStorage:", e);
                 // Maybe provide user feedback if critical
                 alert("Warning: Could not save your data. It might be lost when you close the page.")
             }
        }

        function loadData() {
             try {
                 const savedDataString = localStorage.getItem(STORAGE_KEY);
                 if (savedDataString) {
                     const loadedState = JSON.parse(savedDataString);
                     if (loadedState && typeof loadedState === 'object') {
                         // Safely merge loaded data with defaults, ensuring arrays/objects are correct types
                         appState.budgetEntries = Array.isArray(loadedState.budgetEntries) ? loadedState.budgetEntries : [];
                         appState.todos = Array.isArray(loadedState.todos) ? loadedState.todos : [];
                         appState.journalEntries = Array.isArray(loadedState.journalEntries) ? loadedState.journalEntries : [];
                         appState.trackedApartments = Array.isArray(loadedState.trackedApartments) ? loadedState.trackedApartments : [];
                         appState.timelineNotes = (typeof loadedState.timelineNotes === 'object' && loadedState.timelineNotes !== null) ? loadedState.timelineNotes : {};
                         appState.bucketList = Array.isArray(loadedState.bucketList) ? loadedState.bucketList : [];
                         // *** UPDATED Resource Loading: Use saved only if it's a non-empty array, otherwise use defaults ***
                         appState.resources = (Array.isArray(loadedState.resources) && loadedState.resources.length > 0) ? loadedState.resources : [...defaultResources];
                         appState.guestbookEntries = Array.isArray(loadedState.guestbookEntries) ? loadedState.guestbookEntries : [];

                        console.log("Data loaded successfully from localStorage.");
                    } else {
                        // Data in storage is invalid format
                        throw new Error("Loaded data from localStorage is not a valid object.");
                    }
                } else {
                    // No saved data found for this key/version, use defaults
                     appState.resources = [...defaultResources]; // Ensure defaults are loaded if nothing is in storage
                     console.log("No saved data found, using default resources.");
                 }
             } catch (e) {
                 console.error("Error loading or parsing data from localStorage:", e);
                 // Critical error loading - reset state and use defaults to prevent crashes
                 appState = {
                    budgetEntries: [], todos: [], journalEntries: [], trackedApartments: [],
                    timelineNotes: {}, bucketList: [], resources: [...defaultResources], guestbookEntries: []
                 };
                alert("Could not load saved data due to an error. Starting with a fresh state.");
             }
         }

    </script>
</body>
</html>
